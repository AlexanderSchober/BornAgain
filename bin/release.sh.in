#!/bin/bash 

# !!! This script does not finished and tested yet! Please don't run it!

# version of the BornAgain. Will be set autimatically by CMake
        
BA_VERSION_MAJOR=@BornAgain_VERSION_MAJOR@
BA_VERSION_MINOR=@BornAgain_VERSION_MINOR@
BA_VERSION_PATCH=@BornAgain_VERSION_PATCH@
BA_VERSION=$BA_VERSION_MAJOR.$BA_VERSION_MINOR.$BA_VERSION_PATCH

# 1. Making release branch
# Where is your git source tree? 
# Set the path here or CMake will set it for you.
CMAKE_SOURCE_DIR="@CMAKE_SOURCE_DIR@"
GIT_SOURCE_TREE="$CMAKE_SOURCE_DIR/.git"

# Where do you want to put binaries? 
# Set the path here or CMake will set it for you.
CMAKE_BUILD_DIR="@CMAKE_BINARY_DIR@"

# make a release branch
RELEASE_BRANCH_NAME="release-$BA_VERSION"
git --git-dir=$GIT_SOURCE_TREE checkout -b $RELEASE_BRANCH_NAME develop

# build BornAgain with App and UserManual
# cd $CMAKE_BUILD_DIR
cmake -D BORNAGAIN_APP=ON -D BORNAGAIN_MAN=ON --build $CMAKE_BUILD_DIR $CMAKE_SOURCE_DIR && make

# Update picture number of lines of code
# [TODO:] change qqq.png to lines_of_code.png after testing
python $CMAKE_SOURCE_DIR/dev-tools/git-utils/cl_lines_of_code.py -i $GIT_SOURCE_TREE -o $CMAKE_SOURCE_DIR/dev-tools/git-utils/qqq.png

# Measure the performance
$CMAKE_BUILD_DIR/bin/App --performance --batch --threads=-1

# Modify file dev-tools/log/perf_history.txt
echo "Please, enter a comment for perf-history.txt [Press Enter if empty]"
read PERF_COMMENT
if [ "PERF_COMMENT" != "" ]; then
	echo $PERF_COMMENT >> $CMAKE_SOURCE_DIR/dev-tools/log/perf-history.txt
fi
cat perf_history.txt >> $CMAKE_SOURCE_DIR/dev-tools/log/perf-history.txt

# [FUTURE TASK] Modify CHANGELOG (SQL query to get data from the redmine roadmap database)
PATH_TO_CHANGELOG="$CMAKE_SOURCE_DIR/CHANGELOG"
# upload CHANGELOG
#PATH_TO_UPLOAD_CHANGELOG="apps@apps.jcns.fz-juelich.de:/www/apps/src/BornAgain/"
#scp $PATH_TO_CHANGELOG $PATH_TO_UPLOAD_CHANGELOG

# Update UserManual
# [TODO:] remove old manual
# upload new manual
# PATH_TO_MANUAL=$CMAKE_BUILD_DIR/
 
      
echo $RELEASE_BRANCH_NAME    
