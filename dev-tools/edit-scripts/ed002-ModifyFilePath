#!/usr/bin/env python3

# Automatic editing of collection of source files.
# Does not provide backup files:
# to be safe, work on fresh git commit, and use 'git stash' to revert.

# ed2: insert inc or src in @file command

import glob, re, argparse
from string import Template

def edit( fn ):
    if re.search( r"pypp\.(cpp|h|hpp)$", fn ):
        return # don't reformat automatically generated file
    print( "File " + fn )
    m = re.search( r"(\w+)/(src|inc)/(\w+)\.(cpp|h)$", fn )
    if not m:
        raise Exception( "could not split file name " + fn )
    subdir = m.group(1)
    base = m.group(3)
    ext = m.group(4)
    if   ext=='cpp':
        dir = 'src'
    elif ext=='h':
        dir = 'inc'

    fd = open( fn, 'r' )
    s = fd.read()
    fd.close

    p = re.compile( "(\/\/\! \@file\s+\w+\/)(\w+)\.(h|cpp)" )
    s = p.sub( r'\1'+dir+"/"+r'\2.\3', s, 1 )

    fd = open( fn, 'w' )
    fd.write( s )
    fd.close

## Main

parser = argparse.ArgumentParser()
parser.add_argument( "subdirs" )
dirs = parser.parse_args().subdirs.split()

for d in dirs:
    print( "Directory " + d )

    for fn in glob.glob( d + '/inc/*.h' ) + glob.glob( d + '/src/*.cpp' ):
        edit( fn )
