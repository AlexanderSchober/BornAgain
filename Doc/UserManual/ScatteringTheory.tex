%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   BornAgain User Manual
%%
%%   homepage:   http://www.bornagainproject.org
%%
%%   copyright:  Forschungszentrum Jülich GmbH 2015
%%
%%   license:    Creative Commons CC-BY-SA
%%   
%%   authors:    Scientific Computing Group at MLZ Garching
%%               C. Durniak, M. Ganeva, G. Pospelov, W. Van Herck, J. Wuttke
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\let\v=\vect
\def\r{\v{r}}
\def\k{\v{k}}
\def\rD{\r_{\rm D}}
\def\kD{\k_{\rm D}}

\chapter{Foundations of GISAS}  \SecLabel{ScatTheory}

\newcommand{\nz}{\overline{n}}

In this chapter,
we present the theory
of grazing-incidence small-angle scattering (GISAS)
that underlies the simulation algorithm implemented in BornAgain.
Our exposition is largely self contained,
except for some textbook references.
For alternative introductions to GISAS theory,
see e.~g.\ the review \cite{ReLL09} or ....

In sections \ref{Swave}--\ref{Sdwba},
we develop the theory for the simplest case,
namely for neutrons with no polarization-dependent interactions.
The electromagnetic theory of X-ray scattering
is presented in Sect.~\ref{Sxray},
polarized neutrons are discussed in Sect.~\ref{Snpol}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Neutron wave propagation}\label{Swave}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{Wave propagation!neutrons}
\index{Neutrons!wave propagation}

We start from the Schrödinger equation
\begin{equation}\label{ESchrodi}
  i\hbar\partial_t \psi(\r,t)
  = \left\{-\frac{\hbar^2}{2m}\Nabla^2+V(\r)\right\} \psi(\r,t).
\end{equation}
We will only consider monochromatic waves with given frequency~$\omega$.
By assuming a time-independent potential $V(\r)$,
we have excluded inelastic scattering.
In consequence, we have a stationary wave function
\begin{equation}\label{Estationarywave}
  \psi(\r,t) = \psi(\r){\rm e}^{-i\omega t}.
\end{equation}
\index{Sign convention}
\index{Quantum-mechanical sign convention}
\index{Crystallographic sign convention}
The minus sign in the exponent of the phase factor
is an inevitable consequence of the standard form of the Schrödinger equation,
and is therefore called the \textit{quantum-mechanical sign convention}.
The opposite choice of a phase factor ${\rm e}^{+i\omega t}$ is 
called the \textit{crystallographic sign convention},
and is used in much of the literature on X-ray scattering,
including some important texts on GISAXS (e.~g.\ \cite{ReLL09}).
Since BornAgain is covering both X-ray and neutron scattering,
the obvious choice for us was to adopt the quantum-mechanical convention
throughout the source code as well as in this manual.

Inserting (\ref{Estationarywave}) in (\ref{ESchrodi}),
we obtain the stationary Schrödinger equation
\begin{equation}\label{EstatSchrodi}
  \left\{-\frac{\hbar^2}{2m}\Nabla^2+V(\r)-\hbar\omega\right\} \psi(\r,t) = 0.
\end{equation}
\index{Potential|see Optical potential}
\index{Optical potential!nuclear}
\index{Nuclear optical potential}
\index{Microscopic optical potential}
The \textit{nuclear} (or \textit{microscopic})
\textit{optical potential} $V(\r)$,
in a somewhat ``naive conception'' \cite[p.~7]{Sea89},
consists of a sum of delta functions,
representing Fermi's ``pseudopotential''.
The superposition of the incident wave with the scattered waves
originating from each illuminated nucleus
results in \textit{coherent forward scattering},%
\index{Coherent forward scattering}
in line with Huygens' principle.%
\index{Huygens' principle}

Another form of coherent scattering is \textit{Bragg scattering}.%
\index{Bragg scattering!by atomic lattices}
However, Bragg scattering by atomic lattices
is large-angle, not small-angle scattering;
it occurs on wavenumbers outside the range covered in GISAS experiments.
At most, it is taken into account as a loss channel.

Therefore,
we can neglect the atomic structure of $V(\r)$,
and perform some \textit{coarse graining} to
arrive at a \textit{continuum approximation}.%
\index{Continuum approximation}
This is 
similar to the passage from
the microscopic to the macroscopic Maxwell equations.
The details are intricate \cite{Sea89,Lax51}.
As a result \cite[eq.~2.8.32]{Sea89},
the stationary Schrödinger equation can be rewritten as
\begin{equation}\label{EmacrSchrodi}
  \left\{-\frac{\hbar^2}{2m}\Nabla^2+v(\r)-\hbar\omega\right\} \Psi(\r,t) = 0,
\end{equation}
where $\Psi$ now stands for the coherent superposition of
incident and forward scattered states,
and $v(\r)$ is the \textit{macroscopic optical potential},%
\index{macroscopic optical potential}
which is weak, and slowly varying compared to atomic length scales.
It can be rewritten in a number of ways,
especially in terms of a
\textit{bound scattering length density}%
\index{Bound scattering length density}
\index{Scattering length density}
$\rho_s(\r)$ \cite[eq.\ 2.8.37]{Sea89},
\begin{equation}
  v(\r)=\frac{2\pi \hbar^2}{m}\rho_s(\r),  
\end{equation}
or of a \textit{refractive index}~$n(\r)$%
\index{Refractive index}
\index{Index of refraction|see Refractive index}
with
\begin{equation}\label{EnRefrIndx}
  n(\r)^2=1-\frac{4\pi}{K^2}\rho_s(\r) = 1 -\frac{2m}{\hbar^2 K^2}v(\r).
\end{equation}
In the latter expression,
we introduced the \textit{vacuum wavenumber}~$K$,
which is connected with the frequency~$\omega$ through the
\textit{dispersion relation}
\begin{equation}
  \frac{\hbar^2 K^2}{2m} = \hbar\omega.
\end{equation}
Since we only consider stationary solutions~(\ref{Estationarywave}),
$\omega$ will not appear any further in our derivations.
Instead, we use~$K$ as the given parameter that characterizes the
incoming radiation.
In terms of $K$ and $n$,
the macroscopic Schrödinger equation (\ref{EmacrSchrodi})
can be rewritten as
\begin{equation}\label{EnSchrodi}
  \left\{\Nabla^2+K^2n(\vect{r})^2\right\}\Psi(\vect{r}).
\end{equation}

%\index{Wave propagation|)}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Neutron scattering in Born approximation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

For neutrons, as for X-rays, the refractive index~$n$ is close to~1,
with $1-n$ typically of the order $10^{-5}$ or smaller.
In the following,
we shall use this fact to solve the Schrödinger equation~(\ref{EnSchrodi})
in a perturbation expansion
that is known as the Born approximation
though it goes back to Lord Rayleigh
who devised it for the scattering of sound,
and later also applied it to electromagnetic waves.

%===============================================================================
\subsection{The Born expansion}
%===============================================================================

We rewrite the Schrödinger equation~(\ref{EnSchrodi})
once more so that it takes the form of a Helmholtz equation
with a perturbation term on the right side:
\begin{equation}\label{EinhomoSchrodi}
  \left(\Nabla^2+K^2\right)\Psi(\vect{r})
  = \frac{\chi(\vect{r})}{4\pi}\Psi(\vect{r})
\end{equation}
with
\begin{equation}\label{EChiDef}
  \chi(\vect{r}) := \frac{4\pi}{K^2}\left(1-n^2(\vect{r})\right).
\end{equation}
This definition just compensates (\ref{EnRefrIndx}) so that $\chi=\rho_s$.
Equation~(\ref{EinhomoSchrodi}) looks
like an inhomogenous differential equation ---
provided we neglect for a moment that unknown function~$\Psi$
reappears on the right side.
The homogeneous equation
\begin{equation}\label{EHelmholtzHomog}
  \left(\Nabla^2+K^2\right)\Psi_0(\vect{r}) = 0
\end{equation}
is solved by plane waves and superpositions thereof.
For an isolated inhomogeneity,
\begin{equation}\label{EHelmholtzForGreen}
  \left(\Nabla^2+K^2\right)G(\vect{r}) = \delta(\vect{r})
\end{equation}
is solved by the Green function\footnote
{Verification under the condition $\vect{r}\ne0$
is a straightforward exercice in vector analysis.
For the special case $\vect{r}=0$,
one encloses the origin in a small sphere
and integrates by means of the Gauss-Ostrogadsky divergence theorem.
This explains the appearance of the factor $4\pi$.}
\begin{equation}\label{EGreens1}
  G(\vect{r}) = \frac{{\rm e}^{iKr}}{4\pi r},
\end{equation}
which is an outgoing spherical wave originating from $\vect{r}=0$.
Convoluting this function with the given inhomogeneity $(\chi/4\pi)\Psi$,
we obtain the formal solution
of the full inhomogeneous equation~(\ref{EHelmholtzInhomog})
\begin{equation}\label{EPsiFormal}
  \Psi(\vect{r})
  = \Psi_0(\vect{r})
  + \int\,{\rm d}^3r' G(\vect{r}-\vect{r'})
                     \frac{\chi(\vect{r'})}{4\pi}\Psi(\vect{r'}).
\end{equation}
However, the integral kernel still contains the full solution~$\Psi$.
If we replace this occurence of $\Psi$
by the full right-hand side of~(\ref{EPsiFormal})
we obtain
\begin{equation}
  \Psi(\vect{r})
  = \Psi_0(\vect{r})
  + \int\,{\rm d}^3r' G(\vect{r}-\vect{r'})\frac{\chi(\vect{r'})}{4\pi}
  \left(\Psi_0(\vect{r'})
  + \int\,{\rm d}^3r''
  G(\vect{r'}-\vect{r''})\frac{\chi(\vect{r''})}{4\pi}
  \Psi(\vect{r''})\right).
\end{equation}
This can be iterated to obtain an infinite series representation of $\Psi$.
Successive terms in this series contain rising powers of $\chi$.
Since $\chi$ is assumed to be small, the series is likely to converge.
In first Born approximation,
only the linear order in $\chi$ is retained,
\begin{equation}\label{EBorn}
  \Psi(\vect{r})
  \simeq \Psi_0(\vect{r})
  + \int\,{\rm d}^3r' G(\vect{r}-\vect{r'})\frac{\chi(\vect{r'})}{4\pi}
   \Psi_0(\vect{r'}).
\end{equation}
This is practically always adequate for
material investigations with X-rays or neutrons,
where the aim is to 
deduce $\chi(\vect{r'})$ from the scattered intensity ${|\Psi(\vect{r})|}^2$.

%===============================================================================
\subsection{Far-field expansion}
%===============================================================================

In a scattering experiment,
the intensity ${|\Psi(\vect{r})|}^2$ is measured
at a detector location~$\vect{r}$
far away from the sample volume.
We choose the coordinate origin at the nominal center of the sample
so that the integral in~(\ref{EBorn}) runs over $\vect{r'}$ with $r'\ll r$.
This allows us to expand
\begin{equation}
  \left|\vect{r}-\vect{r'}\right|
  \simeq \sqrt{r^2-2\vect{r}\,\vect{r'}}
  \simeq r - \frac{\vect{r}\,\vect{r'}}{r}
  \equiv r - \frac{\vect{k}_f \vect{r'}}{K},
\end{equation}
where we have introduced the outgoing wave vector
\begin{equation}
  \vect{k}_f:=K\frac{\vect{r}}{r}.
\end{equation}
We apply this to the Green function~(\ref{EGreens1}),
retaining the first order in $\vect{r'}$ in the exponent,
but not in the denominator:
\begin{equation}
  G(\vect{r}-\vect{r'})
  \simeq\frac{{\rm e}^{iKr - i\vect{k}_f \vect{r'}}}{4\pi r}.
\end{equation}
This is an outgoing spherical wave with respect to $\vect{r}$,
but a plane wave with respect to~$\vect{r'}$.
If the incident radiation is also a plane wave,
\begin{equation}\label{EPsi0Plane}
  \Psi_0(\vect{r})={\rm e}^{i \vect{k}_i \vect{r}},
\end{equation}
then the Born approximation~(\ref{EBorn})
becomes essentially a Fourier transform of $\chi$,
  \index{Fourier transform}
\begin{equation}\label{EBornPlane}
  \Psi(\vect{r})
  \simeq \Psi_0(\vect{r})
  + \frac{{\rm e}^{iKr}}{r}
    \int\,{\rm d}^3r' {\rm e}^{i\vect{q}\,\vect{r'}}\chi(\vect{r'})
\end{equation}
with the \textit{scattering vector}
\index{Scattering vector}
\begin{equation}
  \vect{q}:=\vect{k}_i-\vect{k}_f.
\end{equation}

%===============================================================================
\subsection{Differential cross section}
%===============================================================================

Above, we said somewhat sloppily
that a scattering experiment measures intensities~${|\Psi(\vect{r}|}^2$.
We shall now make this more rigorous.
In the case of neutron scattering,
one actually measures the probability flux.
We define it in arbitrary relative units as
\begin{equation}
  \vect{J} := \Psi^*\frac{\Nabla}{2i}\Psi - \Psi\frac{\Nabla}{2i}\Psi^*.
\end{equation}
With (\ref{EPsi0Plane}), the incident flux is
\begin{equation}
  \vect{J}_0 = \vect{k}_i.
\end{equation}
The scattered wavefield (\ref{EBornPlane}) is observed
at a detector position $\vect{r}$ that is not illuminated by the
incident beam, hence $\Psi_0(\vect{r})=0$.
This leaves us with
\begin{equation}
  \vect{J}(\vect{r})
  = {\left|\frac{1}{r}
    \int\,{\rm d}^3r' {\rm e}^{i\vect{q}\,\vect{r'}}\chi(\vect{r'})
    \right|}^2 K\frac{\vect{r}}{r}.
\end{equation}
The ratio of the scattered current hitting an infinitesimal detector area
$r^2{\rm d}\Omega$ to the incident flux is expressed as a
\textit{differential cross section}
  \index{Cross section}
  \index{Differential cross section}
\begin{equation}
  \frac{{\rm d}\sigma}{{\rm d}\Omega}
  := \frac{r^2 J(\vect{r})}{J_0}.
\end{equation}
Using $k_i=K$ and changing notation $\vect{r'}\to\vect{r}$,
we find
\begin{equation}
  \frac{{\rm d}\sigma}{{\rm d}\Omega}
  = {\left|
    \int\,{\rm d}^3r {\rm e}^{i\vect{q}\,\vect{r}}\chi(\vect{r})
    \right|}^2 =: {\left| \chi(\vect{q}) \right|}^2
\end{equation}
The differential cross section is just the squared modulus
of the Fourier transform $\chi(\vect{q})$
\index{Fourier transform}
of the scattering-length distribution~(\ref{EChiDef}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Distorted Wave Born Approximation}\label{Sdwba}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{Distorted wave Born approximation}
\index{DWBA|see {Distorted wave Born approximation}}

As we have seen
the Born approximation relies on plane waves,
which basically means that incoming and scattered radiation
are assumed to propagate along straight lines,
with directions expressed by $\vect{k}_i$ and $\vect{k}_f$.
This is adequate for most experiments with weakly interacting radiation,
and especially for most X-ray and neutron scattering techniques,
but not for grazing-incidence small-angle scattering
where radiation is refracted and reflected by interfaces
 \index{Refraction}
 \index{Reflection}
and therefore does not propagate along straight lines.
The Born approximation also fails for collisions of charged particles.
For them, Massey and Mott devised in the early 1930s
the distorted wave Born approximation (DWBA).
% Schiff (^3 1968, p 327) cites
% Mott, Massey, The Theory of Atomic Collisions, p 100, Oxford 1933;
% There are also several papers by Massey and Mott from about 1933.
A particularly simple variant of this approximation
is routinely used to account for refraction and reflection
in grazing-incidence scattering.

In reflectometry or grazing-incidence scattering,
samples are usually modelled as being translationally invariant
in $x$ and $y$ direction,
while being nontrivially modulated in $z$ direction.
The $z$ axis points upwards, hence out of the sample towards the
air or vacuum half space where the incident radiation comes from.
% TODO: add figure

Refraction and reflection are caused by vertical variations
of the average refractive index $\nz(z)$.
We rewrite the Helmholtz equation~(\ref{EHelmholtzInhomog} as
\begin{equation}\label{EHelmholtzGraded}
  \left(\Nabla^2+K^2\nz^2(z)\right)\Psi(\vect{r})
  = \frac{\chi(\vect{r})}{4\pi}\Psi(\vect{r})
\end{equation}
with (\ref{EChiDef}) replaced by
\begin{equation}\label{EChiGraded}
  \chi(\vect{r}) := \frac{4\pi}{K^2}\left(\nz^2(z)-n^2(\vect{r})\right).
\end{equation}
The homogeneous equation
\begin{equation}\label{EHelmholtzGradedHomog}
  \left(\Nabla^2+K^2\nz^2(z)\right)\Psi_0(\vect{r}) = 0
\end{equation}
suggests the ansatz
\begin{equation}\label{Ewave3}
\psi_0(\vect{r}) = {\rm e}^{i \vect{k}_\parallel\vect{r}_\parallel} \phi(z).
\end{equation}
The in-plane wave vector $\vect{k}_\parallel$ remains constant
as initialized by the incoming beam.
The vertical wave function must fulfill
\begin{equation}\label{Ewavez}
\left(\partial_z^2 + K^2\nz(z)^2 - k_\parallel^2 \right) \phi(z) = 0.
\end{equation}
Since we are describing scattering in continuum approximation anyway,
we can safely assume that $\nz(z)$ varies only slowly on the length scale
of the radiation wavelength.
Therefore an appropriate ansatz is
\begin{equation}
  \phi(z) = r(z){\rm e}^{ip(z)z} + t(z){\rm e}^{-ip(z)z}
\end{equation}
with
\begin{equation}
  p(z) := \sqrt{K^2\nz(z)^2 - k_\parallel^2}.
\end{equation}
Since the incoming beam has a vertical component in direction $-z$,
we identify $r(z)$ and $t(z)$
as amplitudes of the backward-propagating (reflected)
and forward-propagting (transmitted) beam, respectively.

%===============================================================================
\subsection{Multilayer systems}
%===============================================================================

In multilayer systems, the first term of (\ref{Etdwba}) denotes the specular part of the reflection, while the second term is responsible for the off-specular scattering. This off-specular part is caused by deviations from the perfectly smooth layered system, as e.g. interface roughnesses or included nanoparticles. In here only the case of nanoparticles will be treated.

In the conventions where $H=-\Delta + V$, the potential splits into two parts $V_1$ and $V_2$, where only the second part is treated as a perturbation:
\begin{align*}
  V_1 & = K^2\left( 1-n_0^2(\vect{r})\right)  \\
  V_2 & = \sum_i K^2\left( n_0^2(\vect{R}^i) - n_i^2 \right) S^i(\vect{r}) \otimes \delta(\vect{r}-\vect{R}^i),
\end{align*}
where $n_0(\vect{r})$ denotes the refractive index of the unperturbed system (which, in case of a multilayer system, will only depend on its $z$-coordinate) and $n_i$ is the refractive index of the nanoparticle with shape function $S^i$ and position $\vect{R}^i$.

For nanoparticles in a specific layer $j$, i.e. $V_2\neq0$ only in layer $j$, one only needs the unperturbed solutions in layer $j$:
\begin{align*}
  \braketnoop{\vect{r}}{\Psi^+_{1k_i}} &= (2\pi)^{-3/2}\left[ R_j(\vect{k}_i) e^{i \vect{k}_{j,R}(\vect{k}_i)\cdot\vect{r}} + T_j(\vect{k}_i) e^{i \vect{k}_{j,T}(\vect{k}_i)\cdot\vect{r}} \right] \\
  \braketnoop{\Psi^-_{1k_f}}{\vect{r}} &= (2\pi)^{-3/2}\left[ R_j(-\vect{k}_f) e^{i \vect{k}_{j,R}(-\vect{k}_f)\cdot\vect{r}} + T_j(-\vect{k}_f) e^{i \vect{k}_{j,T}(-\vect{k}_f)\cdot\vectr} \right].
\end{align*}

The off-specular contribution to the scattering amplitude then becomes:
\begin{align*}
  f(\theta, \phi) &= -\int d^3\vectr \frac{V_2(\vectr)}{4\pi} \biggl[ T_iT_fe^{i(\vectk_{j,i}-\vectk_{j,f})\cdot\vectr} + R_iT_fe^{i(\vectkt_{j,i}-\vectk_{j,f})\cdot\vectr} \\
   & + T_iR_fe^{i(\vectk_{j,i}-\vectkt_{j,f})\cdot\vectr} + R_iR_fe^{i(\vectkt_{j,i}-\vectkt_{j,f})\cdot\vectr} \biggr],
\end{align*}
where the following shorthand notations were used:
\begin{align*}
  T_i &\equiv  T_j(\vect{k}_i) & R_i &\equiv  R_j(\vect{k}_i)  \\
  T_f &\equiv  T_j(-\vect{k}_f) & R_f &\equiv  R_j(-\vect{k}_f) \\
  \vectk_{j,i} &\equiv \vectk_{j,T}(\vectk_i) & \vectkt_{j,i} &\equiv \vectk_{j,R}(\vectk_i)  \\
  \vectk_{j,f} &\equiv -\vectk_{j,T}(-\vectk_f) & \vectkt_{j,f} &\equiv -\vectk_{j,R}(-\vectk_f).
\end{align*}

From this expression, one sees that the scattering amplitude consists of a weighted sum of Fourier transforms of the potential $V_2$. Using
\begin{equation*}
  V_2(\vectr) = \sum_i 4\pi \rho_{s,rel,i} S^i(\vectr) \otimes \delta(\vectr - \vect{R}^i),
\end{equation*}
with $\rho_{s,rel,i}\equiv  K^2\left( n_0^2(\vect{R}^i) - n_i^2 \right)/4\pi$, the scattering amplitude becomes
\begin{equation*}
  f(\theta, \phi) = -\sum_i  \rho_{s,rel,i} \curlf^i_{\text{DWBA}}(\vectk_{j,i},\vectk_{j,f},\vect{R}^i_z)e^{i(\vectk_{j,i\parallel}-\vectk_{j,f\parallel})\cdot \vect{R}^{i\parallel} },
\end{equation*}
with
\begin{align*}
  \curlf^i_\text{DWBA}(\vectk_i,\vectk_f,R_z) & \equiv T_iT_fF^i(\vectk_i-\vectk_f)e^{i(k_{iz}-k_{fz})R_z} + R_iT_fF^i(\vectkt_i-\vectk_f)e^{i(-k_{iz}-k_{fz})R_z} \\
  & + T_iR_fF^i(\vectk_i-\vectkt_f)e^{i(k_{iz}+k_{fz})R_z} + R_iR_fF^i(\vectkt_i-\vectkt_f)e^{i(-k_{iz}+k_{fz})R_z},
\end{align*}

TO MERGE IN:
In the DWBA, the form factor of a particle in a multilayer system is given by
\begin{align}
F_{\rm{DWBA}} (\vect{k}_i,\vect{k}_f, r_z) & = T_i T_f F_{\rm{BA}} (\vect{k}_i-\vect{k}_f) e^{i (k_{i,z}-k_{f,z}) r_z} + R_i T_f F_{\rm{BA}}(\vect{\widetilde{k}}_i-\vect{k}_f) e^{i(-k_{i,z}-k_{f,z})r_z}
 \nonumber \\
  &+ T_i R_f F_{\rm{BA}}(\vect{k}_i-\vect{\widetilde{k}}_f)e^{i(k_{i,z}+k_{f,z})r_z} + R_iR_fF_{\rm{BA}} (\vect{\widetilde{k}}_i-\vect{\widetilde{k}}_f)e^{i(-k_{i,z}+k_{f,z})r_z}, \label{Edwbageneral}
\end{align}
where $F_{\rm{BA}}$ is the expression of the form factor in the Born approximation, $r_z$ is the $z$-coordinate of the particle's position (measured from the bottom of the particle), $\vect{k}_i=(k_{i,x}, k_{i,y}, k_{i,z})$ $\vect{k}_f=(k_{f,x}, k_{f,y}, k_{f,z})$ are the incident and scattered wave vectors in air, respectively \cite{RaSS95}.
With a tilde (\~{}), these wave vectors components are evaluated in the multilayer system (the refractive indices of the different constituting materials have to be taken into account). 
$T_i$, $T_f$, $R_i$, $R_f$ are the transmission and reflection coefficients for the incident wave (index $i$) or the scattered one (index $f$). These coefficients can be calculated using the Parratt formalism \cite{Par54} or the matrix method \cite{BoWo99}. $\vect{k}_i-\vect{k}_f$ is equal to the scattering vector $\vect{q}$ and the $z$-axis is pointing upwards.\\

With this last expression, the same techniques as demonstrated in section \ref{sec:ba} can be applied, leading to the following expression for the expectation value of the scattering cross-section:
\begin{align*}
  & \left\langle \frac{d\sigma}{d\Omega}(\vectk_i,\vectk_f) \right\rangle_{\text{Off-specular}}  \\
  & = \sum_\alpha p_\alpha \left\lvert \curlf_\alpha(\vectk_{j,i},\vectk_{j,f}, R_{\alpha,z})\right\rvert ^2 + \frac{\rho_S}{S}\sum_{\alpha,\beta} p_\alpha p_\beta \curlf_\alpha (\vectk_{j,i},\vectk_{j,f}, R_{\alpha,z})\curlf_\beta^*(\vectk_{j,i},\vectk_{j,f}, R_{\beta,z}) \\
  & \times \iint_S d^2\vect{R}_\alpha^\parallel d^2\vect{R}_\beta^\parallel \ppcf{\alpha}{\beta}{R^\parallel} \exp \left[ i\vect{q}_{j\parallel}\cdot (\vect{R}_\alpha^\parallel - \vect{R}_\beta^\parallel ) \right].
\end{align*}

The main differences with respect to the cross-section in the Born approximation are:
\begin{enumerate}
  \item The particle form factor now consists of a more complex expression and now depends on both incoming and outgoing wavevectors and also on the $z$-coordinate of the particle;
  \item Since the $z$-coordinate of the particles is implicitly included in its formfactor, the position integrals only run over $x$- and $y$-coordinates and the volume and density gets replaced with the surface area and surface density respectively.
\end{enumerate}

%===============================================================================
\section{X-ray propagation}\label{Sxray}
%===============================================================================
\index{Wave propagation!X-rays}
\index{X-rays!wave propagation}

\ldots to come


%===============================================================================
\section{Polarized neutrons}\label{Snpol}
%===============================================================================



%===============================================================================
\section{TO RECYCLE}
%===============================================================================

Consider a scattering volume $V$, containing $N$ scattering centers with shape functions $S^i(\vect{r})$, positions $\vect{R}^i$ and scattering length density $\rho_s$ (relative to the ambient material).

The differential cross-section (per scattering center) is then given by:
\begin{equation}\label{Exsec1}
  \frac{d\sigma}{d\Omega}(\vect{q}) = \frac{1}{N}\left\lvert \int_V \rho_s(\vect{r}) e^{i\vect{q}\cdot\vect{r}} d^3\vect{r} \right\rvert ^2.
\end{equation}

