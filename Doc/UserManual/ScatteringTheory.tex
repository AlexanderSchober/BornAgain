%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   BornAgain User Manual
%%
%%   homepage:   http://www.bornagainproject.org
%%
%%   copyright:  Forschungszentrum Jülich GmbH 2015
%%
%%   license:    Creative Commons CC-BY-SA
%%   
%%   authors:    Scientific Computing Group at MLZ Garching
%%               C. Durniak, M. Ganeva, G. Pospelov, W. Van Herck, J. Wuttke
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{Foundations of GISAS}  \SecLabel{ScatTheory}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Wave propagation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{Wave propagation|(}

%===============================================================================
\subsection{X-ray propagation}
%===============================================================================
\index{Wave propagation!X-rays}
\index{X-rays!wave propagation}

\ldots to come

%===============================================================================
\subsection{Neutron propagation}
%===============================================================================
\index{Wave propagation!neutrons}
\index{neutrons!wave propagation}

In a GISANS experiment,
we are only interested in small scattering vectors~$\vect{q}$,
and therefore do not register ordinary Bragg scattering
by crystal lattices or other correlations at atomic level;
at most, Bragg scattering must be accounted for as a loss channels.
We therefore describe the neutron-sample interaction
in continuum approximation by a refractive index~$n$ with
\begin{equation}\label{eq:nRefrIndx}
  n^2=1-\frac{4\pi}{K^2}\rho_s
\end{equation}
where $\rho_s$ is an effective scattering length density
\cite{Lax51,Sea89}.
\index{Scattering length density}

%TODO: how is absorption taken into account?

%===============================================================================
\subsection{Helmholtz equation}
%===============================================================================

X-ray and neutron propagation are both governed by
the same stationary wave equation,
the \textit{Helmholtz equation}
\index{Helmholtz equation}
\index{Wave equation}
\begin{equation}\label{eq:Helmholtz}
  \left(\Nabla^2+K^2n(\vect{r})^2\right)\Psi(\vect{r}),
\end{equation}
where $K=2\pi/\lambda_0$ is the vacuum wave number,
and $n$ is the refractive index.
\index{Refractive index}
In this equation,
the time dependence ${\rm e}^{i\omega t}$ of the wave field
does not appear explicitly.
In GISAS, we are only interested in elastic scattering.
Therefore, the wave frequency~$\omega$ is considered constant.

Implicitly, $K$ depends on~$\omega$ through a \textit{dispersion relation}.
\index{dispersion relation}
This relation is fundamentally different for
X-rays (where it is linear, $\omega\propto K$)
and for thermal neutrons (where it is quadratic, $\omega\propto K^2$).
However, for stationary problems
this frequency dependence of~$K$ does not matter.
Therefore we can use $K$ instead of~$\omega$ as a constant
that characterizes the incoming radiation.
In this way, scalar X-ray and neutron scattering can be described by exactly
the same wave equation~(\ref{eq:Helmholtz}).

\index{Wave propagation|)}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Scalar scattering}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

For both X-rays and neutrons the refractive index~$n$ is close to~1.
In the following,
we shall use this fact to solve the Helmholtz equation 
in a perturbation expansion
that is known as the Born approximation
though it goes back to Lord Rayleigh
who devised it for the scattering of sound,
and later also applied it to electromagnetic waves.

%===============================================================================
\subsection{Born approximation}
%===============================================================================

We rewrite the scalar Helmholtz equation~(\ref{eq:Helmholtz}) as
\begin{equation}\label{eq:HelmholtzInhomog}
  \left(\Nabla^2+K^2\right)\Psi(\vect{r})
  = \frac{\chi(\vect{r})}{4\pi}\Psi(\vect{r})
\end{equation}
with
\begin{equation}\label{eq:ChiDef}
  \chi(\vect{r}) := \frac{4\pi}{K^2}\left(1-n^2(\vect{r})\right).
\end{equation}
For neutrons, this definition just compensates (\ref{eq:nRefrIndx})
so that $\chi=\rho_s$.
Equation~(\ref{eq:Helmholtz}) looks
like an inhomogenous differential equation ---
provided we neglect for a moment that unknown function~$\Psi$
reappears on the right side.
The homogeneous equation
\begin{equation}\label{eq:HelmholtzHomog}
  \left(\Nabla^2+K^2\right)\Psi_0(\vect{r}) = 0
\end{equation}
is solved by plane waves and superpositions thereof.
For an isolated inhomogeneity,
\begin{equation}\label{eq:HelmholtzForGreen}
  \left(\Nabla^2+K^2\right)G(\vect{r}) = \delta(\vect{r})
\end{equation}
is solved by the Green's function\footnote
{Verification under the condition $\vect{r}\ne0$
is a straightforward exercice in vector analysis.
For the special case $\vect{r}=0$,
one encloses the origin in a small sphere
and integrates by means of the Gauß-Ostrogadsky divergence theorem.
This explains the appearance of the factor $4\pi$.}
\begin{equation}\label{eq:Greens1}
  G(\vect{r}) = \frac{{\rm e}^{iKr}}{4\pi r},
\end{equation}
which is an outgoing spherical wave originating from $\vect{r}=0$.
Convoluting this function with the given inhomogeneity $(\chi/4\pi)\Psi$,
we obtain the formal solution
of the full inhomogeneous equation~(\ref{eq:HelmholtzInhomog})
\begin{equation}\label{eq:PsiFormal}
  \Psi(\vect{r})
  = \Psi_0(\vect{r})
  + \int\,{\rm d}^3r' G(\vect{r}-\vect{r'})
                     \frac{\chi(\vect{r'})}{4\pi}\Psi(\vect{r'}).
\end{equation}
However, the integral kernel still contains the full solution~$\Psi$.
If we replace this occurence of $\Psi$
by the full right-hand side of~(\ref{eq:PsiFormal})
we obtain
\begin{equation}
  \Psi(\vect{r})
  = \Psi_0(\vect{r})
  + \int\,{\rm d}^3r' G(\vect{r}-\vect{r'})\frac{\chi(\vect{r'})}{4\pi}
  \left(\Psi_0(\vect{r'})
  + \int\,{\rm d}^3r''
  G(\vect{r'}-\vect{r''})\frac{\chi(\vect{r''})}{4\pi}
  \Psi(\vect{r''})\right).
\end{equation}
This can be iterated to obtain an infinite series representation of $\Psi$.
Successive terms in this series contain rising powers of $\chi$.
Since $\chi$ is assumed to be small, the series is likely to converge.
In first Born approximation,
only the linear order in $\chi$ is retained,
\begin{equation}\label{eq:Born}
  \Psi(\vect{r})
  \simeq \Psi_0(\vect{r})
  + \int\,{\rm d}^3r' G(\vect{r}-\vect{r'})\frac{\chi(\vect{r'})}{4\pi}
   \Psi_0(\vect{r'}).
\end{equation}
This is practically always adequate for
material investigations with X-rays or neutrons,
where the aim is to 
deduce $\chi(\vect{r'})$ from the scattered intensity ${|\Psi(\vect{r})|}^2$.

%===============================================================================
\subsection{Far-field expansion}
%===============================================================================

In a scattering experiment,
the intensity ${|\Psi(\vect{r})|}^2$ is measured
at a detector location~$\vect{r}$
far away from the sample volume.
We choose the coordinate origin at the nominal center of the sample
so that the integral in~(\ref{eq:Born}) runs over $\vect{r'}$ with $r'\ll r$.
This allows us to expand
\begin{equation}
  \left|\vect{r}-\vect{r'}\right|
  \simeq \sqrt{r^2-2\vect{r}\,\vect{r'}}
  \simeq r - \frac{\vect{r}\,\vect{r'}}{r}
  \equiv r - \frac{\vect{k}_f \vect{r'}}{K},
\end{equation}
where we have introduced the outgoing wave vector
\begin{equation}
  \vect{k}_f:=K\frac{\vect{r}}{r}.
\end{equation}
We apply this to the Green's function~(\ref{eq:Greens1}),
retaining the first order in $\vect{r'}$ in the exponent,
but not in the denominator:
\begin{equation}
  G(\vect{r}-\vect{r'})
  \simeq\frac{{\rm e}^{iKr - i\vect{k}_f \vect{r'}}}{4\pi r}.
\end{equation}
This is an outgoing spherical wave with respect to $\vect{r}$,
but a plane wave with respect to~$\vect{r'}$.
If the incident radiation is also a plane wave,
\begin{equation}\label{eq:Psi0Plane}
  \Psi_0(\vect{r})={\rm e}^{i \vect{k}_i \vect{r}},
\end{equation}
then the Born approximation~(\ref{eq:Born})
becomes essentially a Fourier transform of $\chi$,
  \index{Fourier transform}
\begin{equation}\label{eq:BornPlane}
  \Psi(\vect{r})
  \simeq \Psi_0(\vect{r})
  + \frac{{\rm e}^{iKr}}{r}
    \int\,{\rm d}^3r' {\rm e}^{i\vect{q}\,\vect{r'}}\chi(\vect{r'})
\end{equation}
with the \textit{scattering vector}
\index{Scattering vector}
\begin{equation}
  \vect{q}:=\vect{k}_i-\vect{k}_f.
\end{equation}

%===============================================================================
\subsection{Differential cross section}
%===============================================================================

Above, we said somewhat sloppily
that a scattering experiment measures intensities~${|\Psi(\vect{r}|}^2$.
We shall now make this more rigorous.
In the case of neutron scattering,
one actually measures the probability flux.
We define it in arbitrary relative units as
\begin{equation}
  \vect{J} := \Psi^*\frac{\Nabla}{2i}\Psi - \Psi\frac{\Nabla}{2i}\Psi^*.
\end{equation}
With (\ref{eq:Psi0Plane}), the incident flux is
\begin{equation}
  \vect{J}_0 = \vect{k}_i.
\end{equation}
The scattered wavefield (\ref{eq:BornPlane}) is observed
at a detector position $\vect{r}$ that is not illuminated by the
incident beam, hence $\Psi_0(\vect{r})=0$.
This leaves us with
\begin{equation}
  \vect{J}(\vect{r})
  = {\left|\frac{1}{r}
    \int\,{\rm d}^3r' {\rm e}^{i\vect{q}\,\vect{r'}}\chi(\vect{r'})
    \right|}^2 K\frac{\vect{r}}{r}.
\end{equation}
The ratio of the scattered current hitting an infinitesimal detector area
$r^2{\rm d}\Omega$ to the incident flux is expressed as a
\textit{differential cross section}
  \index{Cross section}
  \index{Differential cross section}
\begin{equation}
  \frac{{\rm d}\sigma}{{\rm d}\Omega}
  := \frac{r^2 J(\vect{r})}{J_0}.
\end{equation}
Using $k_i=K$ and changing notation $\vect{r'}\to\vect{r}$,
we find
\begin{equation}
  \frac{{\rm d}\sigma}{{\rm d}\Omega}
  = {\left|
    \int\,{\rm d}^3r {\rm e}^{i\vect{q}\,\vect{r}}\chi(\vect{r})
    \right|}^2 =: {\left| \chi(\vect{q}) \right|}^2
\end{equation}
The differential cross section is just the squared modulus
of the Fourier transform $\chi(\vect{q})$
\index{Fourier transform}
of the scattering-length distribution~(\ref{eq:ChiDef}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Distorted Wave Born Approximation} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{Distorted wave Born approximation}
\index{DWBA|see {Distorted wave Born approximation}}

As we have seen
the Born approximation relies on plane waves,
which basically means that incoming and scattered radiation
are assumed to propagate along straight lines,
with directions expressed by $\vect{k}_i$ and $\vect{k}_f$.
This is adequate for most experiments with weakly interacting radiation,
and especially for most X-ray and neutron scattering techniques,
but not for grazing-incidence small-angle scattering
where radiation is refracted and reflected by interfaces
 \index{Refraction}
 \index{Reflection}
and therefore does not propagate along straight lines.
The Born approximation also fails for collisions of charged particles.
For them, Massey and Mott devised in the early 1930s
the distorted wave Born approximation (DWBA).
% Schiff (^3 1968, p 327) cites
% Mott, Massey, The Theory of Atomic Collisions, p 100, Oxford 1933;
% There are also several papers by Massey and Mott from about 1933.
A particularly simple variant of this approximation
is routinely used to account for refraction and reflection
in grazing-incidence scattering.

Refraction and reflection are caused by vertical variations
of the average refractive index $n_0(z)$.

%===============================================================================
\subsection{Multilayer systems}
%===============================================================================

In multilayer systems, the first term of (\ref{eq:tdwba}) denotes the specular part of the reflection, while the second term is responsible for the off-specular scattering. This off-specular part is caused by deviations from the perfectly smooth layered system, as e.g. interface roughnesses or included nanoparticles. In here only the case of nanoparticles will be treated.

In the conventions where $H=-\Delta + V$, the potential splits into two parts $V_1$ and $V_2$, where only the second part is treated as a perturbation:
\begin{align*}
  V_1 & = K^2\left( 1-n_0^2(\vect{r})\right)  \\
  V_2 & = \sum_i K^2\left( n_0^2(\vect{R}^i) - n_i^2 \right) S^i(\vect{r}) \otimes \delta(\vect{r}-\vect{R}^i),
\end{align*}
where $n_0(\vect{r})$ denotes the refractive index of the unperturbed system (which, in case of a multilayer system, will only depend on its $z$-coordinate) and $n_i$ is the refractive index of the nanoparticle with shape function $S^i$ and position $\vect{R}^i$.

For nanoparticles in a specific layer $j$, i.e. $V_2\neq0$ only in layer $j$, one only needs the unperturbed solutions in layer $j$:
\begin{align*}
  \braketnoop{\vect{r}}{\Psi^+_{1k_i}} &= (2\pi)^{-3/2}\left[ R_j(\vect{k}_i) e^{i \vect{k}_{j,R}(\vect{k}_i)\cdot\vect{r}} + T_j(\vect{k}_i) e^{i \vect{k}_{j,T}(\vect{k}_i)\cdot\vect{r}} \right] \\
  \braketnoop{\Psi^-_{1k_f}}{\vect{r}} &= (2\pi)^{-3/2}\left[ R_j(-\vect{k}_f) e^{i \vect{k}_{j,R}(-\vect{k}_f)\cdot\vect{r}} + T_j(-\vect{k}_f) e^{i \vect{k}_{j,T}(-\vect{k}_f)\cdot\vectr} \right].
\end{align*}

The off-specular contribution to the scattering amplitude then becomes:
\begin{align*}
  f(\theta, \phi) &= -\int d^3\vectr \frac{V_2(\vectr)}{4\pi} \biggl[ T_iT_fe^{i(\vectk_{j,i}-\vectk_{j,f})\cdot\vectr} + R_iT_fe^{i(\vectkt_{j,i}-\vectk_{j,f})\cdot\vectr} \\
   & + T_iR_fe^{i(\vectk_{j,i}-\vectkt_{j,f})\cdot\vectr} + R_iR_fe^{i(\vectkt_{j,i}-\vectkt_{j,f})\cdot\vectr} \biggr],
\end{align*}
where the following shorthand notations were used:
\begin{align*}
  T_i &\equiv  T_j(\vect{k}_i) & R_i &\equiv  R_j(\vect{k}_i)  \\
  T_f &\equiv  T_j(-\vect{k}_f) & R_f &\equiv  R_j(-\vect{k}_f) \\
  \vectk_{j,i} &\equiv \vectk_{j,T}(\vectk_i) & \vectkt_{j,i} &\equiv \vectk_{j,R}(\vectk_i)  \\
  \vectk_{j,f} &\equiv -\vectk_{j,T}(-\vectk_f) & \vectkt_{j,f} &\equiv -\vectk_{j,R}(-\vectk_f).
\end{align*}

From this expression, one sees that the scattering amplitude consists of a weighted sum of Fourier transforms of the potential $V_2$. Using
\begin{equation*}
  V_2(\vectr) = \sum_i 4\pi \rho_{s,rel,i} S^i(\vectr) \otimes \delta(\vectr - \vect{R}^i),
\end{equation*}
with $\rho_{s,rel,i}\equiv  K^2\left( n_0^2(\vect{R}^i) - n_i^2 \right)/4\pi$, the scattering amplitude becomes
\begin{equation*}
  f(\theta, \phi) = -\sum_i  \rho_{s,rel,i} \curlf^i_{\text{DWBA}}(\vectk_{j,i},\vectk_{j,f},\vect{R}^i_z)e^{i(\vectk_{j,i\parallel}-\vectk_{j,f\parallel})\cdot \vect{R}^{i\parallel} },
\end{equation*}
with
\begin{align*}
  \curlf^i_\text{DWBA}(\vectk_i,\vectk_f,R_z) & \equiv T_iT_fF^i(\vectk_i-\vectk_f)e^{i(k_{iz}-k_{fz})R_z} + R_iT_fF^i(\vectkt_i-\vectk_f)e^{i(-k_{iz}-k_{fz})R_z} \\
  & + T_iR_fF^i(\vectk_i-\vectkt_f)e^{i(k_{iz}+k_{fz})R_z} + R_iR_fF^i(\vectkt_i-\vectkt_f)e^{i(-k_{iz}+k_{fz})R_z},
\end{align*}

TO MERGE IN:
In the DWBA, the form factor of a particle in a multilayer system is given by
\begin{align}
F_{\rm{DWBA}} (\vect{k}_i,\vect{k}_f, r_z) & = T_i T_f F_{\rm{BA}} (\vect{k}_i-\vect{k}_f) e^{i (k_{i,z}-k_{f,z}) r_z} + R_i T_f F_{\rm{BA}}(\vect{\widetilde{k}}_i-\vect{k}_f) e^{i(-k_{i,z}-k_{f,z})r_z}
 \nonumber \\
  &+ T_i R_f F_{\rm{BA}}(\vect{k}_i-\vect{\widetilde{k}}_f)e^{i(k_{i,z}+k_{f,z})r_z} + R_iR_fF_{\rm{BA}} (\vect{\widetilde{k}}_i-\vect{\widetilde{k}}_f)e^{i(-k_{i,z}+k_{f,z})r_z}, \label{eq:dwbageneral}
\end{align}
where $F_{\rm{BA}}$ is the expression of the form factor in the Born approximation, $r_z$ is the $z$-coordinate of the particle's position (measured from the bottom of the particle), $\vect{k}_i=(k_{i,x}, k_{i,y}, k_{i,z})$ $\vect{k}_f=(k_{f,x}, k_{f,y}, k_{f,z})$ are the incident and scattered wave vectors in air, respectively \cite{RaSS95}. With a tilde (\~{}), these wavevectors components are evaluated in the multilayer system (the refractive indices of the different constituting materials have to be taken into account). 
$T_i$, $T_f$, $R_i$, $R_f$ are the transmission and reflection coefficients for the incident wave (index $i$) or the scattered one (index $f$). These coefficients can be calculated using the Parratt formalism \cite{Par54} or the matrix method \cite{BoWo99}. $\vect{k}_i-\vect{k}_f$ is equal to the scattering vector $\vect{q}$ and the $z$-axis is pointing upwards.\\

With this last expression, the same techniques as demonstrated in section \ref{sec:ba} can be applied, leading to the following expression for the expectation value of the scattering cross-section:
\begin{align*}
  & \left\langle \frac{d\sigma}{d\Omega}(\vectk_i,\vectk_f) \right\rangle_{\text{Off-specular}}  \\
  & = \sum_\alpha p_\alpha \left\lvert \curlf_\alpha(\vectk_{j,i},\vectk_{j,f}, R_{\alpha,z})\right\rvert ^2 + \frac{\rho_S}{S}\sum_{\alpha,\beta} p_\alpha p_\beta \curlf_\alpha (\vectk_{j,i},\vectk_{j,f}, R_{\alpha,z})\curlf_\beta^*(\vectk_{j,i},\vectk_{j,f}, R_{\beta,z}) \\
  & \times \iint_S d^2\vect{R}_\alpha^\parallel d^2\vect{R}_\beta^\parallel \ppcf{\alpha}{\beta}{R^\parallel} \exp \left[ i\vect{q}_{j\parallel}\cdot (\vect{R}_\alpha^\parallel - \vect{R}_\beta^\parallel ) \right].
\end{align*}

The main differences with respect to the cross-section in the Born approximation are:
\begin{enumerate}
  \item The particle form factor now consists of a more complex expression and now depends on both incoming and outgoing wavevectors and also on the $z$-coordinate of the particle;
  \item Since the $z$-coordinate of the particles is implicitly included in its formfactor, the position integrals only run over $x$- and $y$-coordinates and the volume and density gets replaced with the surface area and surface density respectively.
\end{enumerate}

%===============================================================================
\section{Polarization}
%===============================================================================

ome GISAS experiments are performed with polarized radiation
or/and involve polarization-dependent interactions.
Therefore we need also to consider
the propagation of polarized X-rays and neutrons.
Electromagnetic field vectors and neutron spinors
are fundamentally different mathematical objects
Nevertheless, for our purpose they can be
mapped onto a uniform .... <to elaborate> ....
so that one and the same formalism can be applied
to polarized GISAXS and GISANS.
This shall be derived in the following.


%===============================================================================
\subsection{Polarized X-rays}
%===============================================================================

%===============================================================================
\subsection{Polarized neutrons}
%===============================================================================




%===============================================================================
\section{TO RECYCLE}
%===============================================================================

Consider a scattering volume $V$, containing $N$ scattering centers with shape functions $S^i(\vect{r})$, positions $\vect{R}^i$ and scattering length density $\rho_s$ (relative to the ambient material).

The differential cross-section (per scattering center) is then given by:
\begin{equation}\label{eq:xsec1}
  \frac{d\sigma}{d\Omega}(\vect{q}) = \frac{1}{N}\left\lvert \int_V \rho_s(\vect{r}) e^{i\vect{q}\cdot\vect{r}} d^3\vect{r} \right\rvert ^2.
\end{equation}

