%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   BornAgain User Manual
%%
%%   homepage:   http://www.bornagainproject.org
%%
%%   copyright:  Forschungszentrum Jülich GmbH 2015
%%
%%   license:    Creative Commons CC-BY-SA
%%
%%   authors:    Scientific Computing Group at MLZ Garching
%%               C. Durniak, M. Ganeva, G. Pospelov, W. Van Herck, J. Wuttke
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Shape transform computations}  \label{SFFcomp}

\index{Shape transform!computation|(}
\index{Form factor!computation|(}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The Form factor of a hard-shell particle is simply its \E{shape transform},
as introduced in~(\ref{EFFhardshell}),
\begin{equation}\label{Eff3d}
  F(\q)=\int_V\!\d^3r\, \e^{i\q\r},
\end{equation}
where $V$ is the volume of the particle.
Here we show for a few selected cases
how to bring the analytical solution of this integral into a form
 suitable for speedy and stable computation.
This background material is of interest mostly for
developers who want to add some more form factors to \BornAgain's collection
(catalogued in App.~\ref{SFF}).

\index{Form factor!bound for absolute value}%
From~(\ref{Eff3d}), it is immediately clear that~$F(\q)$ is bounded by
\begin{equation}
  |F(\q)|\le V,
\end{equation}
with equality holding for~$\q=0$.
This excludes the presence of nonremovable singularities.
However, analytical solutions of~(\ref{Eff3d}) do contain
removable singularities.
These singularities must be investigated closely
in order to prevent floating-point errors and ill conditioned computations.

\index{Form factor!singularities}%
It seems that \E{all} analytical form factors have a singularity at~$\q=0$.
Furthermore, if the particle has \E{plane} surfaces,
then there is a singularity for all $\q$ that are normal to one of these planes.
A simple example is provided by the cuboid form factor (Sect.~\ref{SBox})
\begin{equation}
F= L W H\exp\left(i q_z \frac{H}{2}\right) \sinc\left(q_x \frac{L}{2}\right)
\sinc\left(q_y \frac{W}{2}\right) \sinc\left(q_z \frac{H}{2}\right).
\end{equation}
If the \E{sinus cardinalis} is written as
\index{Sinus cardinalis@Sinus cardinalis (sinc)!removable singularity}
\begin{equation}
  \sinc(u) = \frac{\sin(u)}{u},
\end{equation}
then there appears to be a singularity at $u=0$.
Applying L'Hôpital's rule, it is obvious
that this singularity can be removed by the interpolated value
$\sinc(0)=1$,
as is done in the generally agreed definition of the special function~$\sinc$.

While all this is clear and easy,
computations become more involved
if a particle has planes with normals that are not oriented along
any of the axes of the Cartesian coordinate system.
Typically then, the straightforward analytical solution of~(\ref{Eff3d})
results in messy expressions that obscure the symmetries of~$F(\q)$,
and make it difficult to recognize the singularities and
to remove them.
Therefore we shall consider a few such cases more closely.

% TODO? another concern: integrals without numeric solution

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Polygon}\label{SFFPolygon}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Form factor!(polygon}%
\index{Polygon!form factor(}
\def\R{\v{R}}
\def\E{\v{E}}

To derive the form factor of prisms and pyramids with polygonal bases
we start by computing the two-dimensional form factor
\begin{equation}\label{Eff2d}
  \Gamma(\q)=\int_A\!\d^2r\, \e^{i\q\r},
\end{equation}
of an arbitrary polygon of area~$A$.
In this section, all vectors are two-dimensional;
later, we will equate the two-dimensional~$\q$ with the in-plane
component~$\q_\parallel$ of the three-dimensional~$\q$.
We use Green's theorem
\begin{equation}
  \iint\!\d r^2\,\v{\Nabla}\wedge\v{G} = \oint \d\v{r}\cdot\v{G}
\end{equation}
with the wedge product
\begin{equation}
  \v{a}\wedge\v{b} \coloneqq
  a_xb_y - a_yb_x.
\end{equation}
We choose $\v{G}\coloneqq\v{a}\, \e^{i\q\r}$
to obtain the form factor as a line integral
\begin{equation}
  \Gamma(\q)=\frac{\v{a}}{i \q\wedge\v{a}} \oint \d\v{r}\,\e^{i\q\r}.
\end{equation}
To avoid singularities as far as possible,
we further choose $\v{a}=(-\hat q_y^*,\hat q_x^*)$.
With this special choice,
the wedge product in the denominator becomes a scalar product
$\q\wedge\v{a}=\q\v{\hat q^*}=q$, and
the scalar product in the numerator becomes a wedge product,
$\v{a}\r=\v{\hat q^*}\wedge\r$:
\begin{equation}
  \Gamma(\q)=\frac{\v{\hat q^*}}{iq}\wedge \oint \d\v{r}\,\e^{i\q\r}.
\end{equation}

The polygon shall be given by its $N$ edges $\r_0,\ldots,\r_{N-1}$.
It is convenient to abbreviate $\r_N\coloneqq\r_0$.
The edges of the polygon shall parametrized by
\begin{equation}
  \r(\lambda) = \frac{\r_{j+1}+\r_j}{2} + \frac{\r_{j+1}-\r_j}{2} \lambda
  \eqqcolon \R_j + \E_j\lambda.
\end{equation}
with $-1\le\lambda\le+1$.
The line integral can then be carried out to yield
\begin{equation}\label{Effpolygon}
    \Gamma(\q) = \displaystyle \frac{\v{\hat q^*}}{iq}\wedge \sum_{j=0}^{N-1}
              \int_{-1}^{+1}\!\d\lambda\, \frac{\d\r}{\d\lambda}\,\e^{i\q\r}
          = \displaystyle \frac{2\v{\hat q^*}}{iq}\wedge \sum_{j=0}^{N-1}
              \E_j \sinc(\q\E_j) \e^{i\q\R_j}.
\end{equation}
The line singularities for $\q\perp\E_j$ having gracefully disappeared in the
sinc function,
we are left with a point singularity at $q=0$.
It is easily seen that this singularity is removable:
On expanding the term under the sum in~$\q$,
the $\q^0$ term vanishes because $\sum\E_j=0$.
The leading term is therefore
\begin{equation}
  \begin{array}{@{}lcl}
  \Gamma(\q\!\to\!0) &\doteq& \displaystyle 2\sum (\v{\hat q^*}\wedge\E_j) (\v{\hat q}\R_j)\\[3ex]
    &=&\displaystyle \frac{1}{2}\sum \left\{
        (\v{\hat q^*}\wedge\r_{j+1})(\v{\hat q}\r_j) -
        (\v{\hat q^*}\wedge\r_j)(\v{\hat q}\r_{j+1})
      \right\}\\[3ex]
    &=&\displaystyle \frac{1}{2}\sum \r_j\wedge\r_{j+1},
  \end{array}
\end{equation}
which is the area of polygon
as given by a trianglular tiling (with edges at $\v{0},\r_j,\r_{j+1}$).

If the polygon has a two-fold symmetry axis, we write $N\eqqcolon2n$
and make use of $\r_{j+n}=-\r_j$ to transform~(\ref{Effpolygon}) into
\begin{equation}\label{Eff2ngon}
    \Gamma(\q) = \displaystyle 4 \sum_{j=0}^{n-1}
              (\v{\hat q^*}\wedge\E_j) (\v{\hat q}\R_j) \sinc(\q\E_j) \sinc(\q\R_j),
\end{equation}
where even the point singularity at $q=0$ is absorbed in a sinc function.
\index{Form factor!polygon)}%
\index{Polygon!form factor)}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Pyramids}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Form factor!frustum(}%
\index{Form factor!pyramid(}%
\index{Pyramid!form factor(}%
\index{Frustum!form factor(}%

Quite generally, we describe particles
as being based at $z=0$ and extending up to a height~$H$.
Accordingly,
the three-dimensional form factor~(\ref{Eff3d}) is
\begin{equation}
  F(\q) = \int_0^H\!\d z\,\e^{iq_z z} \Gamma(\q_\parallel,z)
\end{equation}
with a two-dimensional form factor~$\Gamma(\q_\parallel,z)$
of the horizontal section at given~$z$.
If this section has constant shape at variable size,
so that it scales with some function~$\rho(z)$,
then the two-dimensional form factor~(\ref{Eff2d})
can be written as
\begin{equation}
  \Gamma(\q_\parallel,z)
  = {\rho(z)}^2\, \Gamma\left(\rho(z)\q_\parallel,0\right).
\end{equation}
Depending on the geometry of the base,
its form factor can be written as a finite or infinite series
\begin{equation}
  \Gamma(\q_\parallel,0)=\sum_j A_j \e^{i\q_\parallel \v{c}_j}.
\end{equation}
Accordingly, the three-dimensional form factor can be computed as
\begin{equation}
  F(\q) = \sum_j A_j \int_0^H\!\d z\,\rho(z)^2\e^{iq_z z} \e^{i\rho(z)\q_\parallel \v{c}_j}.
\end{equation}
We now specialize to pyramids,
for which
\begin{equation}
  \rho(z) = 1-z/H_0
\end{equation}
with a parameter $H_0\le H$.
Unless the equal sign holds,
the pyramid is a truncated one (a frustum).
The form factor becomes
\begin{equation}
  \begin{array}{@{}lcl}
  F(\q)
  &=& \displaystyle
       \e^{iq_z H_0} \sum_j A_j \int_0^H\!\d z\,\rho(z)^2\e^{i(-q_zH_0 +\q_\parallel \v{c}_j)\rho(z)}
\\[3ex]
  &=& \displaystyle
       H_0\, \e^{iq_z H_0} \sum_j A_j \int_{1-H/H_0}^1\!\d\rho\, \rho^2\e^{i(-q_zH_0 +\q_\parallel \v{c}_j)\rho}
\\[3ex]
  &=& \displaystyle
       H_0\, \e^{iq_z H_0} \sum_j A_j \Delta(i(-q_zH_0 +\q_\parallel \v{c}_j),1-H/H_0)
  \end{array}
\end{equation}
with a function
\begin{equation}
  \Delta(u,v) \coloneqq
  \int_{v}^1\!\d\rho\,\rho^2\,\e^{u\rho}
  = \frac{\e^u-v^2\e^{uv}}{u}
  - 2\frac{\e^u-v\e^{uv}}{u^2}
  + 2\frac{\e^u-\e^{uv}}{u^3}.
\end{equation}
Expansion in~$u$ shows that the apparent singularity at $u=0$ is removable.

\index{Form factor!frustum)}%
\index{Form factor!pyramid)}%
\index{Pyramid!form factor)}%
\index{Frustum!form factor)}%

%\Work{work in progress \ldots}
\iffalse
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Special functions near the removable singularity}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Machine epsilon}
We assume a double-precision machine epsilon
of $\epsilon=2^{-52}\simeq2.2\cdot10^{-16}$.

\fi

\index{Shape transform!computation|)}
\index{Form factor!computation|)}
