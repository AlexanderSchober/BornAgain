%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   BornAgain User Manual
%%
%%   homepage:   http://www.bornagainproject.org
%%
%%   copyright:  Forschungszentrum JÃ¼lich GmbH 2015
%%
%%   license:    Creative Commons CC-BY-SA
%%
%%   authors:    Scientific Computing Group at MLZ Garching
%%               C. Durniak, M. Ganeva, G. Pospelov, W. Van Herck, J. Wuttke
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Shape transform computations}  \label{SFFcomp}

\index{Shape transform!computation|(}
\index{Form factor!computation|(}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The Form factor of a hard-shell particle is simply its \E{shape transform},
as introduced in~(\ref{EFFhardshell}),
\begin{equation}\label{Eff3d}
  F(\q)=\int_V\!\d^3r\, \e^{i\q\r},
\end{equation}
where $V$ is the volume of the particle.
Here we show for a few selected cases
how to bring the analytical solution of this integral into a form
 suitable for speedy and stable computation.
This background material is of interest mostly for
developers who want to add some more form factors to \BornAgain's collection
(catalogued in App.~\ref{SFF}).

\index{Form factor!bound for absolute value}%
From~(\ref{Eff3d}), it is immediately clear that~$F(\q)$ is bounded by
\begin{equation}
  |F(\q)|\le V,
\end{equation}
with equality holding for~$\q=0$.
This excludes the presence of nonremovable singularities.
However, analytical solutions of~(\ref{Eff3d}) do contain
removable singularities.
These singularities must be investigated closely
in order to prevent floating-point errors and ill conditioned computations.

\index{Form factor!singularities}%
It seems that \E{all} analytical form factors have a singularity at~$\q=0$.
Furthermore, if the particle has \E{plane} surfaces,
then there is a singularity for all $\q$ that are normal to one of these planes.
A simple example is provided by the cuboid form factor (Sect.~\ref{SBox})
\begin{equation}
F= L W H\exp\left(i q_z \frac{H}{2}\right) \sinc\left(q_x \frac{L}{2}\right)
\sinc\left(q_y \frac{W}{2}\right) \sinc\left(q_z \frac{H}{2}\right).
\end{equation}
If the \E{sinus cardinalis} is written as
\index{Sinus cardinalis@Sinus cardinalis (sinc)!removable singularity}
\begin{equation}
  \sinc(u) = \frac{\sin(u)}{u},
\end{equation}
then there appears to be a singularity at $u=0$.
Applying L'H\^opital's rule, it is obvious
that this singularity can be removed by the interpolated value
$\sinc(0)=1$,
as is done in the generally agreed definition of the special function~$\sinc$.

While all this is clear and easy,
computations become more involved
if a particle has planes with normals that are not oriented along
any of the axes of the Cartesian coordinate system.
Typically then, the straightforward analytical solution of~(\ref{Eff3d})
results in messy expressions that obscure the symmetries of~$F(\q)$,
and make it difficult to recognize the singularities and
to remove them.
Therefore we shall consider a few such cases more closely.

% TODO? another concern: integrals without numeric solution

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Polygon}\label{SFFPolygon}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Form factor!polygon|(}%
\index{Polygon!form factor|(}
\def\R{\v{R}}
\def\E{\v{E}}
\def\x{\v{x}}
\def\qp{\v{p}}
\def\n{\v{\hat n}}
\def\uqp{\v{\hat p}}

To derive the form factor of prisms and pyramids with polygonal bases
we start by computing the form factor
\begin{equation}\label{Eff2d}
  F(\q)=\int_A\!\d^2r\, \e^{i\q\r},
\end{equation}
of an arbitrary planar polygon of area~$A$.
The plane of the polygon has a normal~$\n$.
This induces a decomposition of any vector~$\x$ into normal
and in-plane components
\begin{equation}
  \x_\perp\coloneqq (\n\x)\x,\quad
  \x_\parallel\coloneqq\x-\x_\perp,
\end{equation}
% $\n\times\x_\perp=0$, $\n\x_\parallel=0$, $\x_\parallel\x_\perp=0$.
which allows us to rewrite~(\ref{Eff2d}) as
\nomenclature[2f134 2q040]{$F_\parallel(\q)$}{Two-dimensional form factor of planar figure}%
\begin{equation}
  F(\q)=\e^{iq_\perp r_\perp}F_\parallel(\q_\parallel)
\end{equation}
with the two-dimensional form factor
\begin{equation}
  F_\parallel(\qp)
  \coloneqq \int_A\!\d^2r_\parallel\, \e^{i\qp\r_\parallel}.
\end{equation}
In the following, we shall drop the subscript~$\parallel$
from the integration variable~$\r_\parallel$,
as we have done for the function argument $\qp\coloneqq\q_\parallel$.

Using Stokes's theorem
\begin{equation}
  \iint_A\!\d r^2\,\n\cdot\Nabla\times\v{G} = \oint_{\partial A} \d\v{r}\cdot\v{G},
\end{equation}
with $\v{G}\coloneqq\v{a}\, \e^{i\qp\r}$,
we obtain the form factor as a line integral
\begin{equation}
  F_\parallel(\qp)=\frac{\v{a}}{i\, \n(\qp\times\v{a})} \oint \d\v{r}\,\e^{i\qp\r}.
\end{equation}
With the choice $\v{a}\coloneqq\n\times\uqp_\parallel^*$,
the form factor becomes
\begin{equation}
  F_\parallel(\qp)=\frac{\n\times\uqp^*}{i\,p} \oint \d\v{r}\,\e^{i\qp\r}.
\end{equation}

The polygon shall be given by its $N$ corners $\r_0,\ldots,\r_{N-1}$.
It is convenient to abbreviate $\r_N\coloneqq\r_0$.
The edges of the polygon shall parametrized by
\begin{equation}
  \r(\lambda) = \frac{\r_{j+1}+\r_j}{2} + \frac{\r_{j+1}-\r_j}{2} \lambda
  \eqqcolon \R_j + \E_j\lambda.
\end{equation}
with $-1\le\lambda\le+1$.
The line integral takes the form
\begin{equation}
    F_\parallel(\qp)
   = \frac{\n\times\uqp^*}{ip} \sum_{j=0}^{N-1}
              \int_{-1}^{+1}\!\d\lambda\, \frac{\d\r}{\d\lambda}\,\e^{i\qp\r},
\end{equation}
and yields
\begin{equation}\label{Effpolygon}
    F_\parallel(\qp)
    = \frac{2}{ip} \sum_{j=0}^{N-1} \n(\uqp^*\times\E_j) \sinc(\qp\E_j) \e^{i\qp\R_j}.
\end{equation}
The line singularities for $\qp\perp\E_j$ having gracefully disappeared in the
sinc function,
we are left with a point singularity at $p=0$.
It is easily seen that this singularity is removable:
On expanding the term under the sum in~$\qp$,
the $\qp^0$ term vanishes because $\sum\E_j=0$.
The leading term is therefore
\begin{equation}
  \begin{array}{@{}lcl}
  F_\parallel(\qp\!\to\!0)
    &\doteq& \displaystyle 2\sum \n(\uqp^*\times\E_j) (\uqp\R_j)\\[3ex]
    &=&\displaystyle \frac{1}{2}\sum \n\left\{
        (\uqp^*\times\r_{j+1})(\uqp\r_j)
      - (\uqp^*\times\r_j)(\uqp\r_{j+1})
      \right\}\\[3ex]
    &=&\displaystyle \frac{1}{2}\sum \n(\r_j\times\r_{j+1}),
  \end{array}
\end{equation}
which is the area of the polygon
as given by a triangular tiling (with vertices at $\v{0},\r_j,\r_{j+1}$).

If the polygon has a two-fold symmetry axis,
the form factor can be further simplified.
We write $N\eqqcolon2n$
and make use of $\r_{j+n}=-\r_j$ to transform~(\ref{Effpolygon}) into
\begin{equation}\label{Eff2ngon}
    F_\parallel(\qp) = \displaystyle 4 \sum_{j=0}^{n-1}
              \n(\uqp^*\times\E_j) (\uqp\R_j) \sinc(\qp\E_j) \sinc(\qp\R_j),
\end{equation}
where even the point singularity at $p=0$ is absorbed in a sinc function.
\index{Form factor!polygon|)}%
\index{Polygon!form factor|)}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Pyramids}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Form factor!frustum|(}%
\index{Form factor!pyramid|(}%
\index{Pyramid!form factor|(}%
\index{Frustum!form factor|(}%

Quite generally, we describe particles
as being based at $z=0$ and extending up to a height~$H$.
Accordingly,
the three-dimensional form factor~(\ref{Eff3d}) is
\begin{equation}
  F(\q) = \int_0^H\!\d z\,\e^{iq_z z} F_\parallel(\q_\parallel,z)
\end{equation}
with a two-dimensional form factor~$F_\parallel(\q_\parallel,z)$
of the horizontal section at given~$z$.
If this section has constant shape at variable size,
so that it scales with some dimensionless function~$\rho(z)$,
then the two-dimensional form factor~(\ref{Eff2d})
can be written as
\begin{equation}
  F_\parallel(\q_\parallel,z)
  = {\rho(z)}^2\, F_\parallel\left(\rho(z)\q_\parallel,0\right).
\end{equation}
Depending on the geometry of the base,
its form factor can be written as a finite or infinite series
\begin{equation}
  F_\parallel(\q_\parallel,0)=\sum_j A_j \e^{i\q_\parallel \v{c}_j}.
\end{equation}
Accordingly, the three-dimensional form factor can be computed as
\begin{equation}
  F(\q) = \sum_j A_j \int_0^H\!\d z\,\rho(z)^2\e^{iq_z z} \e^{i\rho(z)\q_\parallel \v{c}_j}.
\end{equation}
We now specialize to pyramids,
for which
\begin{equation}
  \rho(z) = 1-z/H_0
\end{equation}
with a parameter $H_0\le H$.
Unless the equal sign holds,
the pyramid is a truncated one (a frustum).
The form factor becomes
\begin{equation}
  \begin{array}{@{}lcl}
  F(\q)
  &=& \displaystyle
       \e^{iq_z H_0} \sum_j A_j \int_0^H\!\d z\,\rho(z)^2\e^{i(-q_zH_0 +\q_\parallel \v{c}_j)\rho(z)}
\\[3ex]
  &=& \displaystyle
       H_0\, \e^{iq_z H_0} \sum_j A_j \int_{1-H/H_0}^1\!\d\rho\, \rho^2\e^{i(-q_zH_0 +\q_\parallel \v{c}_j)\rho}
\\[3ex]
  &=& \displaystyle
       H_0\, \e^{iq_z H_0} \sum_j A_j \Delta(i(-q_zH_0 +\q_\parallel \v{c}_j),1-H/H_0)
  \end{array}
\end{equation}
with a function
\begin{equation}\label{EDdef}
  \Delta(u,v)
  \coloneqq \int_{v}^1\!\d\rho\,\rho^2\,\e^{u\rho}.
\end{equation}
The solution
\begin{equation}
  \Delta(u,v)
  = \frac{\e^u-v^2\e^{uv}}{u}
  - 2\frac{\e^u-v\e^{uv}}{u^2}
  + 2\frac{\e^u-\e^{uv}}{u^3}
\end{equation}
has a removable singularity at $u=0$.
For small~$u$, it is therefore preferable to compute~$\Delta$
through an expansion of the exponential function in~(\ref{EDdef}),
\begin{equation}
  \Delta(u,v)
  = \sum_{k=0} \frac{u^k}{k!}\,\frac{1-v^{k+3}}{k+3}.
\end{equation}

\index{Form factor!frustum)}%
\index{Form factor!pyramid)}%
\index{Pyramid!form factor|)}%
\index{Frustum!form factor|)}%

%\Work{work in progress \ldots}
\iffalse
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Special functions near the removable singularity}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Machine epsilon}
We assume a double-precision machine epsilon
of $\epsilon=2^{-52}\simeq2.2\cdot10^{-16}$.

\fi

\index{Shape transform!computation|)}
\index{Form factor!computation|)}
