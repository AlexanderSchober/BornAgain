%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   BornAgain User Manual
%%
%%   homepage:   http://www.bornagainproject.org
%%
%%   copyright:  Forschungszentrum JÃ¼lich GmbH 2015
%%
%%   license:    Creative Commons CC-BY-SA
%%
%%   authors:    Scientific Computing Group at MLZ Garching
%%               C. Durniak, M. Ganeva, G. Pospelov, W. Van Herck, J. Wuttke
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Shape transform computations}  \label{SFFcomp}

\index{Shape transform!computation|(}
\index{Form factor!computation|(}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{It's all about removable singularities}\label{SShapeTrafIntro}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The Form factor of a hard-shell particle is simply its \E{shape transform},
as introduced in~(\ref{EFFhardshell}),
\begin{equation}\label{Eff3d}
  F(\q)=\int_V\!\d^3r\, \e^{i\q\r},
\end{equation}
where $V$ is the volume of the particle.
Here we show for a few selected cases
how to bring the analytical solution of this integral into a form
 suitable for speedy and stable computation.
This background material is of interest mostly for
developers who want to add some more form factors to \BornAgain's collection
(catalogued in App.~\ref{SFF}).

\index{Form factor!bound for absolute value}%
From~(\ref{Eff3d}), it is immediately clear that~$F(\q)$ is bounded by
\begin{equation}
  |F(\q)|\le V,
\end{equation}
with equality holding for~$\q=0$.
This excludes the presence of nonremovable singularities.
However, analytical solutions of~(\ref{Eff3d}) do contain
removable singularities.
These singularities must be investigated closely
in order to prevent floating-point errors and ill conditioned computations.

\index{Form factor!singularities}%
It seems that \E{all} analytical form factors have a singularity at~$\q=0$.
Furthermore, if the particle has \E{plane} surfaces,
then there is a singularity for all $\q$ that are normal to one of these planes.
A simple example is provided by the cuboid form factor (Sec.~\ref{SBox})
\begin{equation}\label{Eboxff}
F= L W H\exp\left(i q_z \frac{H}{2}\right) \sinc\left(q_x \frac{L}{2}\right)
\sinc\left(q_y \frac{W}{2}\right) \sinc\left(q_z \frac{H}{2}\right).
\end{equation}
If the \E{sinus cardinalis} is written as
\index{Sinus cardinalis@Sinus cardinalis (sinc)!removable singularity}
\begin{equation}\label{Esinc}
  \sinc(u) = \frac{\sin(u)}{u},
\end{equation}
then there appears to be a singularity at $u=0$.
Applying L'H\^opital's rule, it is obvious
that this singularity can be removed by the interpolated value
$\sinc(0)=1$,
as is done in the generally agreed definition of the special function~$\sinc$.

Unfortunately, other form factors are not as simple as~(\ref{Eboxff}).
Computations become more involved
if a particle has planes with normals that are not oriented along
any of the axes of the Cartesian coordinate system.
Typically then, the straightforward analytical solution of~(\ref{Eff3d})
results in messy expressions that obscure the symmetries of~$F(\q)$,
and make it difficult handle the singularities.
Instead of addressing particular geometric shapes,
we consider arbitrary polygons and polyhedra.
It turns out that these generic solutions
are easier to implement
than lengthy arithmetic expressions for specific geometries.

\iffalse
As a final preparation,
let us anticipate that we will encounter terms like
\begin{equation}\label{Eexpcancel}
  \frac{\e^u-1}{u},\text{~or~}\frac{\e^u-1-u}{u^2}.
\end{equation}
Like in~(\ref{Esinc}), the singularity at~$u=0$ is removable.
Close to the singularity, however, we must expect a loss of numeric
precision because of cancellation with the numerator.
To deal with the first of these cases, the POSIX standard
for portable computer operating system interfaces foresees a function
\begin{equation}\label{Eexpm1}
  \expmone(u)\coloneqq \e^u-1
\end{equation}
that ought to be computed to standard floating-point accuracy
even for $u\to0$.
However, POSIX does not mandate implementation for complex arguments,
so that we need to provide our own implementation.
Furthermore,
we implement
\begin{equation}\label{Eexpm1}
  \expmtwo(u)\coloneqq \e^u-1-u
\end{equation}
to deal with the second case in~(\ref{Eexpcancel}).
\fi

% TODO? another concern: integrals without numeric solution

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Polygon}\label{SFFPolygon}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Form factor!polygon|(}%
\index{Polygon!form factor|(}
\def\R{\v{R}}
\def\E{\v{E}}
\def\x{\v{x}}
\def\V{\v{V}}
\def\qp{\v{q}_\parallel}
\def\n{\v{\hat n}}
\def\uq{\v{\hat q}}
\def\uqp{\v{\hat q}_\parallel}

To derive the form factor of prisms and pyramids with polygonal bases
we need the form factor
%\nomenclature[2f134 2q040]{$F(\q)$}{Two-dimensional form factor of planar figure}%
\begin{equation}\label{Eff2d}
  F(\q,\Gamma)
  \coloneqq \int_{\Gamma}\!\d^2r\, \e^{i\q\r}
\end{equation}
of an arbitrary planar polygon~$\Gamma$,
located somewhere in affine three-dimensional Euclidean space.
The solution available from the literature~\cite{LeMi83}
contains singularities and does not provide an obvious way how handle them.
Here, a different expression shall be derived by a different method.

With the help of Stokes's theorem
\begin{equation}\label{EStokes}
  \iint\!\d r^2\,\n\cdot\Nabla\times\v{G} = \oint \d\v{r}\cdot\v{G},
\end{equation}
and with the choice $\v{G}\coloneqq\v{a}\, (\e^{i\q\r}-1)$,
we transform~(\ref{Eff2d}) into a line integral
\begin{equation}
  F(\q,\Gamma)=\frac{\v{a}}{i\, \n(\q\times\v{a})} \oint_{\partial\Gamma} \d\v{r}\,(\e^{i\q\r}-1).
\end{equation}
The normal vector~$\n$ of~$\Gamma$ induces a decomposition
\begin{equation}
  \q_\perp\coloneqq\n\q,\text{~and~}\qp\coloneqq\q-\q_\perp.
\end{equation}
For any vector~$\v{p}$, we define the absolute value
$p\coloneqq|\v{p}|=(\v{p}\v{p}^*)^{1/2}$,
and the unit vector $\v{\hat p}\coloneqq\v{p}/p$.
With the choice $\v{a}\coloneqq\n\times\qp^*$
the form factor becomes
\begin{equation}\label{Elastoint}
  F(\q,\Gamma)=\frac{\n\times\uqp^*}{i\,q_\parallel} \oint_{\partial\Gamma} \d\v{r}\,(\e^{i\q\r}-1).
\end{equation}
Let the polygon have $N$ vertices $\V_0,\ldots,\V_{N-1}$,
and put $\V_N\coloneqq\V_0$.
The edges of the polygon shall parametrized by
\begin{equation}
  \r_j(\lambda) = \frac{\V_{j+1}+\V_j}{2} + \frac{\V_{j+1}-\V_j}{2} \lambda
  \eqqcolon \R_j + \E_j\lambda.
\end{equation}
with $-1\le\lambda\le+1$.
The line integral~(\ref{Elastoint}) then takes the form
\begin{equation}
    F(\q,\Gamma)
   = \frac{\n\times\uqp^*}{iq_\parallel} \sum_{j=0}^{N-1}
              \int_{-1}^{+1}\!\d\lambda\, \frac{\d\r_j}{\d\lambda}\,(\e^{i\q\r}-1),
\end{equation}
and yields
\begin{equation}\label{Effpolygon1}
    F(\q,\Gamma)
    = \frac{\n\times\uqp^*}{iq_\parallel}
      \sum_{j=0}^{N-1} \E_j
      \left( \frac{\e^{i\q(\R_j+\E_j)}-\e^{i\q(\R_j-\E_j)}}{i\q\E_j} - 2 \right).
\end{equation}
The removable singularity for $\q\E_j=0$
can be handled by a sinc function, as discussed in Sec.~\ref{SShapeTrafIntro}.
\Emph{
\begin{equation}\label{Effpolygon3}
  F(\q,\Gamma)
  = 2\,\n\times\uqp^*
    \sum_{j=0}^{N-1} \E_j \frac{\sinc(\q\E_j) \e^{i\q\R_j} - 1}{iq_\parallel}.
\end{equation}
}
This expression is used in our implementation of \texttt{FormFactorPrism3}
(Sec.~\ref{SPrism3}).
Near the removable singularity at~$p=0$,
the scalar function of $p$, $\qp\E_j$ and $\qp\R_j$,
written as a fraction,
 is not computed term by term,
but from its series expansion.

If the polygon~$\Gamma_2$ has a two-fold symmetry axis,
then the form factor can be further simplified.
We write $N\eqqcolon2n$
and make use of $\E_{j+n}=-\E_j$ to transform~(\ref{Effpolygon3}) into
\Emph{
\begin{equation}\label{Eff2ngon}
    F(\q,\Gamma_2) = \displaystyle 4\, \n\times\uqp^*\sum_{j=0}^{n-1}
              \E_j (\uqp\R_j) \sinc(\q\E_j) \sinc(\q\R_j),
\end{equation}
}
where the singularity at $p=0$ is absorbed in a second sinc function.
This result is used in our implementation of \texttt{FormFactorPrism6}
(Sec.~\ref{SPrism6}).
\index{FormFactorPrism6@\Code{FormFactorPrism6}}%


\index{Form factor!polygon|)}%
\index{Polygon!form factor|)}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Polyhedron}\label{SFFPolyhedron}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

To derive the form factor of a polyhedron~$\Pi$,
we start from the divergence theorem
\begin{equation}
  \iiint_\Pi\!\d^3r\,\Nabla\v{H} = \iint_{\partial\Pi}\!\d^2r\, \n\v{H}.
\end{equation}
With the choice $\v{H}\coloneqq\q^*(\e^{i\q\r}-1)$,
we obtain
\begin{equation}
  F(\q) = \frac{\q^*}{iq^2} \iint_{\partial\Pi}\!\d^2r\, \n \left(\e^{i\q\r}-1\right).
\end{equation}
For a polygon, the surface integral can be written
as a sum over contributions from planar faces~$\Gamma_k$.
\begin{equation}
  F(\q) = \frac{\q^*}{iq^2} \sum_k \n_k (F_k(\q)-A_k),
\end{equation}
Each face has a normal vector~$\n_k$, an area~$A_k$,
and a two-dimensional form factor
\begin{equation}
  F_k(\q) \coloneqq \iint_{\Gamma_k}\!\d^2r\, \e^{i\q\r}.
\end{equation}
To compute~$F_k$, we use Stokes' theorem~(\ref{EStokes}) with
\begin{equation}
  \v{G}\coloneqq\n\times\uq^*(\e^{i\qp\r}-1).
\end{equation}
We obtain
\begin{equation}
  F(\q)
  = i\n \oint\!\d\r\times\left( \uqp \e^{i\qp\r} - \r/2 \right).
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Pyramids}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Form factor!frustum|(}%
\index{Form factor!pyramid|(}%
\index{Pyramid!form factor|(}%
\index{Frustum!form factor|(}%

We now consider pyramids with a polygonal base~$\Pi$.
The cross section at perpendicular coordinate~$r_\perp$
shall be written~$\rho(r_\perp)\Pi$,
with a function~$\rho$ to be specified below.
The three-dimensional form factor can be decomposed as
\begin{equation}\label{Epyr1}
  F(\q)
  = \int\!\d r_\perp\,\e^{iq_\perp r_\perp} F_\parallel(\q_\parallel,\rho(r_\perp)\Pi),
\end{equation}
with a two-dimensional form factor
\begin{equation}
  F_\parallel(\qp,\Pi) \coloneqq \int_\Pi\!\d^2r\,\e^{i\qp\r}
\end{equation}
that scales as
\begin{equation}
  F_\parallel(\qp,\rho\Pi) = \rho^2 F_\parallel(\rho\qp,\Pi).
\end{equation}
From~(\ref{Effpolygon_expsum}) we know that~$F_\parallel$ can be written as
\begin{equation}
  F_\parallel(\qp,\Pi)=p^{-2}\sum_j b_j\, \e^{i\qp \V_j}.
\end{equation}
Accordingly, the three-dimen\-sional form factor~(\ref{Epyr1})~is
\begin{equation}
  \begin{array}{@{}lcl}
  F(\q)
  &=& \displaystyle
       \int\!\d r_\perp\,\e^{iq_\perp r_\perp}\,\rho(r_\perp)^2 F_\parallel(\rho(r_\perp)\q_\parallel,\Pi)
\\[3ex]
  &=& \displaystyle
      q_\parallel^{-2}  \sum_j b_j
      \int\!\d r_\perp\,\e^{i(q_\perp r_\perp+\q_\parallel \V_j\rho(r_\perp))}.
  \end{array}
\end{equation}
We now assume that the pyramid is based at $r_\perp=0$,
and extends up to a height~$H$.
The function~$\rho$ is then
\begin{equation}
  \rho(r_\perp) = 1-r_\perp/H_0
\end{equation}
with a parameter $H_0\le H$.
Unless the equal sign holds,
the pyramid is a truncated one (a frustum).
It is convenient to express~$H$ through
a dimensionless truncation parameter~$\eta\coloneqq H/H_0$.
The form factor thence becomes
\begin{equation}
  \begin{array}{@{}lcl}
  F(\q)
  &=& \displaystyle
      q_\parallel^{-2}  \sum_j b_j \e^{i\q_\parallel \V_j}
      \int_0^{H_0\eta}\!\d r_\perp\,\e^{i(q_\perp-\q_\parallel \V_j/H_0)r_\perp}
\\[3ex]
  &=& \displaystyle
       q_\parallel^{-2} H_0\, \sum_j b_j
          \frac{\e^{i\left(q_\perp H_0-\q_\parallel\V_j\right)\eta}-1}
               {i\left(q_\perp H_0 - \q_\parallel\V_j\right)}
               \e^{i\q_\parallel \V_j}.
  \end{array}
\end{equation}
Delegating the handling of the removable singularity at~$q_\perp H_0=\q_\parallel\V_j$
to the sinc function,
we write it as
\Emph{
\begin{equation}
  F(\q)
  = q_\parallel^{-2} H_0\, \e^{iq_\perp H_0/2} \sum_{j=0}^{N-1} b_j
    \sinc\left((q_\perp H_0 - \q_\parallel\V_j)\frac{\eta}{2}\right)
     \e^{i\q_\parallel\V_j(1-\eta/2)}.
\end{equation}
}
If the polygonal base has two-fold symmetry, we proceed as for~(\ref{Eff2ngon})
to obtain
\Emph{
\begin{equation}
  F(\q)
  = \frac{2i}{q_\parallel}H_0(1-\frac{\eta}{2})\, \e^{iq_\perp H_0/2}
    \sum_{j=0}^{n-1} b_j \v{\hat q}_\parallel\V_j
    \sinc\left((q_\perp H_0 - \q_\parallel\V_j)\frac{\eta}{2}\right)
     \sinc\left(\q_\parallel\V_j\left(1-\frac{\eta}{2}\right)\right).
\end{equation}
}

\index{Form factor!frustum)}%
\index{Form factor!pyramid)}%
\index{Pyramid!form factor|)}%
\index{Frustum!form factor|)}%

%\Work{work in progress \ldots}
\iffalse
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Special functions near the removable singularity}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Machine epsilon}
We assume a double-precision machine epsilon
of $\epsilon=2^{-52}\simeq2.2\cdot10^{-16}$.

\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{TODO: remove UNUSED}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The leading nonvanishing term is
\begin{equation}
  \begin{array}{@{}lcl}
  F_\parallel(\qp\!\to\!0)
    &\doteq& \displaystyle 2\sum \n(\uqp^*\times\E_j) (\uqp\R_j)\\[3ex]
    &=&\displaystyle \frac{1}{2}\sum \n\left\{
        (\uqp^*\times\V_{j+1})(\uqp\V_j)
      - (\uqp^*\times\V_j)(\uqp\V_{j+1})
      \right\}\\[3ex]
    &=&\displaystyle \frac{1}{2}\sum \n(\V_j\times\V_{j+1}),
  \end{array}
\end{equation}
which is the area of the polygon
as given by a triangular tiling (with vertices at $\v{0},\V_j,\V_{j+1}$).


\index{Shape transform!computation|)}
\index{Form factor!computation|)}
