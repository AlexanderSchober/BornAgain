%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   BornAgain User Manual
%%
%%   homepage:   http://www.bornagainproject.org
%%
%%   copyright:  Forschungszentrum JÃ¼lich GmbH 2015
%%
%%   license:    Creative Commons CC-BY-SA
%%
%%   authors:    Scientific Computing Group at MLZ Garching
%%               C. Durniak, M. Ganeva, G. Pospelov, W. Van Herck, J. Wuttke
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Shape transform computations}  \label{SFFcomp}

\index{Shape transform!computation|(}
\index{Form factor!computation|(}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}\label{SShapeTrafIntro}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The Form factor of a hard-shell particle is simply its \E{shape transform},
as introduced in~(\ref{EFFhardshell}),
\begin{equation}\label{Eff3d}
  F(\q)=\int_V\!\d^3r\, \e^{i\q\r},
\end{equation}
where $V$ is the volume of the particle.
Here we show for a few selected cases
how to bring the analytical solution of this integral into a form
 suitable for speedy and stable computation.
This background material is of interest mostly for
developers who want to add some more form factors to \BornAgain's collection
(catalogued in App.~\ref{SFF}).

\index{Form factor!bound for absolute value}%
From~(\ref{Eff3d}), it is immediately clear that~$F(\q)$ is bounded by
\begin{equation}
  |F(\q)|\le V,
\end{equation}
with equality holding for~$\q=0$.
This excludes the presence of nonremovable singularities.
However, analytical solutions of~(\ref{Eff3d}) do contain
removable singularities.
These singularities must be investigated closely
in order to prevent floating-point errors and ill conditioned computations.

\index{Form factor!singularities}%
It seems that \E{all} analytical form factors have a singularity at~$\q=0$.
Furthermore, if the particle has \E{plane} surfaces,
then there is a singularity for all $\q$ that are normal to one of these planes.
A simple example is provided by the cuboid form factor (Sec.~\ref{SBox})
\begin{equation}
F= L W H\exp\left(i q_z \frac{H}{2}\right) \sinc\left(q_x \frac{L}{2}\right)
\sinc\left(q_y \frac{W}{2}\right) \sinc\left(q_z \frac{H}{2}\right).
\end{equation}
If the \E{sinus cardinalis} is written as
\index{Sinus cardinalis@Sinus cardinalis (sinc)!removable singularity}
\begin{equation}
  \sinc(u) = \frac{\sin(u)}{u},
\end{equation}
then there appears to be a singularity at $u=0$.
Applying L'H\^opital's rule, it is obvious
that this singularity can be removed by the interpolated value
$\sinc(0)=1$,
as is done in the generally agreed definition of the special function~$\sinc$.

While all this is clear and easy,
computations become more involved
if a particle has planes with normals that are not oriented along
any of the axes of the Cartesian coordinate system.
Typically then, the straightforward analytical solution of~(\ref{Eff3d})
results in messy expressions that obscure the symmetries of~$F(\q)$,
and make it difficult to recognize the singularities and
to remove them.
Therefore we shall consider a few such cases more closely.

% TODO? another concern: integrals without numeric solution

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Polygon}\label{SFFPolygon}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Form factor!polygon|(}%
\index{Polygon!form factor|(}
\def\R{\v{R}}
\def\E{\v{E}}
\def\x{\v{x}}
\def\V{\v{V}}
\def\qp{\v{p}}
\def\n{\v{\hat n}}
\def\uqp{\v{\hat p}}

To derive the form factor of prisms and pyramids with polygonal bases
we need the form factor of an arbitrary planar polygon~$\Pi$.
The solution is known from the literature~\cite{LeMi83},
but shall be derived here by a different method.
The plane of the polygon has a normal~$\n$,
which induces a decomposition of any vector~$\x$ into normal
and in-plane components
\begin{equation}
  \x_\perp\coloneqq (\n\x)\x,\quad
  \x_\parallel\coloneqq\x-\x_\perp.
\end{equation}
Position vectors~$\r$ in the polygon's plane obey~$\r\n=r_\perp$.
Accordingly, the form factor of the affine polygon~$\r_\perp+\Pi$
can be written as
\nomenclature[2f134 2q040]{$F_\parallel(\q)$}{Two-dimensional form factor of planar figure}%
\begin{equation}\label{Eff2d}
  F(\q)
  = \int_{\r_\perp+\Pi}\!\d^2r\, \e^{i\q\r}
  =\e^{iq_\perp r_\perp} \int_{\Pi}\!\d^2r\, \e^{i\q_\parallel\r}
  \eqqcolon \e^{iq_\perp r_\perp} F_\parallel(\q_\parallel).
\end{equation}
The two-dimensional form factor~$F_\parallel$
can be transformed with the help of Stokes's theorem
\begin{equation}
  \iint\!\d r^2\,\n\cdot\Nabla\times\v{G} = \oint \d\v{r}\cdot\v{G},
\end{equation}
and with the choice $\v{G}\coloneqq\v{a}\, \e^{i\qp\r}$, $\qp\coloneqq\q_\parallel$,
into a line integral
\begin{equation}
  F_\parallel(\qp)=\frac{\v{a}}{i\, \n(\qp\times\v{a})} \oint_{\partial\Pi} \d\v{r}\,\e^{i\qp\r}.
\end{equation}
With the further choice $\v{a}\coloneqq\n\times\uqp^*$
and the notations $p\coloneqq|\qp|=(\qp\qp^*)^{1/2}$, $\uqp\coloneqq\qp/p$,
this becomes
\begin{equation}\label{Elastoint}
  F_\parallel(\qp)=\frac{\n\times\uqp^*}{i\,p} \oint \d\v{r}\,\e^{i\qp\r}.
\end{equation}
Let the polygon have $N$ vertices $\V_0,\ldots,\V_{N-1}$,
and put $\V_N\coloneqq\V_0$.
The edges of the polygon shall parametrized by
\begin{equation}
  \r_j(\lambda) = \frac{\V_{j+1}+\V_j}{2} + \frac{\V_{j+1}-\V_j}{2} \lambda
  \eqqcolon \R_j + \E_j\lambda.
\end{equation}
with $-1\le\lambda\le+1$.
The line integral~(\ref{Elastoint}) then takes the form
\begin{equation}
    F_\parallel(\qp)
   = \frac{\n\times\uqp^*}{ip} \sum_{j=0}^{N-1}
              \int_{-1}^{+1}\!\d\lambda\, \frac{\d\r_j}{\d\lambda}\,\e^{i\qp\r},
\end{equation}
and yields
\Emph{
\begin{equation}\label{Effpolygon}
    F_\parallel(\qp)
    = \frac{2\n\times\uqp^*}{ip} \sum_{j=0}^{N-1} \E_j \sinc(\qp\E_j) \e^{i\qp\R_j}.
\end{equation}
}
The removable singularity for $\q_\parallel\E_j=0$
is handled by the sinc function, as discussed in Sec.~\ref{SShapeTrafIntro}.
Furthermore, there is a singularity at $q_\parallel=0$.
To see that it is removable,
expand the term under the sum in~$\qp$,
and use $\sum\E_j=0$.
The leading nonvanishing term is
\begin{equation}
  \begin{array}{@{}lcl}
  F_\parallel(\qp\!\to\!0)
    &\doteq& \displaystyle 2\sum \n(\uqp^*\times\E_j) (\uqp\R_j)\\[3ex]
    &=&\displaystyle \frac{1}{2}\sum \n\left\{
        (\uqp^*\times\V_{j+1})(\uqp\V_j)
      - (\uqp^*\times\V_j)(\uqp\V_{j+1})
      \right\}\\[3ex]
    &=&\displaystyle \frac{1}{2}\sum \n(\V_j\times\V_{j+1}),
  \end{array}
\end{equation}
which is the area of the polygon
as given by a triangular tiling (with vertices at $\v{0},\V_j,\V_{j+1}$).

Later, when computing the form factor of pyramids,
we will need to express $F_\parallel$ as a straightforward sum
of exponentials,
\begin{equation}\label{Eff_as_sum}
  F_\parallel(\qp)=p^{-2}\sum_j b_j \e^{i\qp \V_j}.
\end{equation}
For this purpose,
we spell out~(\ref{Effpolygon}) as
\begin{equation}
    F_\parallel(\qp)
    = \frac{\n\times\uqp^*}{p} \sum_{j} \frac{\E_j}{\qp\E_j}
       \left(\e^{i\qp\V_j}-\e^{i\qp\V_{j+1}}\right).
\end{equation}
Rearranging terms and permuting indices,
we convert the sum over edges into a sum over vertices,
\Emph{
\begin{equation}\label{Effpolygon_expsum}
    F_\parallel(\qp)
    = \frac{\n\times\uqp^*}{p^2} \sum_{j=0}^{N-1}
       \left( \frac{\E_{j-1}}{\uqp\E_{j-1}} - \frac{\E_j}{\uqp\E_j} \right)
       \e^{i\qp\V_j},
\end{equation}
}
which has the desired form~(\ref{Eff_as_sum}).
If the two fractions in the parenthesis are brought onto a common denominator,
full accord with Eq.~6 of Ref.~\cite{LeMi83} is achieved.
Comparison with~(\ref{Eff_as_sum}) yields the coefficient
\begin{equation}
  b_j = (\n\times\uqp^*)\left( \frac{\E_{j-1}}{\uqp\E_{j-1}} - \frac{\E_j}{\uqp\E_j} \right).
\end{equation}
We know from above, or verify directly, that the first two terms in the
expansion of $\e^{i\qp\V_j}$ contribute nothing:
\begin{equation}
  \sum_j b_j = 0,\quad
  \sum b_j (\qp \V_j) = 0.
\end{equation}

If the polygon has a two-fold symmetry axis,
then the form factor can be further simplified.
We write $N\eqqcolon2n$
and make use of $\V_{j+n}=-\V_j$ to transform~(\ref{Effpolygon}) into
\Emph{
\begin{equation}\label{Eff2ngon}
    F_\parallel(\qp) = \displaystyle 4 \sum_{j=0}^{n-1}
              \n(\uqp^*\times\E_j) (\uqp\R_j) \sinc(\qp\E_j) \sinc(\qp\R_j),
\end{equation}
}
where the singularity at $p=0$ is absorbed in a second sinc function.
This result is used in our implementation of \texttt{FormFactorPrism6}
(Sec.~\ref{SPrism6}).
\index{FormFactorPrism6@\Code{FormFactorPrism6}}%

\index{Form factor!polygon|)}%
\index{Polygon!form factor|)}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Pyramids}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Form factor!frustum|(}%
\index{Form factor!pyramid|(}%
\index{Pyramid!form factor|(}%
\index{Frustum!form factor|(}%

We now consider pyramids with a polygonal base~$\Pi$.
The cross section at perpendicular coordinate~$r_\perp$
shall be written~$\rho(r_\perp)\Pi$,
with a function~$\rho$ to be specified below.
The three-dimensional form factor can be decomposed as
\begin{equation}\label{Epyr1}
  F(\q)
  = \int\!\d r_\perp\,\e^{iq_\perp r_\perp} F_\parallel(\q_\parallel,\rho(r_\perp)\Pi),
\end{equation}
with a two-dimensional form factor
\begin{equation}
  F_\parallel(\qp,\Pi) \coloneqq \int_\Pi\!\d^2r\,\e^{i\qp\r}
\end{equation}
that scales as
\begin{equation}
  F_\parallel(\qp,\rho\Pi) = \rho^2 F_\parallel(\rho\qp,\Pi).
\end{equation}
From~(\ref{Effpolygon_expsum}) we know that~$F_\parallel$ can be written as
\begin{equation}
  F_\parallel(\qp,\Pi)=p^{-2}\sum_j b_j\, \e^{i\qp \V_j}.
\end{equation}
Accordingly, the three-dimen\-sional form factor~(\ref{Epyr1})~is
\begin{equation}
  \begin{array}{@{}lcl}
  F(\q)
  &=& \displaystyle
       \int\!\d r_\perp\,\e^{iq_\perp r_\perp}\,\rho(r_\perp)^2 F_\parallel(\rho(r_\perp)\q_\parallel,\Pi)
\\[3ex]
  &=& \displaystyle
      q_\parallel^{-2}  \sum_j b_j
      \int\!\d r_\perp\,\e^{i(q_\perp r_\perp+\q_\parallel \V_j\rho(r_\perp))}.
  \end{array}
\end{equation}
We now assume that the pyramid is based at $r_\perp=0$,
and extends up to a height~$H$.
The function~$\rho$ is then
\begin{equation}
  \rho(r_\perp) = 1-r_\perp/H_0
\end{equation}
with a parameter $H_0\le H$.
Unless the equal sign holds,
the pyramid is a truncated one (a frustum).
It is convenient to express~$H$ through
a dimensionless truncation parameter~$\eta\coloneqq H/H_0$.
The form factor thence becomes 
\begin{equation}
  \begin{array}{@{}lcl}
  F(\q)
  &=& \displaystyle
      q_\parallel^{-2}  \sum_j b_j \e^{i\q_\parallel \V_j}
      \int_0^{H_0\eta}\!\d r_\perp\,\e^{i(q_\perp-\q_\parallel \V_j/H_0)r_\perp}
\\[3ex]
  &=& \displaystyle
       q_\parallel^{-2} H_0\, \sum_j b_j  
          \frac{\e^{i\left(q_\perp H_0-\q_\parallel\V_j\right)\eta}-1}
               {i\left(q_\perp H_0 - \q_\parallel\V_j\right)}
               \e^{i\q_\parallel \V_j}.
  \end{array}
\end{equation}
Delegating the handling of the removable singularity at~$q_\perp H_0=\q_\parallel\V_j$
to the sinc function,
we write it as
\Emph{
\begin{equation}
  F(\q)
  = q_\parallel^{-2} H_0\, \e^{iq_\perp H_0/2} \sum_{j=0}^{N-1} b_j
    \sinc\left((q_\perp H_0 - \q_\parallel\V_j)\frac{\eta}{2}\right)
     \e^{i\q_\parallel\V_j(1-\eta/2)}.
\end{equation}
}
If the polygonal base has two-fold symmetry, we proceed as for~(\ref{Eff2ngon})
to obtain
\Emph{
\begin{equation}
  F(\q)
  = \frac{2i}{q_\parallel}H_0(1-\frac{\eta}{2})\, \e^{iq_\perp H_0/2}
    \sum_{j=0}^{n-1} b_j \v{\hat q}_\parallel\V_j
    \sinc\left((q_\perp H_0 - \q_\parallel\V_j)\frac{\eta}{2}\right)
     \sinc\left(\q_\parallel\V_j\left(1-\frac{\eta}{2}\right)\right).
\end{equation}
}

\index{Form factor!frustum)}%
\index{Form factor!pyramid)}%
\index{Pyramid!form factor|)}%
\index{Frustum!form factor|)}%

%\Work{work in progress \ldots}
\iffalse
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Special functions near the removable singularity}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Machine epsilon}
We assume a double-precision machine epsilon
of $\epsilon=2^{-52}\simeq2.2\cdot10^{-16}$.

\fi

\index{Shape transform!computation|)}
\index{Form factor!computation|)}
