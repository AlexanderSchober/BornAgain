%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   BornAgain User Manual
%%
%%   homepage:   http://www.bornagainproject.org
%%
%%   copyright:  Forschungszentrum JÃ¼lich GmbH 2015
%%
%%   license:    Creative Commons CC-BY-SA
%%   
%%   authors:    Scientific Computing Group at MLZ Garching
%%               C. Durniak, M. Ganeva, G. Pospelov, W. Van Herck, J. Wuttke
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{DWBA for multilayer systems}  \label{sec:Multilayers}


\index{Multilayer|(}%
\index{Layer structures|see {Multilayer}}

In Sect.~\ref{Sdwba},
we have discussed wave propagation and scattering in 2$+$1 dimensional systems
that are translationally invariant in the horizontal $xy$ plane,
and have a vertical refractive index profile $\nz(z)$.
Here we specialize to layered systems
where $\nz(z)$ is a step function that is constant within one layer.
First, only scalar interactions are considered.
Later, the theory is extended to account for polarization effects.

\Note{\indent By convention,
layers are numbered from top to bottom.
The top vacuum (or air) layer (which extends to $z\to+\infty$) has number~0,
the substrate (extending to $z\to-\infty$) is layer~$N$.}

All layer interfaces are assumed to be perfectly smooth.
For rough interfaces, see Chapter~\ref{sec:Roughness}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Scalar case}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%===============================================================================
\subsection{Wave propagation}
%===============================================================================

\index{Multilayer!Indexing convention}%

We consider wave propagation in one layer~$j$
\nomenclature[2j020]{$j$}{Index of layer in multilayer sample}%
with constant average refractive index $\nz(z)=\nzj$.
A vacuum plane wave, impinging on a layered structure,
is at each interface partly reflected, partly refracted,
so that the wave function inside a material layer
has an upward and a downward propagating component,
as per~(\ref{Epsipm}).
Each component is a plane wave,
\begin{equation}
  \psi^\pm_{wj}(\r)=A^\pm_{wj}\e^{i\k^\pm_{wj}\r}.
\end{equation}
\nomenclature[2a123 2w010 2j010 \pm]{$A^\pm_{wj}$}{Amplitude of the plane wave $\Psi^\pm_{wj}(\r)$}%
Here and in the following,
the index~$w$ can take the values i and~f.
The amplitudes $A$ are often written with distinct letters
T and~R to designate the transmitted or reflected beam,
\begin{equation}
  T_{wj} := A^-_{wj},\quad
  R_{wj} := A^+_{wj}.
\end{equation}
\nomenclature[2t126 2w020 2j020 0]{$T_{wj}$}{Partial amplitude of $\psi_w(\r)$
  in layer $j$ in downward (transmission) direction, also denoted $A^-_{wj}$}%
\nomenclature[2r126 2w020 2j020 0]{$R_{wj}$}{Partial amplitude of $\psi_w(\r)$
  in layer $j$ in upward (reflection) direction, also denoted $A^+_{wj}$}%
The wave vector can be decomposed as
\begin{equation}
  \k^\pm_{wj}= \k_{\parallel w} \pm k_{\perp wj}\v{\hat z}.
\end{equation}
\nomenclature[2z060]{$\v{\hat z}$}{Unit vector along the sample normal}%
\nomenclature[2k043 2w010 2j010 \pm]{$\k^\pm_{wj}$}{Wave vector of the plane wave $\Psi^\pm_{wj}(\r)$}%
As explained in connection with~(\ref{Ekpar}),
the in-plane wave vector $\k_{\parallel w}$ remains constant
across layer interfaces.
The vertical wavenumber is obtained from (\ref{Ewavez}),
\begin{equation}
  k_{\perp wj} = \sqrt{K^2 \nzj - k_{\parallel w}^2}.
\end{equation}
The glancing angle is
\begin{equation}\label{Edef_alpha}
  \alpha_j:=\arctan(k_{\perp i}/k_\parallel).  
\end{equation}
Equivalently,
\begin{equation}
  k_\parallel=K n_j \cos\alpha_j. 
\end{equation}
Since $k_\parallel$ is constant across layers,
we have
\begin{equation}\label{ESnell}
  n_j \cos\alpha_j = \text{the same for all }j,
\end{equation}
which is Snell's refraction law.
\index{Refraction!Snell's law}
\index{Snell's law}

%-------------------------------------------------------------------------------
\subsection{Wave propagation across layers}
%-------------------------------------------------------------------------------

\index{Fresnel coefficients}%
\index{Transmission|see {Fresnel coefficients}}%
\index{Reflection|seealso {Fresnel coefficients}}%

At interfaces between layers,
the wave function $\psi(\r)$ and its first derivative
$\Nabla\psi(\r)$ must evolve continuously.


In this section,
the continuity of $\psi(z)$ and $\partial_z\psi(z)$ at layer interfaces
is used to derive a recursion rule
for the coefficients $a_j$ and $b_j$ of (\ref{Epsiz}).
At the \textit{bottom} interface of layer~$j=0,\ldots,N-1$,
continuity requires
\begin{equation}\label{Econtcond}
  \begin{array}{lcl}
            \psi_j(z_j)&=&\psi_{j+1}(z_{j+1}+d_{j+1}),\\
            \partial_z\psi_j(z_j)&=&\partial_z\psi_{j+1}(z_{j+1}+d_{j+1}),
  \end{array}
\end{equation}
  where
\begin{equation}
  d_j:=z_{j-1}-z_{j}
\end{equation}
is the thickness of layer~$j$.
With the solution (\ref{Epsiz}), conditions (\ref{Econtcond}) become
\begin{equation}\label{Econt2}
  \begin{array}{lclclcl}
  a_j &+& b_j,
  &=&
  a_{j+1}\e^{iKf_{j+1}d_{j+1}} &+& b_{j+1}\e^{-iKf_{j+1}d_{j+1}},
  \\
  a_j f_j  &-& b_j f_j,
  &=&
 a_{j+1}\e^{iKf_{j+1}d_{j+1}} f_{j+1} &-& b_{j+1}\e^{-iKf_{j+1}d_{j+1}} f_{j+1}.
  \end{array}
\end{equation}
We introduce the vector notation
\begin{equation}\label{Evecc}
  c_j := \left( \begin{array}{c}a_j\\b_j\end{array} \right),
\end{equation}
to write (\ref{Econt2}) as
\begin{equation}\label{EFcFDc}
  F_j c_j = F_{j+1} D_{j+1} c_{j+1}
\end{equation}
with the matrices
\begin{equation}
  F_j := \left(\begin{array}{cc}1&1\\f_j&-f_j\end{array}\right)\text{, and }
  D_j := \left(\begin{array}{cc}\delta_j&0\\0&\delta_j^*\end{array}\right),
\end{equation}
and the phase factor
\begin{equation}
   \delta_j := \e^{iKf_jd_j}.
\end{equation}
We define the transfer matrix
\begin{equation}\label{Edef_M}
  M_j
  := F_{j-1}^{-1}F_j D_j,
\end{equation}
to obtain the recursion 
\begin{equation}\label{EcMc}
  c_j = M_{j+1} c_{j+1}.
\end{equation}
Straightforward computation yields
\begin{equation}
  M_j
   = \frac{1}{2f_{j-1}}
   \left(\begin{array}{cc}
       \delta_j(f_{j-1}+f_j)&\delta_j^*(f_{j-1}-f_j)\\
       \delta_j(f_{j-1}-f_j)&\delta_j^*(f_{j-1}+f_j)
   \end{array}\right)
   = \frac{1}{2}
   \left(\begin{array}{cc}
       \delta_j(1+\rho_j)&\delta_j^*(1-\rho_j)\\
       \delta_j(1-\rho_j)&\delta_j^*(1+\rho_j)
   \end{array}\right)
\end{equation}
with the ratio
\begin{equation}
  \rho_j := \frac{f_j}{f_{j-1}}.
\end{equation}
The recursion starts from the semi-infinite substrate layer~$N$
where there is no upwards propagating wave, hence $a_N=0$.
For layer~$i$, the solution is
\begin{equation}\label{Eci}
  c_j
  =
  M_{j+1}.... M_{N} c_N.  % TODO restore \cdots
\end{equation}

%-------------------------------------------------------------------------------
\subsection{Currents}
%-------------------------------------------------------------------------------

Currents shall be computed in relative units as
\begin{equation}
  \v{J}:=\psi^*(\r)\frac{\Nabla}{2i}\psi(\r)+\text{c.c.}
\end{equation}
We are interested in the component $J_z$.
With (\ref{Epsiz}),
we obtain in layer~$i$
\begin{equation}\label{EJperp}
  \begin{array}{lcl}
  J_{zi} &=& \frac{1}{2}
  \left( a_j^*\e^{-ik_{\perp i}(z-z_j)} + b_j^*\e^{ik_{\perp i}(z-z_j)} \right)
  k_{\perp i}
  \left( a_j\e^{ik_{\perp i}(z-z_j)} - b_j\e^{-ik_{\perp i}(z-z_j)} \right)
  +\text{c.c.}\\[2ex]
  &=& \left( |a_j|^2 - |b_j|^2 \right) K f_j,
  \end{array}
\end{equation}
provided $k_{\perp i}$ is real.
Obviously,
the $|a_j|^2$ term is due to the upward beam
and the $|b_j|^2$ term to the downward beam.

In the absence of absorption we expect that the net current
is the same in all layers.
We verify this as follows.
Using the vector notation~(\ref{Evecc}),
we write~(\ref{EJperp}) as a sesquilinear form
\begin{equation}
  J_{zi}
  = c_j^\dagger \left(\begin{array}{cc}Kf_j&0\\0&-Kf_j\end{array}\right) c_j.
\end{equation}
Using the recursion (\ref{EcMc}) for $c_j$,
we obtain a recursion for $J_{zi}$:
\begin{equation}\label{EJrec}
  \begin{array}{lcl}
    J_{zi} &=&
    c_j^\dagger
    \left(\begin{array}{cc}Kf_j&0\\0&-Kf_j\end{array}\right) c_j
    \\[3ex]
    &=&
    c_{j+1}^\dagger M_{j+1}^\dagger
    \left(\begin{array}{cc}Kf_j&0\\0&-Kf_j\end{array}\right)
    M_{j+1}c_{j+1}
    \\[3ex]
    &=&
    c_{j+1}^\dagger
    \left(\begin{array}{cc}Kf_{j+1}&0\\0&-Kf_{j+1}\end{array}\right)
    c_{j+1}
    \\[3ex]
    &=&
    J_{z,j+1},
  \end{array}
\end{equation}
which means that the net current is constant.

For a single interface between two semi-infinite media,
wave amplitudes are related by
\begin{equation}
    \left(\begin{array}{c}a_0\\b_0\end{array}\right)
  = M_1
    \left(\begin{array}{c}0\\b_1\end{array}\right)
  = \frac{\delta_1^* b_1}{2 f_0}
    \left(\begin{array}{c}f_0-f_1\\f_0+f_1\end{array}\right).
\end{equation}
The reflectivity of the interface is
\begin{equation}\label{ER01}
  R={\left|\frac{a_0}{b_0}\right|}^2
   ={\left|\frac{f_0-f_1}{f_0+f_1}\right|}^2,
\end{equation}
which agrees with Fresnel's result for $s$-polarized light.


%-------------------------------------------------------------------------------
\subsection{Damped waves in absorbing media
  or under total reflection conditions}\label{s:complex}
%-------------------------------------------------------------------------------

If layer~$i$ absorbs radiation,
its index of refraction $n_j$ has a positive imaginary component.
By~(\ref{Edisp}),
$k_\parallel^2+k_{\perp i}^2$ then also has a positive imaginary component.
From the continuity of $\psi$ and $\Nabla\psi$ across layer interfaces
it still follows that $\k_\parallel$ is constant.
We assume that the top layer~0 is not absorbing.
Hence $\k_\parallel$ is real.
To fulfill~(\ref{Edisp}),
it is necessary that $k_{\perp i}$
has a positive imaginary component.
In consequence,
the intensities of the forward and backward travelling beams (\ref{Epsiz})
decrease exponentially in~$\pm z$.

Snell's law of refraction (\ref{ESnell})
cannot be fulfilled if
\begin{equation}\label{Etotrefcond}
  n_j<n_0\cos\alpha_0.  
\end{equation}
In this case, total reflection occurs at the top interface of layer~$i$,
accompanied by an evanescent wave within layer~$i$.
Strictly speaking,
total reflection is only possible if layer~$i$ is not absorbing.
Otherwise, some intensity would be dissipated by the evanescent wave,
and the reflection would not be total.
Also, the unequality~(\ref{Etotrefcond}) is undefined
if $n_j$ has an imaginary component.

We abbreviate
\begin{equation}\label{Edef_f}
f_j := \sqrt{ n_j^2 - n_0^2 \cos^2\alpha_0 },
\end{equation}
which is a combination of material parameters ($n_0$, $n_j$)
and a geometric parameter ($\alpha_0$) that describes the incident beam.
If $n_j$ is real, and the argument of the square root nonnegative,
we simply have $f_j=n_j\sin\alpha_j$.
However, using $f_j$ allows for later generalizations
to cope with absorbing media or with total reflection and evanescent waves.
The wave number in (\ref{Epsiz}) can now be written as
\begin{equation}\label{EkKf}
  k_{\perp i} = K f_j.
\end{equation}

With definition~(\ref{Edef_f}),
total reflection occurs if $f_j$ is a pure imaginary number.
For an absorbing medium, $f_j$ has a positive imaginary part
and a non-zero real part.
Therefore it is appropriate to treat total reflection as a special
case of refraction by a medium with complex~$f_j$.

For complex $f_j$,
the theory developed above
remains applicable, with the following exceptions:
The geometric interpretation of the wave vectors $\k_\pm$
in Eqs.~(\ref{Edef_alpha}--\ref{ESnell}) is untenable,
and the computation of currents in
Eqs.~(\ref{EJperp}--\ref{EJrec}) is invalid because it
relies on $\Im k_{\perp i}=0$.


%-------------------------------------------------------------------------------
\subsection{Numerical considerations}
%-------------------------------------------------------------------------------

...

%-------------------------------------------------------------------------------
\subsection{Scattering}
%-------------------------------------------------------------------------------
Restricting (\ref{EBornQ}) to one layer,
the Fourier transform
of the perturbative potential~(\ref{EChiGraded})
shall be written as
\begin{equation}\label{Echij}
  \chi_j(\v{q})
  := \int_{z\in\mathcal{Z}_j}\!\d^3r\, \e^{i\v{q}\,\r}\chi(\r).
\end{equation}
\nomenclature[1Ï032 2j010 2q040]{$\chi_j(\v{q})$}{Fourier transform of the perturbation potential $\chi(\r)$, evaluated in one sample layer}%
We can then write the DWBA transition matrix~(\ref{EtmDWBAsum}) as
a sum over all layers,
\index{Distorted-wave Born approximation!multilayer}%
\Emph{
\begin{equation}\label{EtmDWBAft}
  \bra \Psi_\tf|\chi|\Psi_\ti\ket
  = \sum_{j} \sum_{\pm_\tf} \sum_{\pm_\ti}
    A^\pm_{\ti j} A^{\pm *}_{\tf j}
     \chi_j(\k^\pm_{\ti j} - \k^\pm_{\tf j}).
\end{equation}\vspace*{-5pt}
}
where
$\mathcal{Z}_j$ denotes an interval on the vertical coordinate axis.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Reflection with polarization-dependent interactions}\label{s:pol}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\cite{Deak_ppt, PhysRevB.76.224420, Deak2001113, PhysRevB.53.6158}.
%\cite{RevModPhys.23.287}

%-------------------------------------------------------------------------------
\subsection{Wave equation and propagation within one layer}
%-------------------------------------------------------------------------------

To allow for polarization-dependent interactions,
we replace the squared index of refraction $n^2$
by $1+\uu\chi$, where $\uu\chi$ is a $2\times 2$ susceptibility matrix.
The wave equation (\ref{Escalar_wave}) for layer~$j$ becomes
\begin{equation}\label{Ewaveqp}  
(\Delta +K^2 +K^2 \uu\chi_j) \u\psi(\r)= 0,
\end{equation}
where $\u\psi(\r)$ is a two-component spinor wave function,
with components $\psi_\UP(\r)$ and~$\psi_\DN(\r)$.
At interfaces between layers,
both spinor components of $\u\psi(\r)$ and $\Nabla\u\psi(\r)$
must evolve continuously.

The reasons for the factorization (\ref{Ewave3}) still apply,
and so we can write
\begin{equation}\label{Ewave3p}
\u\psi(\r) = \u\psi(z) \e^{i \k_\parallel\r_\parallel}.
\end{equation}
As before, $\k_\parallel$ is constant across layers.
The wave equation~(\ref{Ewaveqp}) reduces to 
\begin{equation}\label{Ewavezp}
\left(\partial_z^2 + K^2 + K^2\uu\chi_j - k_\parallel^2 \right) \u\psi(z) = 0.
\end{equation}
We abbreviate
\begin{equation}
  \uu H_j := K^2(1+\uu\chi_j)-k_\parallel^2
\end{equation}
so that the wave equation becomes simply
\begin{equation}\label{Ewaveqp2}
  \left(\partial_z^2 + \uu H_j\right) \u\psi(z) = 0.
\end{equation}
The solution is
\begin{equation}\label{Epsizp}
  \u\psi_j(z)
  = \sum_{k=1}^2 \u x_{jk}\left(\alpha_{jk}\e^{i p_{jk}(z-z_k)}
                            + \beta_{jk}\e^{-i p_{jk}(z-z_k)}\right),
\end{equation}
where the $\u x_{jk}$ are eigenvectors of $\uu H_j$
with eigenvalues $p_{jk}^2$:
\begin{equation}
  \left( -p_{jk}^2 + \uu H_j \right) \u x_{jk} = 0
   \;\text{ for }\;j=1,2.
\end{equation}
In a reproducible algorithm,
the eigenvectors $\u x_{jk}$ must be chosen according to some arbitrary
normalization rule,
for instance
\begin{equation}
  |\u x_{jk}|=1,\quad x_{ij\UP} \text{ real and nonnegative}.
\end{equation}
Similarly,
a rule is needed how to handle the case of one degenerate eigenvalue,
which includes in particular the case of scalar interactions.


%-------------------------------------------------------------------------------
\subsection{Wave propagation across layers}
%-------------------------------------------------------------------------------

Generalizing (\ref{Evecc}),
we introduce the coefficient vector
\begin{equation}
  c_j := {(\alpha_{j1}, \alpha_{j2}, \beta_{j1}, \beta_{j2})}^\text{T}.
\end{equation}
To match solutions for neighboring layers,
continuity is requested for both spinorial components
of $\u\psi$ and $\Nabla\u\psi$.
As before (\ref{EFcFDc}), we have at the bottom of layer~$j$
\begin{equation}\label{EFcFDcp}
  F_j c_j = F_{j+1} D_{j+1} c_{j+1},
\end{equation}
where the matrices are now
\begin{equation}
  F_j := \left(\begin{array}{cccc}
    x_{i1\UP}      &x_{i2\UP}     &x_{i1\UP}       &x_{i2\UP}       \\
    x_{i1\DN}      &x_{i2\DN}     &x_{i1\DN}       &x_{i2\DN}       \\
    x_{i1\UP}p_{j1}&x_{i2\UP}p_{j2}&-x_{i1\UP}p_{j1}&-x_{i2\UP}p_{j2}\\
    x_{i1\DN}p_{j1}&x_{i2\DN}p_{j2}&-x_{i1\DN}p_{j1}&-x_{i2\DN}p_{j2}
  \end{array}\right)
\end{equation}
and
\begin{equation}
  D_j := \text{diag}(\delta_{j1}, \delta_{j2}, \delta_{j1}^*, \delta_{j2}^*)
\end{equation}
with the phase factor
\begin{equation}
   \delta_{jk} := \e^{ip_{jk}d_k}.
\end{equation}
Note that matrix $F_j$ has the block form
\begin{equation}
  F_j
  =\left(\begin{array}{ll}\uu x_j&\hphantom{-}\uu x_j\\[1ex]
    \uu x_j\; \uu P_j&-\uu x_j\; \uu P_j\end{array}\right)
    = \uu x_j \cdot
    \left(\begin{array}{cc}\uu 1&\uu 1\\[1ex]
    \uu P_j&-\uu P_j\end{array}\right),
\end{equation}
with
\begin{equation}
  \uu x_j :=
  \left(\u x_{j1}, \u x_{j2}\right),
  \quad
  \uu P_j :=
  \text{diag}\left(p_{j1},p_{j2}\right).
\end{equation}
This facilitates the computation of the inverse
\begin{equation}
  F_j^{-1}
    = \frac{1}{2}
    \left(\begin{array}{cc}\uu 1&\hphantom{-}\uu P_j^{-1}\\[1.2ex]
      \uu 1 &-\uu P_j^{-1}\end{array}\right)
      \cdot\uu x_j^{-1},
\end{equation}
which is needed for the transfer matrix $M_j$,
defined as in (\ref{Edef_M}).
With the new meaning of $c_j$ and $M_j$,
the recursion (\ref{EcMc}) and the explicit solution~(\ref{Eci})
hold as derived above.
To resolve~(\ref{Eci}) for the reflected amplitudes $\alpha_{0j}$
as function of the incident amplitudes $\beta_{0j}$,
we choose the notations
\begin{equation}
  \u\alpha_j
  :=\left(\begin{array}{c}\alpha_{j1}\\\alpha_{j2}\end{array}\right),\quad
  \u\beta_j
  :=\left(\begin{array}{c}\beta_{j1}\\\beta_{j2}\end{array}\right),\quad
  M:=M_1 ... M_N % TODO restore \cdots
  =:\left(\begin{array}{cc}\uu m_{11}&\uu m_{12}\\
                           \uu m_{21}&\uu m_{22}\end{array}\right),
\end{equation}
where the $\uu m_{jk}$ are $2\times2$ matrices.
Eq.~(\ref{Eci}) then takes the form
\begin{equation}
  \left(\begin{array}{c}\u\alpha_{0}\\\u\beta_{0}\end{array}\right)
  = 
  \left(\begin{array}{cc}\uu m_{11}&\uu m_{12}\\
    \uu m_{21}&\uu m_{22}\end{array}\right)
  \left(\begin{array}{c}\u{0}\\\u\beta_{N}\end{array}\right),
\end{equation}
which immediately yields
\begin{equation}
  \u\alpha_0 = \uu m_{12}\,\uu m_{22}^{-1}\,\u\beta_0.
\end{equation}

\index{Multilayer|)}%
