%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   BornAgain User Manual
%%
%%   homepage:   http://www.bornagainproject.org
%%
%%   copyright:  Forschungszentrum Jülich GmbH 2015
%%
%%   license:    Creative Commons CC-BY-SA
%%
%%   authors:    Scientific Computing Group at MLZ Garching
%%               C. Durniak, M. Ganeva, G. Pospelov, W. Van Herck, J. Wuttke
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\Do{\overset{o}{D}}
\def\Go{\overset{o}{G}}
\def\TD{\TENS{D}}
\def\TG{\TENS{G}}
\def\TDo{\TENS{\overset{o}{D}}}
\def\TGo{\TENS{\overset{o}{G}}}
\def\Psio{\TENS{\overset{o}{\Psi}}}

\def\pfo{\overset{o}{\psi}_\sf}
\def\pfoc{\overset{o}{\psi}\vphantom{\psi}^*_\sf}

\index{Scattering!target|see{Sample}}%
\index{Elastic scattering|seealso{Cross section}}%

\part{Physics}\label{PPHYS}

\chapter{Scattering}  \label{SSca}
\chaptermark{Scattering}

TODO: REWRITE
This chapter introduces the basic theory of small-angle scattering (SAS).
\index{Small-angle scattering}%
\index{SAS|see{Small-angle scattering}}%
We specifically consider scalar neutron and X-ray propagation,
adjourning the notationally more involved
theory of polarized neutrons to \Cref{SPol}.
Our exposition is self-contained,
except for the initial passage from the microscopic
to the macroscopic Schrödinger equation,
which we outline only briefly (\Cref{Swave}).
For X-rays, we obtain the same perturbed Schrödinger equation from Maxwell's equations
(\Cref{SXray}).
The standard description of scattering in first-order Born approximation
(\Cref{SBornApprox})
is introduced in a way that facilitates the following generalization
into the distorted-wave Born approximation (DWBA)
needed for grazing-incidence scattering (\Cref{SDWBA}).
This chapter finishes with a qualitative discussion
of coherence lengths (\Cref{Scoherlen}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Wave propagation}\label{Swave}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{Wave propagation|(}%

%===============================================================================
\subsection{Neutrons}\label{ScohWave}
%===============================================================================
\index{Wave propagation!neutron|(}%
\index{Neutron!wave propagation|(}%

\def\Vmac{\tilde{V}}

\index{Schrodinger@Schrödinger equation!microscopic}%
The scalar wavefunction $\psi(\r,t)$
\nomenclature[2t020]{$t$}{Time}%
\nomenclature[2r040]{$\r$}{Position}%
\nomenclature[1ψ030 2r040 2t02]{$\psi(\r,t)$}{Microscopic neutron wavefunction}%
of a free neutron
in absence of a magnetic field
is governed by the Schrödinger equation
\begin{equation}\label{ESchrodi1}
  i\hbar\partial_t \psi(\r,t)
  = \left\{-\frac{\hbar^2}{2m}\Nabla^2+V(\r)\right\} \psi(\r,t).
\end{equation}
Since BornAgain only aims at modelling elastic scattering,
\index{Scattering!elastic}%
any time dependence of the potential is averaged out in the definition
\index{Potential!neutron}%
\index{Neutron!potential}%
$V(\r)\coloneqq \langle V(\r,t)\rangle$.
\nomenclature[2v130 2r040]{$V(\r)$}{Neutron potential}%
\index{Time dependence!neutron potential}%
Inelastic scattering,
\index{Inelastic scattering}%
\index{Scattering!inelastic}%
\index{Damping!inelastic scattering}%
\index{Loss terms|see {Damping}}%
in principle, can be accounted for by an extra contribution
damping.\footnote
{This is not explicitly supported in the software,
but users are free to increase the imaginary part of the refractive index
\index{Refractive index!losses from inelastic scattering}%
to emulate damping by inelastic losses.\label{Flosses}}
Therefore we only need to consider monochromatic waves
\index{Wave!monochromatic}%
\index{Monochromatic wave}%
with given frequency~$\omega$.
\nomenclature[1ω 020]{$\omega$}{Frequency of incident radiation}%
In consequence, the wavefunction
\begin{equation}\label{Estationarywave}
  \psi(\r,t) = \psi(\r)\e^{-i\omega t}
\end{equation}
\nomenclature[1ψ030 2r040 0]{$\psi(\r)$}{Stationary wavefunction}%
factorizes into a stationary wave and a time-dependent phase factor.
\index{Stationary wavefunction}%
\index{Phase factor}%
In the following, we will characterize the incoming radiation
not by its energy~$\hbar\omega$,
but by its \E{vacuum wavenumber}~$K$,
\index{Vacuum!neutron wavenumber}%
\index{Wavenumber!neutron}%
\nomenclature[2k120]{$K$}{Wavenumber in vacuum}%
given by the dispersion relation
\index{Dispersion relation!neutron}%
\index{Neutron!dispersion relation}%
\begin{equation}
  \hbar\omega = \frac{(\hbar K)^2}{2m}.
\end{equation}
The macroscopic Schrödinger equation~\cref{ESchrodi1} then takes the simple form
\Emph{
\begin{equation}\label{ESchrodi2}
  \left\{\Nabla^2+K^2-4\pi v(\r)\right\} \psi(\r) = 0
\end{equation}
\vspace*{-5pt}}
with the rescaled form of Fermi's pseudopotential\footnote
{For words of caution about this ``naive conception''
see Sears \cite[p.~7]{Sea89}.}
\index{Fermi's pseudopotential}%
\index{Pseudopotential!Fermi's}%
\index{Potential!neutron}%
\index{Neutron!potential}%
\begin{equation}\label{Evrraw}
  v(\r)
  \coloneqq \frac{m}{2\pi\hbar^2} V(\r)
  = \sum_j\left\langle b_j \delta\left(\r-\r_j(t)\right)\right\rangle.
\end{equation}
The sum runs over all nuclei in the \E{scattering target},
\index{Scattering target|see{Sample}}%
\index{Target!scattering}%
or \E{sample},
\index{Sample}%
as we will call it henceforth.
The \E{bound scattering length}~$b_j$
\index{Scattering length}%
\index{Bound scattering length|see{Scattering length}}%
\nomenclature[2b0]{$b$}{Bound scattering length}%
is isotope specific;
\index{Isotope}%
values are tabulated \cite{Sea92}.

In \E{small-angle scattering},
\index{Scattering!small-angle}%
\index{Small-angle scattering}%
as elsewhere in \E{neutron optics} \cite{Sea89},
\index{Neutron!optics}%
\index{Optics!neutron}%
the potential can be coarse-grained by spatially averaging over at least a few atomic diameters,
\begin{equation}\label{Evrcoarse}
  v(\r)
  = \sum_s b_s \rho_s(\r),
\end{equation}
\nomenclature[2v030 2r040]{$v(\r)$}{Rescaled neutron potential, scattering length density (SLD)}%
where the sum now runs over chemical elements,
$b_s\coloneqq\langle b_j\rangle_{j\in s}$ is the bound \E{coherent} scattering length,
\index{Coherent scattering length}%
\index{Scattering length!coherent}%
and $\rho_s$ is a number density.
\index{Number density}%
\index{Density}%
\nomenclature[1ρ032 2s010]{$\rho_s$}{Number density of chemical element~$s$}%
In passing from \cref{Evrraw} to \cref{Evrcoarse},
we neglected \E{Bragg scattering}
\index{Scattering!Bragg}%
\index{Bragg scattering}%
from atomic-scale correlation,
\index{Atomic scale}%
\index{Correlation!atomic scale}%
and \E{incoherent scattering} from spin or isotope related fluctuations of $b_j$.
\index{Scattering!incoherent}%
\index{Incoherent scattering}%
\index{Isotope}%
\index{Spin!neutron}%
\index{Neutron!spin}%
In small-angle experiments,
 these types of scattering only matter as loss channels.\footnote
{Same remark as in \Cref{Flosses}: To model these losses, use the
\index{Refractive index!losses from Bragg scattering}%
\index{Refractive index!losses from incoherent scattering}%
imaginary part of the refractive index.}
Furthermore, incoherent scattering, as inelastic scattering,
 contributes to the diffuse background in the detector.
\index{Scattering!diffuse}%
\index{Scattering!inelastic}%
\index{Inelastic scattering}%
\index{Background!diffuse}%
\index{Detector!background}%
In conclusion, the coarse-grained neutron optical potential~\cref{Evrcoarse}
\index{Potential!optical}%
\index{Neutron!optical potential}%
\index{Neutron!potential}%
is just a \E{scattering length density} (SLD)
\index{Scattering length density}%
\index{SLD|see{Scattering length density}}%
\cite[eq.\ 2.8.37]{Sea89}.

%===============================================================================
\subsection{Neutrons in a magnetic field}\label{Snpwave}
%===============================================================================

\index{Neutron!spin|(}%
\index{Spin|(}%
\index{Magnetic field!neutron propagation|(}%

\index{Field!magnetic|see{Magnetic field}}%
\index{H Field@$H$ Field|see{Magnetizing field}}%
\index{B Field@$H$ Field|see{Magnetizing field}}%

In presence of a magnetic field,
the propagation of free neutrons becomes spin dependent.
Therefore the scalar wavefunction of \cref{ScohWave}
must be replaced by spinor $\v\Psi$.
\index{Spinor}%
The magnetic moment of the neutron couples to the magnetizing field~$\v{H}$ \cite{Mez86}.
\nomenclature[2h150 2r040 2t020]{$\v{H}(\r,t)$}{Magnetizing field}%
\index{Magnetizing field!coupling to neutron moment}%
With the coupling term, the Schrödinger equation~\cref{ESchrodi1}
\index{Schrodinger@Schrödinger equation!macroscopic}%
becomes
\begin{equation}\label{EHSchrodi}
  \left\{-\frac{\hbar^2}{2m}\Nabla^2+V(\r)
         +\mu_0\mu_\text{n}\v{H}(\r)\v{\sigma}-\hbar\omega\right\}
      \v\Psi(\r) = 0,
\end{equation}
\nomenclature[1ψ150 2r040]{$\v\Psi(\r)$}{Stationary coherent spinor wavefunction}%
where $\mu_0$ is the vacuum permeability,
\nomenclature[1μ024 00]{$\mu_0$}{Vacuum permeability, $4\pi\cdot10^{-7}$ Vs/Am}%
\index{Permeability}%
\index{Magnetic permeability}%
$\mu_\text{n}$ is the magnetic moment of the neutron,
\nomenclature[1μ024 2n000]{$\mu_\text{n}$}{Magnetic moment of the neutron}
\index{Neutron!magnetic moment}%
\index{Magnetic moment!neutron}%
and ${\v\sigma}$ is the Pauli vector, composed of the three Pauli matrices.
\nomenclature[1σ04]{$\v\sigma$}{Pauli
    vector, composed of the three Pauli matrices: $\v\sigma=(\sigma_x,\sigma_y,\sigma_z)$}%
\index{Pauli vector}%
\index{Pauli matrix}%
The magnetic coupling is responsible for Larmor precession of the neutron spin,
\index{Neutron!Larmor precession}%
\index{Larmor precession}%
\index{Spin!Larmor precession}%
well known from uses in spin-echo techniques.
\index{Spin!echo}%
If the field is inhomogeneous,
it can split a beam
as in the Stern-Gerlach experiment \cite{ShSB54}.
\index{Neutron!Stern-Gerlach splitting}%
\index{Stern-Gerlach splitting}%
We introduce the reduced field
\begin{equation}
  \v{h} \coloneqq \frac{m\mu_0\mu_\text{n}}{2\pi\hbar^2}\v{H},
\end{equation}
\nomenclature[2h050 2r040]{$\v{h}(\r)$}{Rescaled
   field $\v{h}=(m\mu_0\mu_\text{n}/2\pi\hbar^2)\v{H}$}%
\index{Magnetizing field!reduced}%
to rewrite the Schrödinger equation in analogy to~\cref{ESchrodi2} as
\index{Schrodinger@Schrödinger equation!macroscopic}%
\Emph{
\begin{equation}\label{ESchrodi2H}
  \left\{\Nabla^2+K^2-4\pi v(\r)-\v{h}(\r)\v{\sigma}\right\} \v\Psi(\r) = 0.
\end{equation}
\vspace*{-5pt}}


\index{Spin|(}%
\index{Neutron!spin|)}%
\index{Magnetic field!neutron propagation|)}%

\index{Wave propagation!neutron|)}%
\index{Neutron!wave propagation|)}%

%===============================================================================
\subsection{X-rays}\label{SXwave}
%===============================================================================

\index{Wave propagation!X-ray|(}%

The propagation of X-rays is governed by Maxwell's equations,
\index{Maxwell's equations}%
\begin{equation}\label{EMaxwell}
  \begin{array}{@{}l@{\quad}l@{\quad}l}
    \Nabla\times\v{E}=-\partial_t \v{B},
   &\Nabla\v{B}=0,
   &\v{B}=\v{\mu}(\r)\mu_0\v{H},
   \\[2ex]
    \Nabla\times\v{H}=+\partial_t \v{D},
   &\Nabla\v{D}=0,
   &\v{D}=\v{\eps}(\r)\eps_0\v{E}.
  \end{array}
\end{equation}
\nomenclature[2e150 2r040 2t020]{$\v{E}(\r,t)$}{Electric field}%
\nomenclature[2d150 2r040 2t020]{$\v{D}(\r,t)$}{Displacement field}%
\nomenclature[2b150 2r040 2t020]{$\v{B}(\r,t)$}{Magnetic field}%
\nomenclature[1ε070 2r040]{$\v\eps(\r)$}{Relative dielectric permittivity tensor}%
\nomenclature[1μ070 2r040]{$\v\mu(\r)$}{Relative magnetic permeability tensor}%
\nomenclature[1ε024 00]{$\eps_0$}{Vacuum permittivity, 8.854\ldots As/Vm}%
Since BornAgain only addresses elastic scattering,
\index{Elastic scattering}%
\index{Scattering!elastic}%
we assume the permeability and permittivity tensors $\v\mu$ and~$\v\eps$
to be time-independent.
\index{Time dependence!dielectric permittivity}%
Therefore, as in~\cref{ScohWave}, we only need to consider monochromatic waves
\index{Wave!monochromatic}%
\index{Monochromatic wave}%
with given frequency~$\omega$,
and each of the fields $\v{E}$, $\v{D}$, $\v{H}$, $\v{B}$
factorizes into a stationary field and a time-dependent phase factor.\footnote
{This phase factor can be defined with a plus or a minus sign in the exponent.
Most texts on X-ray crystallography,
including influential texts on GISAXS \cite{ReLL09},
prefer the \E{crystallographic convention} with a plus sign.
\index{Wave propagation|seealso {Sign convention}}%
\index{Convention!sign convention}%
\index{Sign convention!wave propagation|(}%
\index{Crystallographic sign convention}%
In BornAgain, we prefer the opposite \E{quantum-mechanical convention}
\index{Quantum-mechanical convention}%
for consistency with the neutron case \cref{Estationarywave},
where the minus sign is an inevitable consequence
of the standard form of the Schrödinger equation.%
\index{Sign convention!wave propagation|)}%
}
\index{Phase factor}%
In the following, we will concentrate on the electric field
\index{Electric field}%
\begin{equation}\label{EstationaryX}
  \v{E}(\r,t) = \v{E}(\r)\e^{-i\omega t}.
\end{equation}
The other three fields can be obtained from~$\v{E}$
by straightforward application of~\cref{EMaxwell}.

Since magnetic refraction or scattering is beyong the scope of BornAgain,
the relative magnetic permeability tensor is always $\v{\mu}(\r)=1$.
\index{Permeability}%
\index{Magnetic permeability}%
As customary in SAXS and GISAXS,
\index{Grazing-incidence small-angle scattering!dielectric model}%
\index{Small-angle scattering!dielectric model}%
we assume
that the dielectric properties of the material are those of a polarizable electron cloud.\footnote
{This is occasionally called the \E{Laue model}
\index{Laue model}%
 \cite{Lau31}.}
Thereby the relative dielectric permittivity tensor~$\v{\eps}$
\index{Dielectric permittivity}%
\index{Permittivity}%
becomes a scalar,
\begin{equation}
  \eps(\r)=1-\frac{4\pi r_e}{K^2}\rho(\r),
\end{equation}
\nomenclature[1ε030 2r040]{$\eps(\r)$}{Relative dielectric permittivity function}%
\nomenclature[1ρ030 2r040]{$\rho(\r)$}{Electron number density}%
with the classical electron radius~$r_e=e^2/mc^2\simeq2.8\cdot10^{-15}$~m,
\index{Electron radius}%
\index{Classical electron radius}%
\nomenclature[2r024 2e000]{$r_e$}{Classical electron radius~$2.817\ldots^{-15}$~m}%
the electron number density~$\rho(\r)$,
\index{Electron density}%
\index{Density!electron}%
\index{Number density|see{Density}}%
and the vacuum wavenumber~$K$,
given by the dispersion relation
\begin{equation}
  K^2 = \mu_0\eps_0\omega^2.
\end{equation}
\index{Dispersion!X-ray}%

With these simplifying assumptions about $\v{\eps}$ and~$\v{\mu}$,
Maxwell's equations yield the wave equation
\begin{equation}\label{ENabCrossNabE}
  \Nabla\times\Nabla\times\v{E} = K^2\eps(\r)\v{E}.
\end{equation}
\index{Wave equation!X-ray}%
\index{X-ray!wave equation}%
Using a standard identity from vector analysis, it can be brought into the more tractable form
\Emph{
\begin{equation}\label{ENabNabE}
  \left\{\Nabla^2-\Nabla\cdot\Nabla+ K^2\eps(\r)\right\}\v{E}(\r)=0,
\end{equation}
\vspace*{-5pt}}
which closely ressembles the macroscopic Schrödinger equation~\cref{ESchrodi2},
except for the additional dyadic differential operator $\Nabla\cdot\Nabla$,
and for the transverse vector character of the electric field~$\E(\r)$.

\index{Wave propagation!X-ray|)}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Distorted-wave Born approximation}\label{SDWBA}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%===============================================================================
\subsection{Perturbed wave equation}\label{Sfluct}
%===============================================================================

We now begin to study scattering by condensed-matter samples
We will determine scattering cross sections
\index{Cross section}%
\index{Scattering!cross section}%
by solving the wave equations \cref{ESchrodi2,ESchrodi2H,ENabNabE}
through a perturbation expansion.
\index{Perturbation expansion}%
However, to achieve rapid convergence
we must not treat \E{all} of $v(\r)$, $\v{h}(\r)$ or $\epsilon(\r)$
as a perturbation.
Rather, we will decompose each of these fields into a more \E{regular}
and a more \E{fluctuating} part:
\begin{align}
  v(\r) &= \mv(\r) + \delta v(\r),\\
  \v{h}(\r) &= \overline{\v{h}}(\r) + \delta\v{h}(r),\\
  \epsilon(\r) &= \overline\epsilon(\r) + \delta\epsilon(\r).
\end{align}
The fluctuating parts stand for the more irregular features of a sample
one ultimately wants to study in a scattering experiment.
If they are zero,
then the remaining wave equations shall be simple enough to allow
for analytical solutions.
These solutions will be called \E{distorted waves}.
\index{Distorted wave}%
\index{Wave!distorted}%
They are distorted with respect to the plane \E{vacuum waves}
\index{Vacuum!wave}%
\index{Wave!vacuum}%
\index{Plane!wave}%
\index{Wave!plane}%
that are obtained as solution of the wave equations
for $\r$ outside the finite sample,
under the vacuum conditions $v=0$, $\v{h}=0$, $\epsilon=1$.

In the following,
we develop a generic formalism for the scattering of distorted neutron or X-ray waves.
Wave propagation in vacuum shall be denoted by an overset circle.
The wave equation in vacuum shall be written as
\Emph{
\begin{equation}\label{EDPsi0}
  \TDo\,\Psio(\r)=0.
\end{equation}
\vspace*{-5pt}}
Literally, this is an equation for the neutron spinor wavefunction.
It is, however, equally applicable for scalar neutron wavefunctions~$\psi(\r)$
or electric fields~$\v{E}(\r)$.
The differential operator in~\cref{EDPsi0} is
\begin{align}
  \Do &\coloneqq \Nabla^2 + K^2 &\text{ neutron (scalar),}\\
  \TDo &\coloneqq \Nabla^2 + K^2 &\text{ neutron (spinorial),}\\
  \TDo &\coloneqq \Nabla^2 - \Nabla\cdot\Nabla + K^2 &\text{ X-ray.}
\end{align}
\nomenclature[2d138 2r040]{$\Do(\r)$}{Differential operator in the vacuum wave equation}%
Distorted-wave propagation is described by the differential operator
\begin{equation}
  \TD(\r) \coloneqq \TDo + \TENS{\Lambda}(\r)
\end{equation}
with the distortion field
\begin{align}
  \Lambda(\r) &\coloneqq 4\pi\mv(\r)
      &\text{ neutron (scalar),}\\
  \TENS{\Lambda}(\r) &\coloneqq 4\pi\mv(\r)+\overline{\v{h}}(\r)\v\sigma
      &\text{ neutron (spinorial),}\\
  \Lambda(\r) &\coloneqq K^2(\epsilon(\r)-1)
      &\text{ X-ray.}
\end{align}
If it is scalar, then it can be expressed through the \E{refractive index}
\index{Refractive index}%
\index{Index of refraction|see {Refractive index}}%
\nomenclature[2n020]{$n$}{Refractive index}%
\begin{equation}\label{EnkK}
  n(\r)
  \coloneqq\sqrt{1-\frac{\Lambda(\r)}{K^2}}
  = \left\{\begin{array}{lr}
       \sqrt{1-4\pi\mv(\r)/K^2} &\text{ neutron (scalar),}\\
       \sqrt{\epsilon(\r)} &\text{ X-ray.}
    \end{array}\right.
\end{equation}
If $\mv(\r)$ or $\epsilon(\r)$ has an imaginary part, describing absorption,
\index{Absorption}%
then $n(\r)$ is a complex number.
Conventionally, $n$ is parameterized by two real numbers:
\begin{equation}\label{Endb1}
  n \eqqcolon  1-\delta +i\beta.
\end{equation}
\nomenclature[1δ020]{$\delta$}{Small parameter in the refractive index
   $n=1-\delta +i\beta$}%
\nomenclature[1β020]{$\beta$}{Imaginary part of the refractive index}%
For thermal neutrons and X-rays,
$\delta$ and $\beta$ are almost always nonnegative,\footnote
{The plus sign in front of~$i\beta$ is a consequence of
the quantum-mechanical sign convention;
in the X-ray crystallography convention it would be a minus sign.
\index{Refractive index!sign convention}%
\index{Sign convention!refractive index}}
and much smaller than~1.

The full wave equation, valid inside and outside the sample,
can then be written as
\Emph{
\begin{equation}\label{EDPsi}
  \TD(\r)\v\Psi(\r) = 4\pi\TENS{U}(\r)
\end{equation}
\vspace*{-5pt}}
with
\begin{align}
  U(\r) &\coloneqq \delta v(\r)
      &\text{ neutron (scalar),}\\
  \TENS{U}(\r) &\coloneqq \delta v(\r)+\delta{\v{h}}(\r)\v\sigma/(4\pi)
      &\text{ neutron (spinorial),}\\
  U(\r) &\coloneqq K^2\delta \epsilon(\r)/(4\pi)
      &\text{ X-rays.}
\end{align}

%===============================================================================
\subsection{Reciprocity of the Green function}\label{SReci}
%===============================================================================

\index{Reciprocity|(}%
\index{Green function!reciprocity|(}%

Our computation of~$G_\infty$ will be based on a source-detector \E{reciprocity theorem}
for the scalar Schrödinger equation.\footnote
{There exists a confusing multitude of reciprocity theorems \cite{Pot04}.
In the end, we found it simpler to provide a derivation taylored for our application case
than to refer to the literature.}
The theorem states:
Any Green function $G(\r,\r')$
that solves~\cref{EGreenK} and as function of~$\r$ represents an outgoing wave
[in accord with the Sommerfeld radiation condition,
\index{Sommerfeld radiation condition}%
\index{Radiation condition}%
cf.~\cref{Escabouco}]
is invariant under an exchange of source location~$\rS$ and detection point~$\rD$:
\nomenclature[2r041 2d100]{$\rD$}{Position of detector}%
\nomenclature[2r041 2s100]{$\rD$}{Position of source, locus of scattering}%
\begin{equation}\label{Erecip}
  G(\rS,\rD) = G(\rD,\rS).
\end{equation}
Readers not interested in mathematical details may skip the following \E{proof}:

We introduce the auxiliary vector field
\begin{equation}
  \v{X}(\r,\rS,\rD)\coloneqq G(\r,\rD)\Nabla G(\r,\rS) - G(\r,\rS)\Nabla G(\r,\rD).
\end{equation}
%\nomenclature[2x150 2r040]{$\v{X}(\r,\rS,\rD)$}{Auxiliary vector field}%
We inscribe the sample and the detector
into a sphere $\Sphere$ around the coordinate origin with radius~$R$,
%\nomenclature[2s180]{$\Sphere$}{Auxiliary spherical volume}%
%\nomenclature[2r120]{$R$}{Radius of $\Sphere$}%
and compute the volume integral
\begin{equation}\label{Eprerecipro}
    I(\rS,\rD) \coloneqq \displaystyle\int_\Sphere\!\d^3r\,\Nabla \v{X}(\r,\rS,\rD).
\end{equation}
After a few steps, not entirely trivial, but not too difficult either,
we obtain
\begin{equation}\label{EIBD}
  I(\rS,\rD) = G(\rS,\rD) - G(\rD,\rS).
\end{equation}
Alternatively, we can compute $I$ as a surface integral
\begin{equation}
  I(\rS,\rD)
  =\displaystyle\int_{\partial\Sphere}\d\v{\sigma}\,\v{X}(\r,\rS,\rD).
\end{equation}
On the surface $\partial\Sphere$,
$G$ is an outgoing solution of the Helmholtz equation.
As such, it has a well-known series expansion in spherical coordinates.
We send $R\to\infty$ so that we need only to retain the lowest order:
\begin{align}
   G(\r(R,\vartheta,\varphi),\rD)
   &\doteq\displaystyle \frac{\e^{iKR}}{4\pi R} a(\vartheta,\varphi),
   \\[3.8ex]
   G(\r(R,\vartheta,\varphi),\rS)
   &\doteq\displaystyle \frac{\e^{iKR}}{4\pi R} b(\vartheta,\varphi).
\end{align}
The factorization of $G$ and $B$ and their common $R$ dependence imply that
\begin{equation}
  I(\rS,\rD)
  =\displaystyle\int_{\partial\Sphere}\d\sigma\,
       (\text{$R$-dependent})(ab-ba)
  = 0.
\end{equation}
Comparison with \cref{EIBD} yields \cref{Erecip},
which completes the proof.

\index{Reciprocity|)}%
\index{Green function!reciprocity|)}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Neutron scattering in Born approximation}\label{SBornApprox}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

a solution
by means of a perturbation expansion in powers of $\delta v$,
\index{Perturbation expansion}%
known as the \E{Born expansion} or \E{Born series}.\footnote{
Named after Max Born
who introduced it in quantum mechanics.
The idea goes back to Lord Rayleigh
who devised it for sound,
and later also applied it to electromagnetic waves,
which resulted in his famous explanation of the blue sky.}
The standard first-order Born approximation (BA, \cref{SBornApprox})
is regularly used  for the analysis of small-angle scattering (SAS) experiments.
\index{Small-angle scattering}%
\index{BA|see{Born approximation}}%
\index{Born approximation}%
For grazing-incidence small-angle scattering (GISAS),
one uses the slightly more generic distorted wave Born approximation (DWBA, \Cref{SDWBA}).
\index{Distorted-wave Born approximation}%

%===============================================================================
\subsection{The Born expansion}\label{SBornExpans}
%===============================================================================

\index{Born approximation|(}%
\index{Scattering!plane wave|(}%

To describe an elastic scattering experiment,
we need to solve the Schrödinger equation~\cref{ESchrodiK}
under the asymptotic boundary condition\footnote
{A more formal variant of this is known as the \E{Sommerfeld radiation condition}.%
\index{Sommerfeld radiation condition}%
\index{Radiation condition}%
}
\index{Boundary conditions!elastic scattering}%
\begin{equation}\label{Escabouco}
  \psi(\r)
  \simeq \psi_\si(\r) + f(\vartheta,\varphi)\frac{\e^{iKr}}{4\pi r}
  \text{~for~}r\to\infty,
\end{equation}
\nomenclature[1ψ034 2i000 2r040]{$\psi_\si(\r)$}{Incident wavefunction}%
\nomenclature[2i000]{i}{Subscript ``incident''}%
\index{Incident radiation!Born approximation}%
where $\psi_\si(\r)$ is the incident wave
as prepared by the experimental apparatus,
and the second term on the right-hand side is
the outgoing scattered wave
\index{Scattered radiation!Sommerfeld condition}
that carries information in form of the angular distribution
$f(\vartheta,\varphi)$.

Equation~\cref{ESchrodiK} looks
like an inhomogeneous differential equation ---
except that the right-hand side contains the unknown function~$\psi$.
The key idea of the Born expansion is to overcome this problem by iteration.
Treating the right-hand side as a given inhomogeneity,
one can solve~\cref{ESchrodiK} by the Green function method.
The incident wave~$\psi_\si(\r)$ must be determined from the homogeneous wave equation
\begin{equation}\label{EHomoK}
  \left\{\Nabla^2+k(\r)^2\right\}\psi_\si(\r) = 0.
\end{equation}
The Green function~$G(\r,\r')$ must fulfill the wave equation with an isolated inhomogeneity,
\index{Green function}%
\begin{equation}\label{EGreenK}
  \left\{\Nabla^2+k(\r)^2\right\}G(\r,\r') = \delta(\r-\r').
\end{equation}
\nomenclature[2g134]{$G(\r,\r')$}{Green function}%
Let us postpone the explicit or asymptotic solution of these two equations
to later sections (\cref{Sfarfield} for the standard plane-wave case with $k(\r)=K$,
\cref{SfarDW} for the more generic distorted-wave case).
Here we only need to assume that solutions $\psi_\si$ and~$G$ exist.
We can then posit the \E{Lippmann-Schwinger equation}
\index{Lippmann-Schwinger equation}%
\begin{equation}\label{EPsiFormal}
  \psi(\r)
  = \psi_\si(\r)
  + \int\!\d^3r'\, G(\r,\r') 4\pi\delta v(\r')\psi(\r').
\end{equation}
By operating on both sides with~$\{\Nabla^2+k(\r)^2\}$
it is easily seen that solutions~$\psi$ of this integral equation
fulfill the perturbed Schrödinger equation \cref{ESchrodiK}.

The Lippmann-Schwinger equation can be resolved into an infinite series
by iteratively substituting the full right-hand side of~\cref{EPsiFormal}
for the occurence of~$\psi$ in the integrand.
Successive terms in this series contain rising powers of $\delta v$.
Since $\delta v$ is assumed to be small, the series is likely to converge.
In \E{first-order Born approximation},
only the linear order in $\delta v$ is retained,
\begin{equation}\label{EBorn}
  \psi(\r)
  \doteq \psi_\si(\r)
  + 4\pi \int\!\d^3r'\, G(\r,\r') \delta v(\r') \psi_\si(\r').
\end{equation}
This is practically always adequate for
material investigations with X-rays or neutrons,
where the aim is to
deduce $\delta v(\r')$ from the scattered intensity ${|\psi(\r)|}^2$.
Since detectors are always placed at positions $\r$
that are not illuminated by the incident beam,
we are only interested in the scattered wave
\index{Scattered radiation!Born approximation}%
\index{Wave!scattered}%
\begin{equation}\label{EBornS}
  \psi_\text{s}(\r)
  \coloneqq
  4\pi \int\!\d^3r'\, G(\r,\r') \delta v(\r') \psi_\si(\r').
\end{equation}
\nomenclature[1ψ034 2s000 0 2r040]{$\psi_\text{s}(\r)$}{Scattered wavefunction}%
\nomenclature[2s000 0]{s}{Subscript ``scattered''}%
\index{Scattered radiation!Born approximation}
For brevity and mathematical convenience,
the integral introduced in~\cref{EPsiFormal} has no bounds
and therefore formally runs over the entire space.
However, the scattering potential $\delta v(\r')$ in the integrand is nonzero
only if $\r'$ lies inside the sample volume.
On the other hand, we only need to compute the scattered wave~$\psi_\text{s}(\r)$
at detector positions~$\r$ far outside the sample.
This is just the condition for \E{Fraunhofer diffraction}:
\index{Fraunhofer approximation}%
the distance from the sample to the detector location~$\r$
must be much larger than the size of the sample.
In the context of generic scattering theory,
it is known as the \E{far-field approximation}.
\index{Far-field approximation}%
To keep notation light,
we assume from now on that the coordinate origin
\index{Coordinate system!origin}%
\index{Origin!coordinate system}%
lies inside the sample.
Then far-field asymptotes are obtained by taking the limit $r\to\infty$.
Since we only need the asymptote $\psi_{\text{s}\infty}(\r)$ of the scattered wave,
\index{Scattered radiation!far field}
it is sufficient to solve~\cref{EGreenK} for the far-field Green function
\begin{equation}\label{EGinftydef}
  G_\infty(\r,\r')\coloneqq \lim_{r\to\infty} G(\r,\r').
\end{equation}
This will be done in very different ways for plane waves (\cref{Sfarfield})
and for distorted waves (\cref{SfarDW}).

\index{Scattering!plane wave|)}%
\index{Born approximation|)}%

%===============================================================================
\subsection{Vacuum solution}\label{Sfarfield}
%===============================================================================

\index{Far-field approximation|(}%

As said in connection with~\cref{Edecompose_v},
there is some freedom in the choice of $\mv(\r)$.
In the standard variant of the Born expansion,
one makes the simplest possible choice,
setting $\mv(\r)$ to the constant vacuum value.
With~\cref{Edecompose_v},
all fluctuations in $v(\r)$ are ascribed to the scattering potential~$\delta v(\r)$.
With~\cref{Edispersion}, we have $k(\r)=K$.
The homogeneous equation~\cref{EHomoK} reduces to the \E{Helmholtz equation},
\index{Helmholtz wave equation}%
\index{Wave propagation!Helmholtz equation}%
and is solved by plane waves and superpositions thereof.
In the following we choose the incident plane wave
\index{Incident radiation!plane wave}%
\begin{equation}\label{EPsi0Plane}
  \psi_\si(\r)=\e^{i \k_\si \r}
\end{equation}
\nomenclature[2k040]{$\k$}{wavevector}%
with $k_\si=K$.
Superposition of plane waves
\index{Superposition}%
will be discussed when we come to instrumental resolution effects (\cref{SBeam}).
\index{Instrument!resolution|see{Resolution}}%
\index{Resolution}%

The Green function of the inhomogeneous Helmholtz equation~\cref{EGreenK}
with $k(\r)=K$ is well known:\footnote
{Verification under the condition $\r\ne0$
is a straightforward exercise in vector analysis.
For the special case $\r=0$,
one encloses the origin in a small sphere
and integrates by means of the Gauss-Ostrogadsky divergence theorem.
This explains the appearance of the factor $4\pi$.}
\index{Green function!homogeneous material}%
\begin{equation}\label{EGreens1}
  G(\r,\r') = \frac{\e^{iK|\r-\r'|}}{4\pi |\r-\r'|}.
\end{equation}
Read as a function of~$\r$, it is an outgoing spherical wave centered at $\r'$.
To compute the far-field limit~\cref{EGinftydef},
we expand for $\r'$ with $r'\ll r$:
\begin{equation}
  \left|\r-\r'\right|
  \doteq \sqrt{r^2-2\r\,\r'}
  \doteq r - \frac{\r\,\r'}{r}
  \equiv r - \frac{\k_\sf \r'}{K},
\end{equation}
\nomenclature[2f000]{f}{Subscript ``final''}%
where we have introduced the outgoing wavevector
$  \k_\sf\coloneqq K \r / r$.
We apply this to~\cref{EGreens1},
\index{Green function!homogeneous material}%
and obtain in leading order the far-field Green function
\begin{equation}\label{EGreenFar}
  G_\infty(\r,\r')
  = \frac{\e^{iKr}}{4\pi r}\psi^*_\sf(\r'),
\end{equation}
\nomenclature[2g134 2far]{$G_\infty(\r,\r')$}{Far-field
   approximation to the Green function $G(\r,\r')$}%
where
\begin{equation}\label{EPsisfar}
  \psi_\sf(\r) \coloneqq  \e^{i\k_\sf \r}
\end{equation}
\nomenclature[1ψ034 2f000 2r040]{$\psi_\sf(\r)$}{Plane
  wave propagating from the sample towards the detector}%
is a plane wave propagating towards the detector,
and $\psi^*$ designates the complex conjugate of $\psi$.
As function of~$\r$, $G_\infty$ is an outgoing spherical wave.
Inserting \cref{EGreenFar} in \cref{EBornS},
we obtain the far-field approximation for the scattered wave,
\index{Scattered radiation!far-field}%
\begin{equation}\label{EsandwichC}
  \psi_{\text{s}\infty}(\r)
  = \frac{\e^{iKr}}{r}
    \bra \psi_\si|\delta v|\psi_\sf\ket^*
\end{equation}
\nomenclature[1ψ034 2s000 2far]{$\psi_{\text{s}\infty}(\r)$}{Far-field
   approximation to the scattered wavefunction $\psi_\text{s}(\r)$}%
with the Dirac notation for the scattering matrix element
\index{Scattering!matrix}%
\index{Transition matrix|see{Scattering matrix}}%
\Emph{%
\begin{equation}\label{Etrama}
  \bra \psi_\si|\delta v|\psi_\sf\ket
  \coloneqq  \int\!\d^3r\, \psi^*_\si(\r)\delta v(\r)\psi_\sf(\r).
\end{equation}
\vspace*{-5pt}}
\nomenclature[0$\langle$0]{{$\bra\ldots\vert\ldots\vert\ldots\ket$}}{Matrix
  element, defined as a volume integral}%
Since per \cref{EPsi0Plane} and~\cref{EPsisfar} our $\psi_\si$ and~$\psi_\sf$ are plane waves,
the matrix element can be simplified as
\begin{equation}\label{Echiq}
  \bra \psi_\si|\delta v|\psi_\sf\ket
  = \int\!\d^3r\, {\rm e}^{-i\k_\si\r}\delta v(\r){\rm e}^{i\k_\sf\r}
  = \int\!\d^3r\, {\rm e}^{i\q\r}\delta v(\r)
  \eqqcolon v(\q),
\end{equation}
\nomenclature[2v030 2q040]{$v(\v{q})$}{Fourier
   transform of the SLD~$\delta v(\r)$}%
with the \E{scattering vector}\footnote
{With this choice of sign,
\index{Sign convention!scattering vector}%
$\hbar\q$ is the momentum
\index{Momentum transfer|see {Scattering vector}}%
\E{gained} by the scattered neutron,
and \E{lost} by the sample.
In much of the literature the opposite convention is prefered,
since it emphasizes the sample physics over the scattering experiment.
However, when working with two-dimensional detectors
it is highly desirable to express pixel coordinates
\index{Coordinate system}
\index{Detector!pixel coordinate}
and scattering vector components
with respect to equally oriented coordinate axes,
which can only be achieved by the convention~\cref{Eq}.}
\index{Scattering!vector}%
\begin{equation}\label{Eq}
  \q\coloneqq \k_\sf-\k_\si.
\end{equation}
\nomenclature[2q040]{$\q$}{Scattering vector}%
\Cref{Echiq} summarizes the well-known fact that
small-angle neutron scattering basically measures
the Fourier transform $v(\q)$ of the SLD.
\index{Scattering!potential!Fourier transform}%
\index{Fourier transform!scattering potential}%

\index{Far-field approximation|)}%


%===============================================================================
\subsection{Differential cross section}\label{SdiffCross}
%===============================================================================

In connection with \cref{EBorn} we mentioned
that a scattering experiment measures intensities~${|\psi(\r)|}^2$.
We shall now restate this in a more rigorous way.
In the case of neutron scattering,
one actually measures a \E{probability flux}.
We define it in arbitrary relative units as
\begin{equation}\label{EdefJ}
  \v{J}(\r) \coloneqq  \psi^*\frac{\Nabla}{2i}\psi - \psi\frac{\Nabla}{2i}\psi^*.
\end{equation}
\nomenclature[2j150 2r040]{$\v{J}(\r)$}{Probability flux}%
\index{Flux!incident and scattered}%
The ratio of the scattered flux hitting an infinitesimal detector area
$r^2\d\Omega$ to the incident flux is expressed as a
\E{differential cross section}
\index{Cross section}%
\index{Scattering!cross section}%
\index{Incident radiation!flux|(}%
\begin{equation}\label{Exsectiondef}
  \xElas
  \coloneqq  \frac{r^2 J(\r)}{J_\si}.
\end{equation}
\nomenclature[1ω120]{$\Omega$}{Solid angle}%
\nomenclature[1σ020]{$\sigma$}{Scattering or absorption cross section}%
% TODO RESTORE XREF
% The geometric factors that are needed to
% convert $\d\sigma/\d\Omega$ into detector counts will be discussed
% below in \cref{SdetImg}.
For a plane wave~\cref{EPsi0Plane}, the incident flux is
\index{Incident radiation!flux|)}%
\index{Flux!Born approximation}%
\begin{equation}\label{EJi}
  \v{J}_\si = \k_\si.
\end{equation}
With the far-field result~\cref{EsandwichC}
and the notation~\cref{Etrama},
the scattered flux at the detector is
\begin{equation}\label{EJr}
  \v{J}(\r)
  = \v{\hat r}\frac{K}{r^2}
    {\left|\bra\psi_\si|\delta v|\psi_\sf\ket\right|}^2.
\end{equation}
\index{Scattered radiation!flux}%
Inserting these into definition~\cref{Exsectiondef},
we obtain the generic differential cross section
of elastic scattering in first order Born approximation,
\index{Born approximation!elastic scattering cross section}%
\index{Cross section!Born approximation}%
\index{Scattering!cross section}%
\Emph{
\begin{equation}\label{Exsection}
  \xElas
  =  {\left|\bra\psi_\si|\delta v|\psi_\sf\ket\right|}^2.
\end{equation}\vspace*{-5pt}
}
As we shall see below,
it holds not only for plane waves governed
by the Helmholtz equation,
but also for distorted waves.
\index{Distorted-wave Born approximation!elastic cross section}%
In the plane-wave case \cref{Echiq} considered here,
the differential cross section is just the squared modulus
of the Fourier transform of the SLD,
\index{Scattering!length density!Fourier transform}%
\begin{equation}\label{Ecross1}
  \xElas
  = {\left| v(\q) \right|}^2.
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Distorted-wave Born approximation (DWBA)}\label{SDWBA}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{Distorted-wave Born approximation|(}%
\index{DWBA|see {Distorted-wave Born approximation}}%

%===============================================================================
\subsection{Introduction}\label{SDWBA1}
%===============================================================================

The standard Born approximation depends on the choice $\mv=\text{const}$,
which implies that $\psi_\si$ and $\psi_\sf$ are plane waves.
In the distorted-wave Born approximation (DWBA),\footnote{
The DWBA was originally devised by Massey and Mott (ca 1933)
for collisions of charged particles.
Summaries can be found in some quantum mechanics textbooks (Messiah, Schiff)
and in monographs on scattering theory (e.~g.\ Newton).
The first explicit applications to grazing-incidence scattering
were published in 1982:
Vineyard \cite{Vin82} discussed X-ray scattering,
but failed to account for the distortion of the scattered wave;
Mazur and Mills \cite{MaMi82} deployed heavy formalism
to compute the inelastic neutron scattering cross section
of ferromagnetic surface spin waves from scratch.
A concise derivation of the DWBA cross section
was provided by Dietrich and Wagner (1984/85)
for X-rays \cite{DiWa84} and neutrons \cite{DiWa85}.
Unfortunately, their work was overlooked in much of the later literature,
which often fell back to less convincing derivations.}
this requirement is dropped.
The SLD decomposition~\cref{Edecompose_v}
is restored to full genericity,
and it is taken for granted
that somehow analytical or numerical solutions $\psi_\si$ and~$\psi_\sf$
of the homogeneous wave equation~\cref{EHomoK}
have been obtained.

Because these solutions are no longer plane waves,
we need to work out a terminological and notational distinction
that is blurred in the standard Born approximation:
we need to distinguish
 between the \E{exciting} wave~$\psi_\se$
\nomenclature[1ψ034 2e000]{$\psi_\se(\r)$}{Exciting wave}%
and the \E{incident} wave~$\psi_\si$.
The \E{exciting wave}
\index{Exciting wave}%
\index{Wave!exciting}%
is prepared far
outside the sample by a radiation source and some optical devices.
\index{Radiation source}%
It is a superposition of plane waves,
as discussed later in the context of instrumental resolution effects
(\cref{SInstr}).
Here, while discussing scattering theory,
it shall be represented by a single plane wave
$\psi_\se(\r)=\e^{i\k_\se\r}$.
This function is defined for all~$\r$,
but is physical only along the primary beam, upstream of the sample.

In contrast, by the \E{incident wave}~$\psi_\si(\r)$
\index{Incident wave!DWBA}%
\index{Incident wave!vs exciting wave}%
\index{Wave!incident}%
we understand an exact solution of~\cref{EHomoK}.
Upstream of the sample, along the primary beam, it coincides with the exciting wave.
Inside the sample, however, it undergoes refraction and reflection,
and therefore no longer is a plane wave, and no longer equals~$\psi_\se(\r)$.
This is different from the conventional Born approximation,
where $\psi_\si$ is a plane wave throughout the sample,
and therefore must not be distinguished from~$\psi_\se$.

Differently from the above derivation of the Born expansion,
we will not even attempt to obtain a full solution
\index{Green function!DWBA}%
of the Green function equation~\cref{EGreenK}.
We will use indirect arguments to directly obtain its far-field asymptote $G_\infty$.

%===============================================================================
\subsection{Far-field Green function}\label{SfarDW}
%===============================================================================


The following derivation of the far-field Green function~$G_\infty$
\index{Green function!distorted waves, far-field|(}%
is based Dietrich and Wagner \cite{DiWa84,DiWa16},
transcribed from electromagnetic to neutron waves,
and written out without algebraic operator formalism.
With the differential operators
\begin{align}
    \Do(\r) &\coloneqq \Nabla^2+K^2, \label{EDDefVac} \\[1.2ex]
    D(\r) &\coloneqq \Nabla^2+k(\r)^2 = \Do + \Lambda(\r), \label{EDDefFul}
\end{align}
\nomenclature[2d130 2r040]{$D(\r)$}{Differential operator in the full wave equation}%
and with $\Lambda(\r)\coloneqq k(\r)^2-K^2=-4\pi\mv(\r)$,
\nomenclature[1λ130 2r040]{$\Lambda(\r)$}{Proportional
   to the scattering length distribution: $\Lambda(\r)=-4\pi\mv(\r)$}%
we rewrite the homogeneous and inhomogeneous differential equations \cref{EHomoK}
and~\cref{EGreenK} for plane waves and distorted waves as
\begin{align}\label{EHIDG}
    \Do(\r)\pfo  (\r) = 0, &\quad \Do(\r)\Go(\r,\r') = \delta(\r-\r'), \\[1.2ex]
    D(\r)\psi_\sf(\r) = 0, &\quad D(\r)  G  (\r,\r') = \delta(\r-\r').
\end{align}
To derive a relation between the backwards propagating waves $\pfoc$ and $\psi^*_\sf$ we start from%
\begin{equation}
  0 = D(\r)\psi^*_\sf(\r) - \Do(\r)\pfoc(\r).
\end{equation}
We multiply with a Green function and integrate:
\begin{equation}
  0 = \int\!\d^3r\,\Go(\r,\rS)
         \left\{\Do(\r)\psi^*_\sf(\r) + \Lambda(\r)\psi^*_\sf(\r)- \Do(\r)\pfoc(\r)\right\}
\end{equation}
To let $D$ and $\Do$ operate to the left
we use partial integration.
%\footnote{In the literature \cite{DiWa84},
%instead of this explicit partial integration, the reciprocity theorem is invoked,
%which, however, involves partial integration in its proof.}
The surface integrals cancel because the flux through a surface that fully encloses the sample
is the same for $\pfoc$ and~$\psi^*_\sf$.
So we obtain
\begin{equation}\label{EPsiPfo1}
  \pfoc(\rS) = \psi^*_\sf(\rS) + \int\!\d^3r\;\Go(\r,\rS)\Lambda(\r)\psi^*_\sf(\r).
\end{equation}
In the same way, starting from
\begin{equation}
  0 = D(\r)G(\r,\rD) - \Do(\r)\Go(\r,\rD),
\end{equation}
we derive a relation between the vacuum and the full Green function:
\begin{equation}\label{EGGo1}
  \Go(\rS,\rD) = G(\rS,\rD) + \int\!\d^3r\;\Go(\r,\rS)\Lambda(\r)G(\r,\rD).
\end{equation}
We apply the reciprocity theorem~\cref{Erecip} and take the far-field limit in $\rD$:
\begin{equation}\label{EGoFF}
  \Go_\infty(\rD,\rS) = G_\infty(\rD,\rS) + \int\!\d^3r\, \Go(\r,\rS)\Lambda(\r) G_\infty(\rD,\r).
\end{equation}
We recall the far-field asymptote of the vacuum Green function from~\cref{EGreenFar}:
\begin{equation}
  \Go_\infty(\rD,\rS) = \phi(\rD)\pfoc(\rS)
\end{equation}
with the spherical wave.
\begin{equation}\label{Effphidef}
  \phi(r) \coloneqq \frac{\e^{iKr}}{4\pi r}.
\end{equation}
We multiply both sides of~\cref{EPsiPfo1} with $\phi(\rD)$,
compare with~\cref{EGoFF},
and read off the far-field asymptote of the distorted-waves Green function:
\begin{equation}\label{EGiDWBA}
  G_\infty(\rD,\rS) = \phi(\rD)\psi^*_\sf(\rS).
\end{equation}
This is formally identical with with \cref{EGreenFar},
but no longer requires $\psi_\sf$ to be a plane wave.
\index{Green function!distorted waves, far-field|)}%

\Emph{Accordingly,
the differential cross section is still given by \cref{Exsection},
and the scattering matrix element by~\cref{Etrama}.}
\index{Scattering!matrix}%
\index{Cross section!distorted-wave Born approximation}%
\index{Scattering!cross section}%
The plane-wave form~\cref{Echiq}, however, does no longer hold.
Its replacement depends on the distorted wavefunctions
$\psi_\si$ and $\psi_\sf$,
is therefore application specific,
and will be worked out later (\cref{Swave21}).

\index{Distorted-wave Born approximation|)}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{X-ray scattering}\label{SXray}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{X-ray!scattering theory|(}%


%===============================================================================
\subsection{DWBA scattering cross section}\label{SXscasol}
%===============================================================================

\def\Ei{\v{E}_\si}
\def\Eic{\Ei^*}
\def\Ef{\v{E}_\sf}
\def\Efc{\Ef^*}
\def\Eo{\TENS{\overset{o}{\v{E}}}}
\def\Efo{\Eo_\sf}
\def\Efoc{\Eo\vphantom{E}^*_\sf}
%\def\EA{{\v{\cal E}}}
\def\he{\v{\hat e}}
\def\hef{\he_\sf}
\def\hei{\he_\si}
\def\sif{\text{i,f}}

To solve~\cref{EwaveE3}, we proceed along the lines of~\Cref{SfarDW},
based on Dietrich and Wagner~\cite{DiWa84}.
In place of \cref{EDDefVac,EDDefFul}, we will need the tensorial operators
\begin{align}
    \TDo(\r) &\coloneqq \Nabla^2+K^2-\Nabla\cdot\Nabla, \\[1.2ex]
    \TD(\r)  &\coloneqq \TDo(\r) + \Lambda(\r),
\end{align}
with $\Lambda\coloneqq k^2-K^2$ as before.
To describe wave propagation without scattering,
we let $\delta v(\r)=0$,
so that~\cref{EwaveE3} becomes a homogeneous wave equation:
\begin{align}
    \TDo\Eo_\sif  (\r) = 0 &\text{\strut~~in vacuum,} \label{EDGEVac}\\[1.2ex]
    \TD\v{E}_\sif(\r) = 0 &\text{\strut~~everywhere}. \label{EDGEFul}
\end{align}
The incident radiation, as prepared ahead of the sample, is a solution of~\cref{EDGEVac},
and will be assumed to have the form of a polarized plane wave,
\begin{equation}\label{EEoi}
   \Eo_\si(r) = \v{e}_\si\, \e^{i\k_\si\r}.
\end{equation}
Per the divergence theorem,
the polarization vector~$\v{e}_\si$ must be perpendicular to the wavevector~$k_\si$.
The actual incident radiation field~$\Ei(\r)$ inside the sample
must be obtained by solving~\cref{EDGEFul}
under the boundary condition that it must match~\cref{EEoi}
in the vacuum upstream of the sample.

Ultimately, the scatttered radiation will be put in relation to
a polarized plane wave
\begin{equation}\label{EEof}
   \Eo_\sf(r) = \v{e}_\sf\, \e^{i\k_\sf\r}.
\end{equation}
In the logic of~\Cref{SfarDW},
we need to track back this wave into the scattering medium.
It is designated~$\Ef(\r)$, and obtained by solving~\cref{EDGEFul} under
the boundary condition that it must match~\cref{EEof}
in the vacuum downstream of the sample.

To determine the far-field solution of the inhomogeneous wave equation~\cref{EwaveE3},
we will use tensorial Green functions that fulfill
\index{Green function!distorted waves, far-field|(}%
\begin{align}
    \TDo\TGo(\r,\r') &= \ONE\delta(\r-\r'), \\[1.2ex]
    \TD  \TG  (\r,\r') &= \ONE\delta(\r-\r').
\end{align}
In analogy with \cref{EGoFF,EPsiPfo1},
vacuum and generic solutions are related to each other through
\begin{equation}\label{EXGoFF}
  \TGo_\infty(\rD,\rS)
  = \TG_\infty(\rD,\rS) + \int\!\d^3r\, \TG_\infty(\rD,\r)\Lambda(\r) \TGo(\r,\rS)
\end{equation}
and
\begin{equation}\label{EXpfo}
  \Efoc(\rS) = \Efc(\rS) + \int\!\d^3r\, \Efc(\r)\Lambda(\r) \TGo(\r,\rS).
\end{equation}
For a quick plausibility check, operate on both sides of either equation with~$\TDo$.
The vacuum Green function is
\begin{equation}\label{EXGoIE}
  \TGo(\rD,\rS) = \left( \ONE - K^{-2}\Nabla\cdot\Nabla \right) \Go(\rD,\rS),
\end{equation}
where $\Go$ is the scalar vacuum Green function that satisfies~\cref{EHIDG}.
We will only need the far-field limit
\begin{equation}\label{EXGoff}
  \TGo_\infty(\rD,\rS)
   = \left( \ONE - \v{\hat k}_\sf\cdot\v{\hat k}_\sf \right) \phi(r_\text{D})\e^{-i\k_\sf\rS}
\end{equation}
with the spherical wave~$\phi$ from~\cref{Effphidef}.
We multiply both sides of~\cref{EXGoFF} from the left with the polarization vector~$\v{e}_\sf$,
and both sides of~\cref{EXpfo} with~$\phi(\rD)$ to obtain
\begin{equation}\label{EXGoFF2}
  \v{e}_\sf\phi(\rD)\e^{-i\k_\sf\rS}
  = \v{e}_\sf\TG_\infty(\rD,\rS) + \int\!\d^3r\, \hef\TG_\infty(\rD,\r)\Lambda(\r) \TGo(\r,\rS)
\end{equation}
and
\begin{equation}\label{EXpfo2}
  \v{e}_\sf\phi(\rD)\e^{-i\k_\sf\rS}
  = \phi(\rD)\Efc(\rS) + \int\!\d^3r\, \phi(\rD)\Efc(\r)\Lambda(\r) \TGo(\r,\rS).
\end{equation}
Comparing both equations, we read off
\begin{equation}\label{EGpE}
  \v{e}_\sf\TG_\infty(\rD,\rS) = \phi(\rD)\Efc(\rS).
\end{equation}
This is analogous to~\cref{EGiDWBA},
and confirms that we can determine the scattered far field at the detector position~$\rD$
\index{Scattered radiation!backtracking}%
by backtracking the detected plane wave $\Efc$ into the sample.
In analogy to~\cref{EBornS}, the scattered electrical field is
\index{Scattered radiation!electromagnetic}%
\index{Scattered radiation!X-ray}%
\begin{equation}\label{EBornX}
  \v{E}_{\text{s}}(\r)
  = 4\pi\int\!\d^3r'\, \TG(\r,\r')\delta v(\r')\v{E}_\si(\r').
\end{equation}
The far-field component in polarization direction~$\hef$ is
\begin{equation}
  \hef\v{E}_{\text{s}\infty}(\r)
  = {|\v{e}_\sf|}^{-1}\phi(r) \int\!\d^3r'\, \Efc(\r')\delta v(\r')\v{E}_\si(\r').
\end{equation}
The differential cross section
is defined as in \cref{Exsectiondef},
namely as the ratio of scattered flux through the unit sphere to incident flux.
\index{Born approximation!elastic scattering cross section}%
\index{Cross section!Born approximation}%
\index{Scattering!cross section}%
For electromagnetic waves in vacuum, the flux is proportional to~$|\v{E}|^2$.
So the X-ray scattering cross section for given incoming and detected polarization is
\begin{equation}\label{ExsectionXlong}
  \xElas
  =  \frac{ {\left|\bra\Ei|\delta v|\Ef\ket\right|}^2 }{|\v{e}_\si|^2\,|\v{e}_\sf|^2}
\end{equation}
with the scattering matrix element
\index{Scattering!matrix}%
\Emph{
\begin{equation}\label{EtramaE}
  \bra \Ei|\delta v|\Ef\ket
  \coloneqq  \int\!\d^3r\, \Eic(\r)\delta v(\r)\Ef(\r).
\end{equation}\vspace*{-5pt}}
For lighter notation,
it is convenient to choose the vacuum plane waves \cref{EEoi,EEof} from the onset
with normalized polarization vectors,
\begin{equation}\label{EbcE}
  \Eo_\si(r) = \hei\, \e^{i\k_\si\r}, \text{~and~}
  \Eo_\sf(r) = \hef\, \e^{i\k_\sf\r},
\end{equation}
so that~\cref{ExsectionXlong}
takes the simple form
\begin{equation}\label{ExsectionX}
  \xElas
  =  {\left|\bra\Ei|\delta v|\Ef\ket\right|}^2
\end{equation}
in full analogy with~\cref{Exsection}.
Typically, scattered radiation is detected without polarization analysis.
\index{Polarization!analysis}%
\index{Scattered radiation!detection}%
\index{Scattered radiation!polarization}%
\index{Detector!polarization}%
Then the measured cross section is an incoherent sum
\index{Incoherent sum!polarization}%
\index{Polarization!incoherent sum}%
\index{Born approximation!elastic scattering cross section}%
\index{Cross section!Born approximation}%
\index{Scattering!cross section}%
\Emph{
\begin{equation}\label{ExsectionXsum}
  \xElas
  =  \sum_{\hef} {\left|\bra\Ei|\delta v|\Ef\ket\right|}^2.
\end{equation}\vspace*{-5pt}}
In this equation,
the dependence of $\Ef$ on $\hef$ is implicit,
mediated through the boundary condition
that $\Ef(\r)$ must match $\Eo_\sf(\r)$ at the detector.
If the incident radiation is not fully polarized,
\index{Polarization!incident}%
an additional summation is performed over~$\hei$,
weighted with relative intensities.

\index{X-ray!scattering theory|)}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Coherent vs incoherent scattering}\label{Scoherlen}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%===============================================================================
\subsection{Coherence length}
%===============================================================================

Per \cref{Exsection} and~\cref{Etrama},
\index{Coherence length|(}%
the matrix element $\bra \psi_\si|\delta v|\psi_\sf\ket$
is given by a three-dimensional integral
\begin{equation}\label{Etrama3}
  \bra \psi_\si|\delta v|\psi_\sf\ket
  \coloneqq  \int\!\d^3r\, \psi^{*}_\si(\r)\delta v(\r)\psi_\sf(\r).
\end{equation}
The integration domain is effectively limited to a finite $z$ interval,
where $\delta v(\r)$ is nonzero.
The horizontal integration domain, however, is infinite
within our formalism,
which is of course an idealization.
Obviously, physical integration limits are imposed by the finite
\index{Sample area}%
\E{illuminated sample area}.\footnote
{We assume a well aligned instrument,
for which the beam footprint and the backtracked detector footprint
\index{Illumination!beam footprint on sample}%
\index{Beam footprint}%
\index{Backtracking!beam footprint}%
agree within reasonable accuracy.}
Another limitation comes from the finite \E{coherence length}
of the instrumental setup,
which usually is much shorter than the sample width and length
%This is of importance in neutron scattering
%where typical sample dimensions of 1\ldots10~mm
%are much larger than the relevant coherence length,
%which is of the order 10\ldots100~$\upmu$m
\cite{HaPR10,MaMM14}.\footnote
{These two references also make clear that
  the theoretical description and the experimental determination of
  coherence lengths are difficult problems and subject of ongoing research.}

While each single neutron is described by a wavefunction
that allows for \E{coherent} superposition of
different contributions to the scattered wavefunction,
the final detector statistics
\index{Detector!statistics}%
is given by an \E{incoherent} sum
over the differential cross sections of individual neutrons.
The finite \E{resolution}
\index{Resolution|(}%
of an experimental setup is in part due to the fact that
different neutrons have different wavenumbers,
originate\footnote
{It is reasonable to take the last collision in the moderator
  as the \E{origin} of a neutron ray,
  since collisions between neutrons and hydrogen nuclei bound in
  disordered matter lead to almost perfect decoherence.}
at different points in the moderator,
and are detected at slightly different points within one detector pixel.
This can be modeled by computing expected scattering intensities as
averages over different neutrons with
$K$, $\v{\hat k}_\si$, and $\v{\hat k}_\sf$ drawn at random
from appropriate distributions.
% TODO RESTORE TEMPORARILY REMOVED XREF as described in \cref{Sresolution}.

However, this is not the full story.
In the above introduction to the Born approximation
we have made the standard assumption
that an incoming neutron can be described by a plane wave
$\psi_\si=\e^{i\k_\si\r}$.
The wavefunction $\psi_\sf$ traced back from the detector is also
approximated by a plane wave.
In the DWBA we allow these waves to be distorted within the sample,
but when impinging on the sample they still are plane.
A plane wave obviously is an idealized concept,
since it has infinite lateral extension.
The \E{transverse coherence length} indicates the scale
beyond which this approximation becomes invalid.
At larger scales, the wave fronts appear randomly distorted.
Physical causes of these distortions include
reflections in the neutron guide,
diffraction by guide windows and other slits,
and diffraction by imperfect monochromator crystals.
Of course the distorted wave still admits a Fourier decomposition
into plane waves with slightly different wavevectors.
In practice, it is impossible to distinguish this spread of wavevectors
from the incoherent spread described in the previous paragraph.
The instrumental resolution function therefore
accounts for both causes of wavevector distortion.
\index{Resolution|)}%

Usually, therefore, a GISANS image is an incoherent average
over coherent diffraction patterns collected from
many small subareas of the sample.
Only horizontal sample structures on scales smaller the coherence length
yield interference patterns.
Structure fluctuations on larger scales
produce said incoherent average of different GISANS images.

The crossover from coherent to incoherent scattering is of course
a gradual one.
The coherence length indicates where a certain, somewhat arbitrary degree
of decoherence is reached.
Under these reservations
one defines a \E{coherence spot}
in the cross section of an approximately plane wave
as an area where the coherence is above a certain threshold.
Unless the wave has been prepared in a highly anisotropic guide and slit system,
this spot is about circular.
Under grazing incidence conditions however,
the projection of this spot onto the sample surface
yields a very elongated ellipse.
Therefore, the coherence length is much larger in $x$ than
in $y$ or $z$ direction.\footnote
{This has nothing to do with the distinction of
  \E{transverse} and \E{longitudinal} coherence length.
  Longitudinal coherence has to do with wavelength stability
  and is of no importance for elastic scattering.
  We are talking here about \E{horizontal} and \E{vertical}
  projections of the \E{transverse} coherence length.}

%===============================================================================
\subsection{Implementation}
%===============================================================================


\Note{\indent Unless otherwise said, \BornAgain\ simulates
  \E{coherent} diffraction patterns obtained by
  the linear superposition of scattered waves.
  To simulate an \E{incoherent} mixture of diffraction patterns,
  the most generic solution is a script with an outer loop
  that averages over several coherent computations with
  appropriately distributed parameters.}

\Warn{\indent Currently, \BornAgain\ does not support interferences
  between particles in different layers.}
% TODO: more about implementation !

\index{Coherence length|)}%




\section{OLD STUFF}

we define the dielectric scattering potential
\index{Potential!dielectric scattering}%
\index{Dielectric scattering potential}%
\begin{equation}
  4\pi v(\r)\coloneqq-K^2(\epsilon(\r)-1).
\end{equation}


To solve this equation by a perturbation expansion,
\index{Perturbation expansion}%
we proceed as in \cref{Sfluct},
and decompose the dielectric permittivity
into a two components:
\begin{equation}
  \eps(\r) = \overline{\eps}(\r) + \delta\eps(\r).
\end{equation}
\nomenclature[1ε031 2r040]{$\overline\eps(\r)$}{Part of the permittivity~$\eps(\r)$ that can be analytically handled}%
\nomenclature[1δ030
  1ε030 2r040]{$\delta\eps(\r)$}{Part of the permittivity~$\eps(\r)$ that causes scattering}%
We define the material-dependent wavenumber by
\index{Wavenumber!material dependent}%
\begin{equation}
  k(\r)^2 \coloneqq K^2 \overline{\eps}(\r).
\end{equation}
The scattering potential
\index{Scattering!potential!X-ray}%
\begin{equation}
  4\pi\delta v(\r) \coloneqq - K^2\delta\eps
\end{equation}
takes the place of the neutron scattering length distribution.
The wave equation~\cref{ENabNabE} then becomes
\begin{equation}\label{EwaveE3}
  \left\{\Nabla^2-\Nabla\cdot\Nabla + k(\r)^2\right\}\v{E}(\r)
  = 4\pi\delta v(\r)\v{E}(\r).
\end{equation}
\index{Wave equation!X-ray}%
\index{X-ray!wave equation}%
This is very similar to the perturbed Schrödinger equation~\cref{ESchrodiK}.
\index{Perturbed Schrödinger equation}%
\index{Schrodinger@Schrödinger equation!perturbed}%
There are only two differences:
the appearance of the dyadic differential operator $\Nabla\cdot\Nabla$,
and the fact that $\v{E}(\r)$ is vector valued,
whereas unpolarized neutrons are described by a scalar wavefunction~$\psi(\r)$.

and the reduced tensor potential
\index{Potential!tensor}%
\index{Tensor potential}%
\begin{equation}
  4\pi\TENS{w}(\r)\coloneqq4\pi v(\r) + \v{h}(\r)\v{\sigma},
\end{equation}
\nomenclature[2w050 2r040]{$\TENS{w}(\r)$}{Tensorial potential}%,

The SLD fluctuations can typically written as a sum over different materials~$p$,
\begin{equation}
  \delta v(\r) = \sum_p (v_p-\mv(\r)) \chi_p(\r),
\end{equation}
where $v_p$ is the SLD of the bulk material~$p$,
and $\chi_p$ is dimensionless function that takes values between 0 and~1.
Internally, BornAgain computes $v_p$ from the material's refractive index,
\begin{equation}
  v_p = \frac{K^2}{4\pi}(1-n_p).
\end{equation}

Absolute values of~$U(\r)$ are always much smaller than~1.
This enables us to solve \cref{EDPsi} by a first-order perturbation theory,
\index{Perturbation expansion}%
the \E{distorted-wave Born approximation} (DWBA).
\index{Distorted-wave Born approximation}%
The DWBA generalizes the standard \E{Born approximation},
\index{Born approximation}%
which corresponds to the special case~$\v\Lambda(\r)=0$.
