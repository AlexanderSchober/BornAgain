%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%   BornAgain User Manual
%%
%%   homepage:   http://www.bornagainproject.org
%%
%%   copyright:  Forschungszentrum Jülich GmbH 2015
%%
%%   license:    Creative Commons CC-BY-SA
%%
%%   authors:    Scientific Computing Group at MLZ Garching
%%               C. Durniak, M. Ganeva, G. Pospelov, W. Van Herck, J. Wuttke
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\part{Physics}\label{PPHYS}

\chapter{Scattering}  \label{SSca}
\chaptermark{Scattering}

\index{Small-angle scattering|(}%

This chapter introduces the basic theory of small-angle scattering (SAS).
We specifically consider scalar neutron propagation,
adjourning the notationally more involved
vectorial theory of X-rays and polarized neutrons
to a later chapter (%\Cref{SPol} --
yet to be written). % TODO UPDATE LINK
Our exposition is self-contained,
except for the initial passage from the microscopic
to the macroscopic Schrödinger equation,
which we outline only briefly (\Cref{Swave}).
The standard description of scattering in first-order Born approximation
(\Cref{SBornApprox})
is introduced in a way that facilitates the following generalization
into the distorted-wave Born approximation (DWBA)
needed for grazing-incidence scattering (\Cref{SDWBA}).
This chapter finishes with a qualitative discussion
of coherence lengths (\Cref{Scoherlen}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Coherent neutron propagation}\label{Swave}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{Wave propagation!neutrons|(}%
\index{Neutrons!wave propagation|(}%

\def\Vmac{\tilde{V}}

\index{Schrodinger@Schrödinger equation!microscopic}%
The scalar wavefunction $\psi(\r,t)$
\nomenclature[2t020]{$t$}{Time}%
\nomenclature[2r040]{$\r$}{Position}%
\nomenclature[1ψ030 2r040 2t02]{$\psi(\r,t)$}{Microscopic neutron wavefunction}%
of a free neutron
is governed by the microscopic Schrödinger equation
\begin{equation}\label{ESchrodi}
  i\hbar\partial_t \psi(\r,t)
  = \left\{-\frac{\hbar^2}{2m}\Nabla^2+V(\r)\right\} \psi(\r,t).
\end{equation}
By assuming a time-independent potential $V(\r)$,
we have excluded inelastic scattering.
Therefore we only need to consider monochromatic waves
with given frequency~$\omega$.
\nomenclature[1ω 020]{$\omega$}{Frequency of incident radiation}%
In consequence, we have a stationary wavefunction
\begin{equation}\label{Estationarywave}
  \psi(\r,t) = \psi(\r)\e^{-i\omega t}.
\end{equation}
\nomenclature[1ψ030 2r040 0]{$\psi(\r)$}{Stationary wavefunction}%
The minus sign in the exponent of the phase factor
is an inevitable consequence of the standard form of the Schrödinger equation,
and is therefore called the \E{quantum-mechanical sign convention}.
\index{Wave propagation|seealso {Sign convention}}%
\index{Conventions|see {Sign convention}}%
\index{Sign convention!wave propagation|(}%
For electromagnetic radiation
usage is less uniform.
While most optics textbooks
have adopted the quantum-mechanical convention~\cref{Estationarywave},
in X-ray crystallography
the conjugate phase factor $\e^{+i\omega t}$ is prefered.
This \E{crystallographic sign convention} has also been chosen
in influential texts on GISAXS (e.g.\ \cite{ReLL09}).
Here, however, we are concerned not only with X-rays,
but also with neutrons,
and therefore we need to leave the Schrödinger equation~\cref{ESchrodi} intact.
Thence:

\Note
{\indent In this manual, and in the program code of BornAgain,
the quantum-mechanical sign convention~\cref{Estationarywave} is chosen.}
\index{Sign convention!wave propagation|)}%

Inserting \cref{Estationarywave} in \cref{ESchrodi},
we obtain the stationary Schrödinger equation
\begin{equation}\label{EstatSchrodi}
  \left\{-\frac{\hbar^2}{2m}\Nabla^2+V(\r)-\hbar\omega\right\} \psi(\r) = 0.
\end{equation}
\nomenclature[2m020]{$m$}{Neutron mass}%
\nomenclature[2v130 2r040]{$V(\r)$}{Microscopic optical potential}%
\index{Potential|see {Optical potential}}%
\index{Optical potential!nuclear (microscopic)}%
The \E{nuclear} (or \E{microscopic})
\E{optical potential} $V(\r)$,
in a somewhat ``naive conception'' \cite[p.~7]{Sea89},
consists of a sum of delta functions,
representing Fermi's ``pseudopotential''.
\index{Fermi's pseudopotential}%
The superposition of the incident wave with the scattered waves
originating from each illuminated nucleus
results in \E{coherent forward scattering},
\index{Coherent forward scattering}%
in line with Huygens' principle.
\index{Huygens' principle}%

Coherent superposition also leads to \E{Bragg scattering}.
\index{Bragg scattering!by atomic lattices}%
However, Bragg scattering by atomic lattices only occurs at angles
far above the small-angle range covered in GISAS experiments.
Accordingly, it can be neglected in the analysis of GISAS data,
or at most, is taken into account as a loss channel.

Therefore,
we can neglect the atomic structure of $V(\r)$,
and perform some coarse graining to
arrive at a \E{continuum approximation}.
\index{Continuum approximation!neutron propagation}%
This is
similar to the passage from
the microscopic to the macroscopic Maxwell equations.
The details are intricate \cite{Sea89,Lax51},
but the result \cite[eq.~2.8.32]{Sea89} looks very simple:
The macroscopic field equation
has still the form of a stationary Schrödinger equation,
\index{Schrodinger@Schrödinger equation!macroscopic}%
\begin{equation}\label{EmacrSchrodi}
  \left\{-\frac{\hbar^2}{2m}\Nabla^2+\Vmac(\r)-\hbar\omega\right\} \psi(\r) = 0,
\end{equation}
\nomenclature[1ψ030 2r040 2t020]{$\psi(\r,t)$}{Coherent wavefunction}%
\nomenclature[2v131 2r040]{$\Vmac(\r)$}{Macroscopic optical potential}%
where $\psi$ now stands for the \E{coherent wavefunction}
\index{Coherent wavefunction}%
\index{Wave propagation!coherent}%
obtained by superposition of
incident and forward scattered states,
and $\Vmac(\r)$ is the \E{macroscopic optical potential}.
\index{Optical potential!macroscopic}%
This potential is weak, and slowly varying compared to atomic length scales.
In the following it shall be expressed through the
\E{bound scattering length density} (SLD)
\index{Bound scattering length|see{Scattering length}}%
\index{Scattering length density}%
\index{SLD|see{Scattering length density}}%
\cite[eq.\ 2.8.37]{Sea89},
\nomenclature[2v020 2r040]{$v(\r)$}{Scattering length density (SLD)}%
\begin{equation}
  v(\r)\coloneqq\frac{m}{2\pi \hbar^2}\Vmac(\r),
\end{equation}
which shall be decomposed into a constant average and a fluctuating part,
\begin{equation}\label{Edecompose_v}
  v(\r) = \overline{v} + \delta v(\r).
\end{equation}
\nomenclature[1d030 2v230 2r040]{$\delta v(\r)$}{Fluctuating part of the scattering length density}%
\nomenclature[2v021]{$\overline{v}$}{Average scattering length density}%
The macroscopic Schrödinger equation~\cref{EmacrSchrodi} becomes
\begin{equation}\label{ESchrodi3}
  \left\{ \Nabla^2 + \frac{2m\omega}{\hbar} - 4\pi\overline{v} \right\}\psi(\r)
  = 4\pi\delta v(\r)\psi(\r).
\end{equation}
In a homogeneous medium with $\delta v=0$,
\cref{ESchrodi3} reduces to the Helmholtz wave equation.
\index{Helmholtz wave equation}%
\index{Wave propagation!Helmholtz equation}%
This motivates us to rewrite~\cref{ESchrodi3} as
\Emph{
\begin{equation}\label{ESchrodiK}
  \left\{ \Nabla^2 + K^2 \right\}\psi(\r)
  = 4\pi\delta v(\r)\psi(\r),
\end{equation}
\vspace*{-5pt}}
where the wavenumber~$K$ is given by the dispersion relation
\nomenclature[2k120]{$K$}{Wavenumber}%
\index{Dispersion!neutron in homogeneous medium}%
\index{Wavenumber!neutron}%
\begin{equation}\label{Edispersion}
  K^2 = \frac{2m\omega}{\hbar} - 4\pi\overline{v}
      = K_\text{vac}^2\left(1-\frac{4\pi}{K_\text{vac}^2}\overline{v}\right)
      = K_\text{vac}^2 n^2.
\end{equation}
To arrive at the final compact expression $K=K_\text{vac} n$
we introduced the vacuum wavenumber~$K_\text{vac}$
\nomenclature[2k124 200vac]{$K_\text{vac}$}{Wavenumber in vacuum}%
and the \E{refractive index}
\nomenclature[2n020]{$n$}{Refractive index}%
\index{Refractive index}%
\index{Index of refraction|see {Refractive index}}%
\begin{equation}\label{EnRefrIndx}
  n\coloneqq \sqrt{1-\frac{4\pi}{K_\text{vac}^2}\overline{v}}.
\end{equation}
\index{Absorption|(}%
The complex refractive index of a given material
shall be written as
\begin{equation}\label{Endb1}
  n =  1-\delta +i\beta,
\end{equation}
\nomenclature[1δ020]{$\delta$}{Small parameter in the refractive index
   $n=1-\delta +i\beta$}%
\nomenclature[1β020]{$\beta$}{Imaginary part of the refractive index}%
introducing two small real, nonnegative parameters $\delta, \beta$.
A nonzero~$\beta$ describes absorption and leads to a damping of propagating waves.\footnote
{The plus sign in front of~$i\beta$ is a consequence of
the quantum-mechanical sign convention;
in the X-ray crystallography convention it would be a minus sign.
\index{Refractive index!sign convention}%
\index{Sign convention!refractive index}}

The Schrödinger equation \cref{ESchrodiK}
is the starting point for the analysis of small-angle scattering (SAS) experiments
in Born approximation (\cref{SBornApprox}).
Later (\cref{Swave21}), for the special case of grazing incidence,
the distorted wave Born approximation (DWBA)
\index{Distorted-wave Born approximation}%
will start with a slight modification of the decomposition~\cref{Edecompose_v}:
vertical variations of the average SLD
will be reassigned from $\delta v(\r)$ to $n(z)$
in order to account for refraction and reflection in layered samples.
\index{SAS|see {Small-angle scattering}}%
\index{Small-angle scattering}%

\index{Wave propagation!neutrons|)}%
\index{Neutrons!wave propagation|)}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Neutron scattering in Born approximation}\label{SBornApprox}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%===============================================================================
\subsection{The Born expansion}\label{SBornExpans}
%===============================================================================

\index{Born approximation|(}%

To describe an elastic scattering experiment,
we need to solve the Schrödinger equation~\cref{ESchrodiK}
under the asymptotic boundary condition
\index{Boundary conditions!elastic scattering}%
\begin{equation}\label{Escabouco}
  \psi(\r)
  \simeq \psi_\ti(\r) + f(\vartheta,\varphi)\frac{\e^{iKr}}{4\pi r}
  \text{~for~}r\to\infty,
\end{equation}
\nomenclature[1ψ034 2i000 2r040]{$\psi_\ti(\r)$}{Incident wavefunction}%
\nomenclature[2i000]{i}{Subscript ``incident''}%
\index{Incident radiation!Born approximation}%
where $\psi_\ti(\r)$ is the incident wave
as prepared by the experimental apparatus,
and the second term on the right-hand side is
the outgoing scattered wave
that carries information in form of the angular distribution
$f(\vartheta,\varphi)$.

For thermal or cold neutrons, as for X-rays,
the refractive index~$n$ is almost always very close to~1,
fluctuations of the SLD are at most of the order of $1-n$,
and therefore the right-hand side of~\cref{ESchrodiK}
is but a weak perturbation.
This suggests a solution of the Schrödinger equation
by means of a perturbation expansion in powers of $\delta v$,
known as the \E{Born expansion} or \E{Born series}.\footnote{
Named after Max Born
who introduced it in quantum mechanics.
The idea goes back to Lord Rayleigh
who devised it for sound,
and later also applied it to electromagnetic waves,
which resulted in his famous explanation of the blue sky.}

Equation~\cref{ESchrodiK} looks
like an inhomogeneous differential equation ---
except that the right-hand side contains the unknown function~$\psi$.
In the Born expansion this problem is solved by iteration.
We start with the homogeneous equation
\begin{equation}\label{EHelmholtzHomog}
  \left(\Nabla^2+K^2\right)\psi(\r) = 0,
\end{equation}
which is solved by plane waves and superpositions thereof.
It applies in particular to the incident wave~$\psi_\ti$.
\index{Incident radiation!plane wave}%

For an isolated inhomogeneity,
\begin{equation}\label{EHelmholtzForGreen}
  \left(\Nabla^2+K^2\right)G(\r,\r') = \delta(\r-\r')
\end{equation}
\nomenclature[2g130 2r040 2r041]{$G(\r,\r')$}{Green function}%
\index{Green function!homogeneous material}%
is solved by the Green function\footnote
{Verification under the condition $\r\ne0$
is a straightforward exercise in vector analysis.
For the special case $\r=0$,
one encloses the origin in a small sphere
and integrates by means of the Gauss-Ostrogadsky divergence theorem.
This explains the appearance of the factor $4\pi$.}
\begin{equation}\label{EGreens1}
  G(\r,\r') = \frac{\e^{iK|\r-\r'|}}{4\pi |\r-\r'|},
\end{equation}
which is an outgoing spherical wave centered at $\r'$.
Convoluting this function with the given inhomogeneity $4\pi\delta v\psi$,
we obtain what is known as the Lippmann-Schwinger equation,
\index{Lippmann-Schwinger equation}%the formal solution
\begin{equation}\label{EPsiFormal}
  \psi(\r)
  = \psi_\ti(\r)
  + \int\!\d^3r'\, G(\r,\r') 4\pi\delta v(\r')\psi(\r').
\end{equation}
This integral equation for $\psi(\r)$ improves
upon the original stationary Schrödinger equation \cref{ESchrodiK}
in that it ensures the boundary condition~\cref{Escabouco}.
It can be resolved into an infinite series
by iteratively substituting the full right-hand side of~\cref{EPsiFormal}
into the integrand.
Successive terms in this series contain rising powers of $\delta v$.
Since $\delta v$ is assumed to be small, the series is likely to converge.
In \E{first-order Born approximation},
only the linear order in $\delta v$ is retained,
\begin{equation}\label{EBorn}
  \psi(\r)
  \doteq \psi_\ti(\r)
  + 4\pi \int\!\d^3r'\, G(\r,\r') \delta v(\r') \psi_\ti(\r').
\end{equation}
This is practically always adequate for
material investigations with X-rays or neutrons,
where the aim is to
deduce $\delta v(\r')$ from the scattered intensity ${|\psi(\r)|}^2$.
Since detectors are always placed at positions $\r$
that are not illuminated by the incident beam,
we are only interested in the scattered wave field
\begin{equation}\label{EBornS}
  \psi_\text{s}(\r)
  \coloneqq
  4\pi \int\!\d^3r'\, G(\r,\r') \delta v(\r') \psi_\ti(\r').
\end{equation}
\nomenclature[1ψ034 2s000 0 2r040]{$\psi_\text{s}(\r)$}{Scattered wavefunction}%
\nomenclature[2s000 0]{s}{Subscript ``scattered''}%

\index{Born approximation|)}%

%===============================================================================
\subsection{Far-field approximation}
%===============================================================================

\index{Far-field approximation|(}%

We can further simplify \cref{EBornS}
under the conditions of Fraunhofer diffraction:
\index{Fraunhofer approximation}%
the distance from the sample to the detector location~$\r$
must be much larger than the size of the sample.
Since the scattered wave $\psi_\text{s}(\r)$
only depends on $\r$ through the Green function~$G(\r,\r')$,
we shall derive a far-field approximation for the latter.

We choose the origin within the sample
so that the integral in~\cref{EBornS} runs over $\r'$ with $r'\ll r$.
This allows us to expand
\begin{equation}
  \left|\r-\r'\right|
  \doteq \sqrt{r^2-2\r\,\r'}
  \doteq r - \frac{\r\,\r'}{r}
  \equiv r - \frac{\k_\tf \r'}{K},
\end{equation}
\nomenclature[2f000]{f}{Subscript ``final'',
   for outgoing waves scattered into the direction of the detector}%
\nomenclature[2k040]{$\k$}{wavevector}%
where we have introduced the outgoing wavevector
\begin{equation}
  \k_\tf\coloneqq K\frac{\r}{r}.
\end{equation}
We apply this to~\cref{EGreens1},
\index{Green function!homogeneous material}%
and obtain in leading order the far-field Green function
\begin{equation}\label{EGreenFar}
  G_\text{far}(\r,\r')
  = \frac{\e^{iKr}}{4\pi r}\psi^*_\tf(\r')
\end{equation}
\nomenclature[2g134 2far]{$G_\text{far}(\r,\r')$}{Far-field
   approximation to the Green function $G(\r,\r')$}%
where
\begin{equation}\label{EPsisfar}
  \psi_\tf(\r) \coloneqq  \e^{i\k_\tf \r}
\end{equation}
\nomenclature[1ψ034 2f000 2r040]{$\psi_\tf(\r)$}{Plane
  wave propagating from the sample towards the detector}%
is a plane wave propagating towards the detector,
and $\psi^*$ designates the complex conjugate of $\psi$.
With respect to $\r$, $G_\text{far}$ is an outgoing spherical wave.
Inserting \cref{EGreenFar} and~\cref{EPsisfar} in \cref{EBornS},
we obtain the far-field approximation for the scattered wave,
\begin{equation}\label{EsandwichC}
  \psi_\text{s,far}(\r)
  = \frac{\e^{iKr}}{r}
    \bra \psi_\tf|\delta v|\psi_\ti\ket,
\end{equation}
\nomenclature[1ψ034 2s000 2far]{$\psi_\text{s,far}(\r)$}{Far-field
   approximation to the scattered wavefunction $\psi_\text{s}(\r)$}%
where we used Dirac notation for the transition matrix element
\index{Transition matrix}%
\Emph{%
\begin{equation}\label{Etrama}
  \bra \psi_\tf|\delta v|\psi_\ti\ket
  \coloneqq  \int\!\d^3r\, \psi^*_\tf(\r)\delta v(\r)\psi_\ti(\r).
\end{equation}
\vspace*{-5pt}}
\nomenclature[0$\langle$0]{{$\bra\ldots\vert\ldots\vert\ldots\ket$}}{Matrix
  element, defined as a volume integral}%
In order to reconcile conflicting sign conventions,
\index{Sign convention!transition matrix|(}%
we will in the following rather use its complex conjugate
$\bra \psi_\ti|\delta v|\psi_\tf\ket = \bra \psi_\tf|\delta v|\psi_\ti\ket^*$.

Under the standard assumption
that the incident radiation is a plane wave
\index{Incident radiation!plane wave}%
\begin{equation}\label{EPsi0Plane}
  \psi_\ti(\r)=\e^{i \k_\ti \r}
\end{equation}
with $k_\ti=K$,
the matrix element takes the form
\begin{equation}\label{Echiq}
  \bra \psi_\ti|\delta v|\psi_\tf\ket
  = \int\!\d^3r\, {\rm e}^{-i\k_\ti\r}\delta v(\r){\rm e}^{i\k_\tf\r}
  = \int\!\d^3r\, {\rm e}^{i\q\r}\delta v(\r)
  \eqqcolon v(\q),
\end{equation}
\nomenclature[1χ030 2q040]{$v(\v{q})$}{Fourier
   transform of the perturbation potential $\delta v(\r)$}%
where we have introduced the \E{scattering vector}\footnote
{With this choice of sign,
\index{Sign convention!scattering vector}%
$\hbar\q$ is the momentum
\index{Momentum transfer|see {Scattering vector}}%
\E{gained} by the scattered neutron,
and \E{lost} by the sample.
In much of the literature the opposite convention is prefered,
since it emphasizes the sample physics over the scattering experiment.
However, when working with two-dimensional detectors
it is highly desirable to express pixel coordinates
\index{Coordinate system}
and scattering vector components
with respect to equally oriented coordinate axes,
which can only be achieved by the convention~\cref{Eq}.}
\index{Scattering vector}%
\begin{equation}\label{Eq}
  \q\coloneqq \k_\tf-\k_\ti
\end{equation}
\nomenclature[2q040]{$\q$}{Scattering vector}%
and the notation $v(\q)$ for
the Fourier transform of the perturbative potential,
\index{Optical potential!Fourier transform}%
which is what small-angle neutron scattering basically measures.

\index{Far-field approximation|)}%


%===============================================================================
\subsection{Differential cross section}\label{SdiffCross}
%===============================================================================

In connection with \cref{EBorn} we mentioned
that a scattering experiment measures intensities~${|\psi(\r)|}^2$.
We shall now restate this in a more rigorous way.
In the case of neutron scattering,
one actually measures a \E{probability flux}.
We define it in arbitrary relative units as
\begin{equation}\label{EdefJ}
  \v{J}(\r) \coloneqq  \psi^*\frac{\Nabla}{2i}\psi - \psi\frac{\Nabla}{2i}\psi^*.
\end{equation}
\nomenclature[2j150 2r040]{$\v{J}(\r)$}{Probability flux}%
\index{Flux!incident and scattered}%
The ratio of the scattered flux hitting an infinitesimal detector area
$r^2\d\Omega$ to the incident flux is expressed as a
\E{differential cross section}
\index{Cross section}%
\index{Incident radiation!flux|(}%
\begin{equation}\label{Exsectiondef}
  \frac{\d\sigma}{\d\Omega}
  \coloneqq  \frac{r^2 J(\r)}{J_\ti}.
\end{equation}
\nomenclature[1ω120]{$\Omega$}{Solid angle}%
\nomenclature[1σ020]{$\sigma$}{Scattering or absorption cross section}%
% TODO RESTORE XREF
% The geometric factors that are needed to
% convert $\d\sigma/\d\Omega$ into detector counts will be discussed
% below in \cref{SdetImg}.
For a plane wave~\cref{EPsi0Plane}, the incident flux is
\index{Incident radiation!flux|)}%
\index{Flux!Born approximation}%
\begin{equation}\label{EJi}
  \v{J}_\ti = \k_\ti.
\end{equation}
With the far-field result~\cref{EsandwichC}
and the notation~\cref{Etrama},
the scattered flux at the detector is
\begin{equation}\label{EJr}
  \v{J}(\r)
  = \v{\hat r}\frac{K}{r^2}
    {\left|\bra\psi_\ti|\delta v|\psi_\tf\ket\right|}^2.
\end{equation}
Inserting these into definition~\cref{Exsectiondef},
we obtain the generic differential cross section
of elastic scattering in first order Born approximation,
\index{Born approximation!elastic scattering cross section}%
\index{Cross section!elastic scattering in Born approximation}%
\index{Elastic scattering!cross section in Born approximation}%
\index{Scattering!elastic cross section in Born approximation}%
\Emph{
\begin{equation}\label{Exsection}
  \frac{\d\sigma}{\d\Omega}
  =  {\left|\bra\psi_\ti|\delta v|\psi_\tf\ket\right|}^2.
\end{equation}\vspace*{-5pt}
}
As we shall see below,
it holds not only for plane waves governed
by the vacuum Helmholtz equation~\cref{EHelmholtzHomog},
but also for distorted waves.
\index{Distorted-wave Born approximation!elastic cross section}%

In the plane-wave case \cref{Echiq} considered here,
the differential cross section is just the squared modulus
of the Fourier transform of the SLD,
\index{Scattering length density!Fourier transform}%
\begin{equation}\label{Ecross1}
  \frac{\d\sigma}{\d\Omega}
  = {\left| v(\q) \right|}^2.
\end{equation}

%===============================================================================
\section{Distorted-wave Born approximation (DWBA)}\label{SDWBA}
%===============================================================================

\index{Distorted-wave Born approximation|(}%
\index{DWBA|see {Distorted-wave Born approximation}}%

The standard form of the Born approximation,
as presented in \cref{SBornApprox},
combines an approximation scheme
(computing \cref{EPsiFormal} by iteration)
with an assumption (the incident field is a plane wave)
and an analytic result
(in far-field approximation,
the Green function of the Helmholtz equation is a plane wave
with respect to the locus of scattering).
These three elements must not necessarily go together.
In particularly, there is a fairly straightforward generalization
of the Born approximation for the case that
the incident field is not a plane wave,
called the \E{distorted-wave Born approximation} (DWBA).\footnote
{Originally devised by Massey and Mott (ca 1933)
for collisions of charged particles.
The first explicit application to grazing-incidence scattering
seems to be by Vineyard (1982) \cite{Vin82}.}
It is pertinent for grazing-incidence scattering
because refraction and reflection at interfaces
distort the incident radiation into
a superposition of downwards and upwards travelling waves,
as we shall discuss below in~\Cref{Swave21}.

The above derivation of the Born cross section becomes invalid
when there are systematic variations of the SLD
that preclude the decomposition~\cref{Edecompose_v}.
Let us instead write in full genericity
\begin{equation}\label{Edecompose_vr}
  v(\r) = \overline{v}(\r) + \delta v(\r).
\end{equation}
How to distinguish the systematic variations~$\overline{v}(\r)$
from the random fluctuations~$\delta v(\r)$
will depend on the application.
In any case, the macroscopic Schrödinger equation~\cref{ESchrodiK} takes the form
\begin{equation}\label{ESchrodiK}
  \left\{ \Nabla^2 + K^2(\r) \right\}\psi(\r)
  = 4\pi\delta v(\r)\psi(\r).
\end{equation}
We assume that the homogeneous wave equation that generalizes~\cref{EHelmholtzHomog}
can be solved for~$\psi(\r)$.
Outside the finite sample volume,
we still have $K=\text{const}$.
Therefore, we can impose on~$\psi(\r)$ the boundary condition that it be
a plane wave outside the sample.
We need two such wavefunctions:
A function~$\psi_\text{i}(\r)$ to match the incident radiation,
and a function~$\psi_\text{f}(\r)$ to match a plane wave that reaches a detector pixel.

In contrast, we will not even attempt to obtain a full solution
\index{Green function!DWBA}%
of the generalized Green function equation~\cref{EHelmholtzForGreen}.
We will only consider its asymptotic far-field limit $G(\rD,\r)$
at a detector position $\rD$.
Nonetheless, this function will be exact in the coordinate~$\r$
that designates where the scattering takes place.
\nomenclature[2r041 2d100]{$\rD$}{Position of the detector}%
The \E{source-detector reciprocity theorem}~\cref{Ereci}
\index{Reciprocity}%
proven in \cref{Sreci1}
yields
\begin{equation}\label{EreciDup}
  G(\rD,\r) = B(\r,\rD),
\end{equation}
\nomenclature[2b030 2r040 2r041]{$B(\r,\r')$}{Green function, adjoint of $G$}%
where~$B$ is the \E{adjoint Green function}
that describes backward propagation from $\rD$ into the sample.
Outside the sample,
$B$ obeys the Helmholtz equation
with isolated inhomogeneity \cref{EHelmholtzForGreen},
and therefore has the far-field expansion~\cref{EGreenFar},
\index{Far-field approximation}%
\begin{equation}\label{EBFar}
  B_\text{far}(\r,\rD)
  =\frac{\e^{iKr_\text{D}}}{4\pi r_\text{D}}\e^{-i\k_\tf \r}.
\end{equation}
As explained above,
we assume that there is a solution $\psi_\text{f}(\r)$ of the homogeneous
wave equation that matches $\e^{i\k_\tf \r}$ outside the sample.
Therefore,
\begin{equation}\label{EBFull}
  B_\text{far}(\r,\rD)
  = \frac{\e^{iKr_\text{D}}}{4\pi r_\text{D}}\psi^*_\tf(\r)
\end{equation}
is the far-field approximation (in $\rD$)
to the solution of the Green function equation that generalizes~\cref{EHelmholtzForGreen}.
It does not involve any approximation in~$\r$.
Reciprocity \cref{EreciDup} yields
\begin{equation}\label{EGreenFarDWBA}
  G_\text{far}(\r,\r')
  = \frac{\e^{iKr}}{4\pi r}\psi^*_\tf(\r')
\end{equation}
which is identical with with \cref{EGreenFar},
but no longer depends on $\psi_\tf$ being a plane wave.

\Emph{Accordingly,
the differential cross section is still given by \cref{Exsection},
and the transition matrix element by~\cref{Etrama}.}
The plane-wave form~\cref{Echiq}, however, does no longer hold;
its replacement depends on the distorted wavefunctions
$\psi_\text{i}$ and $\psi_\text{f}$,
is therefore application specific,
and will be worked out later (\cref{Swave21}).

\index{Distorted-wave Born approximation|)}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Coherence length}\label{Scoherlen}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Per \cref{Exsection} and~\cref{Etrama},
\index{Coherence length|(}%
the matrix element $\bra \psi_\ti|\delta v|\psi_\tf\ket$
is given by a three-dimensional integral
\begin{equation}\label{Etrama3}
  \bra \psi_\ti|\delta v|\psi_\tf\ket
  \coloneqq  \int\!\d^3r\, \psi^{*}_\ti(\r)\delta v(\r)\psi_\tf(\r).
\end{equation}
The integration domain is effectively limited to a finite $z$ interval,
where $\delta v(\r)$ is horizontally modulated.
On the other hand, the horizontal integration domain is infinite
within our formalism,
which is of course an idealization.
Obviously, physical integration limits are imposed by the finite
\index{Sample area}%
\E{illuminated sample area}.\footnote
{We assume a well aligned instrument,
for which the beam footprint and the backtracked detector footprint
\index{Illumination!beam footprint on sample}%
\index{Beam footprint}%
\index{Backtracking!beam footprint}%
agree within reasonable accuracy.}
Another limitation comes from the finite \E{coherence length}
of the instrumental setup,
which usually is much shorter than the sample width and length
%This is of importance in neutron scattering
%where typical sample dimensions of 1\ldots10~mm
%are much larger than the relevant coherence length,
%which is of the order 10\ldots100~$\upmu$m
\cite{HaPR10,MaMM14}.\footnote
{These two references also make clear that
  the theoretical description and the experimental determination of
  coherence lengths are difficult problems and subject of ongoing research.}

While each single neutron is described by a wavefunction
that allows for \E{coherent} superposition of
different contributions to the scattered wavefunction,
the final detector statistics
\index{Detector statistics}%
is given by an \E{incoherent} sum
over the differential cross sections of individual neutrons.
The finite \E{resolution}
\index{Resolution|(}%
of an experimental setup is in part due to the fact that
different neutrons have different wavenumbers,
originate\footnote
{It is reasonable to take the last collision in the moderator
  as the \E{origin} of a neutron ray,
  since collisions between neutrons and hydrogen nuclei bound in
  disordered matter lead to almost perfect decoherence.}
at different points in the moderator,
and are detected at slightly different points within one detector pixel.
This can be modeled by computing expected scattering intensities as
averages over different neutrons with
$K$, $\v{\hat k}_\ti$, and $\v{\hat k}_\tf$ drawn at random
from appropriate distributions.
% TODO RESTORE TEMPORARILY REMOVED XREF as described in \cref{Sresolution}.

However, this is not the full story.
In the above introduction to the Born approximation
we have made the standard assumption
that an incoming neutron can be described by a plane wave
$\psi_\ti=\e^{i\k_\ti\r}$.
The wavefunction $\psi_\tf$ traced back from the detector is also
approximated by a plane wave.
In the DWBA we allow these waves to be distorted within the sample,
but when impinging on the sample they still are plane.
A plane wave obviously is an idealized concept,
since it has infinite lateral extension.
The \E{transverse coherence length} indicates the scale
beyond which this approximation becomes invalid.
At larger scales, the wave fronts appear randomly distorted.
Physical causes of these distortions include
reflections in the neutron guide,
diffraction by guide windows and other slits,
and diffraction by imperfect monochromator crystals.
Of course the distorted wave still admits a Fourier decomposition
into plane waves with slightly different wavevectors.
In practice, it is impossible to distinguish this spread of wavevectors
from the incoherent spread described in the previous paragraph.
The instrumental resolution function therefore
accounts for both causes of wavevector distortion.
\index{Resolution|)}%

Usually, therefore, a GISANS image is an incoherent average
over coherent diffraction patterns collected from
many small subareas of the sample.
Only horizontal sample structures on scales smaller the coherence length
yield interference patterns.
Structure fluctuations on larger scales
produce said incoherent average of different GISANS images.

The crossover from coherent to incoherent scattering is of course
a gradual one.
The coherence length, however defined,
indicates where a certain, somewhat arbitrary degree
of decoherence is reached.
Under these reservations
one defines a \E{coherence spot}
in the cross section of an approximately plane wave
as an area where the coherence is above a certain threshold.
Unless the wave has been prepared in a highly anisotropic guide and slit system,
this spot is about circular.
Under grazing incidence conditions however,
the projection of this spot onto the sample surface
yields a very elongated ellipse.
Therefore, the coherence length is much larger in $x$ than
in $y$ or $z$ direction.\footnote
{This has nothing to do with the distinction of
  \E{transverse} and \E{longitudinal} coherence length.
  Longitudinal coherence has to do with wavelength stability
  and is of no importance for elastic scattering.
  We are talking here about \E{horizontal} and \E{vertical}
  projections of the \E{transverse} coherence length.}

\Note{\indent Unless otherwise said, \BornAgain\ simulates
  \E{coherent} diffraction patterns obtained by
  the linear superposition of scattered waves.
  To simulate an \E{incoherent} mixture of diffraction patterns,
  the most generic solution is a script with an outer loop
  that averages over several coherent computations with
  appropriately distributed parameters.}

% TODO: more about implementation !

\index{Coherence length|)}%
