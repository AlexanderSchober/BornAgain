############################################################################
# CMakeLists.txt file for building and running unit tests
############################################################################

include_directories(
    ${BornAgainCore_INCLUDE_DIRS}
    ${Boost_INCLUDE_DIRS}
    ${EIGEN3_INCLUDE_DIR}
    ${GSL_INCLUDE_DIR}
    )
if(BORNAGAIN_OPENMPI)
    include_directories(${MPI_INCLUDE_PATH})
endif()

function(UNIT_TEST_DIRECTORY TEST_NAME LINK_LIBS)
    enable_testing()

    include_directories(
        ${gtest_SOURCE_DIR}/include
        ${gtest_SOURCE_DIR}
        )

    file(GLOB INCLUDE_FILES RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} "*.h")
    list(REMOVE_ITEM INCLUDE_FILES IncludableTests.h)
    list(SORT INCLUDE_FILES)

    # set compiler flag that automatizes the #include of all INCLUDE_FILES in main.cpp
    set(TMP "/* Generated by CMake. Do not edit. */\n")
    foreach(FILE ${INCLUDE_FILES})
        set(TMP "${TMP}#include \"${FILE}\"\n")
    endforeach()
    file(WRITE IncludableTests.h ${TMP})

    set(EXE ${TEST_NAME})
    add_executable(${EXE} main.cpp ${include_files})

    target_link_libraries(${EXE} gtest ${LINK_LIBS})

    # to build executable right in lib directory to not to have problems with finding libBornAgainCore.dll under Windows
    set_property(TARGET ${EXE} PROPERTY RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

    add_test(${TEST_NAME} ${EXE})

    # add execution of TestCore just after compilation
    add_custom_command(TARGET ${TEST_NAME} POST_BUILD COMMAND ${TEST_EXE})

endfunction()

UNIT_TEST_DIRECTORY(TestCore ${BornAgainCore_LIBRARY})
